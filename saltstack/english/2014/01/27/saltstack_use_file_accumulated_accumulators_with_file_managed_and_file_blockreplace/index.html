<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> SaltStack, Use file.accumulated accumulators with file.managed and file.blockreplace |  RBleug</title>
    <meta name="description" content="Regilero's blog; Mostly tech things about web stuff."/>
    <meta name="author" content="regilero"/>
    <link rel="author" href="/contact/" title="who am I?" type="text/html" />
    <link rel="icon" type="image/x-icon" href="/theme/img/regilero.ico" />
    <link rel="shortcut icon" type="image/x-icon" href="/theme/img/regilero.ico" />
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/feed.xml" />
    <link rel="stylesheet" href="/theme/bootstrap/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/theme/bootstrap/css/bootstrap-theme.min.css" type="text/css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
<!--
    <link rel="stylesheet" href="/theme/blueprint/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="/theme/blueprint/print.css" type="text/css" media="print">
    <link rel="stylesheet" href="/theme/syntax.css" type="text/css" />
    <!--[if lt IE 8]>
      <link rel="stylesheet" href="/theme/blueprint/ie.css" type="text/css" media="screen, projection">
    <![endif]-->
<!--
    <link rel="stylesheet" href="/theme/blueprint/plugins/link-icons/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="/theme/fontello/css/fontello.css">
    <!--[if IE 7]><link rel="stylesheet" href="/theme/fontello/css/fontello-ie7.css"><![endif]-->
    <link href="/theme/syntax.css" rel="stylesheet" type="text/css" />
    <link href="/theme/style.css" rel="stylesheet" type="text/css" />

  </head>
  <body>
    <div class="topNav navbar navbar-inverse navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand visible-xs-inline" href="#">Navigation</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li ><a href="/" class="glyphicon glyphicon-home">&nbsp;Home</a></li>
            <li ><a href="/archives/" class="glyphicon glyphicon-th">&nbsp;Archives</a></li>
            <li ><a href="/contact/" class="glyphicon glyphicon-earphone">&nbsp;Contact</a></li>
            <li><a class="glyphicon glyphicon-eye-open" href="/feed.xml">&nbsp;RSS Feed</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

  <div class="container" role="main">
  
    <div class="jumbotron">
      <div class="container">
         <div id="branding">
           <h1 class="logo"><a href="/">RBleug</a></h1>
           <hr/>
           <h2 class="alt">Regilero's blog; Mostly tech things about web stuff.</h2>
         </div>
       </div>
     </div>

    <div class="row">
      <div class="col-md-8" id="left-content">

          <article>
        <header>
            <div class="page-header">
            <h1>SaltStack, Use file.accumulated accumulators with file.managed and file.blockreplace
            <br/><span><i class="glyphicon glyphicon-time">&nbsp;</i><time datetime="2014-01-27">Jan 27, 2014</time></span>
            <span class="category"><i class="glyphicon glyphicon-list">&nbsp;</i> <a href="/SaltStack/">SaltStack</a> and <a href="/english/">english</a></span>
            </h1>
            </div>
        </header>

        <div class="entry">
         <div class="col-md-6">
          <div class="post-excerpt-full">
          This is a detailled example of salt-stack's file.accumulated usage.
          </div>
          <div id="post-toc">
          </div>
         </div>
         <div class="col-md-6">
          <img class="topimg" src="/theme/img/pic/replaceblock2.jpg" alt="This is a detailled example of salt-stack's file.accumulated usage." title="This is a detailled example of salt-stack's file.accumulated usage." />
         </div>
         <div class="row">
          <div class="col-md-12" id="post-full">
       
          <p><a href="/saltstack/english/2014/01/20/saltstack_step_by_step_file_blockreplace/">On the last salt-stack post</a> we saw a first step by step usage of <a href="http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.blockreplace"><code>file.blockreplace</code></a>. On this post we'll study usage of state accumulators with <a href="http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.accumulated"><code>file.accumulated</code></a>. Accumulators are used to collect data on several states and let you use this data on other file states (Actually only the blockreplace and managed states).</p>

<p>You can find the examples used on this post on <a href="https://github.com/regilero/regilero-blog-examples/tree/master/accumulated-blockreplace">this github repository</a>.</p>

<h2>Why using accumulated accumulators?</h2>

<p>Let's start by the needs. What sort of problems could be solved by accumulators?. In fact, the idea is to use states executed before a final state. And this state ordering can be solved using requisites or orders. On theses first states you <strong>collect data</strong> for later usage. Then, on the final state, you have a dictionary containing this collected data, the <em>accumulator</em> dictionary, and you can do what you want with it with jinja, or even without jinja in the blockreplace case. Note that you only collect data in the current highstate execution, so all accumulators must run (be included) if you need the data at the end.</p>

<p>You can use this system to record one or more lists of things likes users, services, addresses, configuration commands or wathever else you want, while running the states. And all theses states recording data will have to run before the one using that data for something (writing theses lists on a targeted file). Doing that you will avoid doing the write operation after each new record, you will wait for the final list before doing the write. This will be faster, but also easier to manage. Inserting, updating and removing data in a file, in one shot.</p>

<p>In this post I will use two examples, one for a managed file and one for a blockreplace edited file. The first example is an apache configuration file with several states adding some inputs inside. The second example will fill a list of DNS IP-name associations that should be added in a hosts file.</p>

<h2>States ordering</h2>

<p>As I said before states ordering is very important here. The final step must be final. And used states may be split upon several sls files. You can use the order <code>order</code> keyword to ensure the final order, this way:</p>

<p><figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="lineno"> 1 </span>    <span class="c1"># first.sls</span>
<span class="lineno"> 2 </span>    <span class="l l-Scalar l-Scalar-Plain">STATEID1</span><span class="p p-Indicator">:</span>
<span class="lineno"> 3 </span>      <span class="l l-Scalar l-Scalar-Plain">cmd.run</span><span class="p p-Indicator">:</span>
<span class="lineno"> 4 </span>        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">echo STATEID1</span>
<span class="lineno"> 5 </span>        <span class="l l-Scalar l-Scalar-Plain">order</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="lineno"> 6 </span>  <br/>
<span class="lineno"> 7 </span>    <span class="c1"># second.sls</span>
<span class="lineno"> 8 </span>    <span class="l l-Scalar l-Scalar-Plain">STATEID2</span><span class="p p-Indicator">:</span>
<span class="lineno"> 9 </span>      <span class="l l-Scalar l-Scalar-Plain">cmd.run</span><span class="p p-Indicator">:</span>
<span class="lineno">10 </span>        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">echo last</span>
<span class="lineno">11 </span>        <span class="l l-Scalar l-Scalar-Plain">order</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">900</span>
<span class="lineno">12 </span>  <br/>
<span class="lineno">13 </span>    <span class="c1"># third sls</span>
<span class="lineno">14 </span>    <span class="l l-Scalar l-Scalar-Plain">STATEID3</span><span class="p p-Indicator">:</span>
<span class="lineno">15 </span>      <span class="l l-Scalar l-Scalar-Plain">cmd.run</span>
<span class="lineno">16 </span>        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">echo STATEID3</span>
<span class="lineno">17 </span>        <span class="l l-Scalar l-Scalar-Plain">order</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">200</span></code></pre></figure></p>

<p>This will make a final execution order of:</p>

<p><figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="lineno">1 </span>    <span class="l l-Scalar l-Scalar-Plain">echo STATEID1</span>
<span class="lineno">2 </span>    <span class="l l-Scalar l-Scalar-Plain">echo STATEID3</span>
<span class="lineno">3 </span>    <span class="l l-Scalar l-Scalar-Plain">echo last</span></code></pre></figure></p>

<p>But to do that you need an ordering schema for all you states. I do not find that very useful when you have a lot of states.</p>

<p>The second way of ordering states is using <a href="http://docs.saltstack.com/ref/states/requisites.html"><code>requisites</code></a>. Using this method you can declare dependencies between states. But having a list of all the states that collects data into accumulators, and eediting this list on the state using the accumulator would be quite hard. The best thing here is to use the <code>*_in</code> form of the requisites, to declare the dependency from the dependent state. When adding a new state using the accumulator the dependency will have to be set in this state and not in the previous managed state entry.</p>

<p>So using <code>require_in</code> the previous example would be:</p>

<p><figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="lineno"> 1 </span>    <span class="c1"># first.sls</span>
<span class="lineno"> 2 </span>    <span class="l l-Scalar l-Scalar-Plain">STATEID1</span><span class="p p-Indicator">:</span>
<span class="lineno"> 3 </span>      <span class="l l-Scalar l-Scalar-Plain">cmd.run</span><span class="p p-Indicator">:</span>
<span class="lineno"> 4 </span>        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">echo STATEID1</span>
<span class="lineno"> 5 </span>        <span class="l l-Scalar l-Scalar-Plain">require_in</span><span class="p p-Indicator">:</span>
<span class="lineno"> 6 </span>          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cmd</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">STATEID2</span>
<span class="lineno"> 7 </span>  <br/>
<span class="lineno"> 8 </span>    <span class="c1"># second.sls</span>
<span class="lineno"> 9 </span>    <span class="l l-Scalar l-Scalar-Plain">STATEID2</span><span class="p p-Indicator">:</span>
<span class="lineno">10 </span>      <span class="l l-Scalar l-Scalar-Plain">cmd.run</span><span class="p p-Indicator">:</span>
<span class="lineno">11 </span>        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">echo last</span>
<span class="lineno">12 </span>  <br/>
<span class="lineno">13 </span>    <span class="c1"># third sls</span>
<span class="lineno">14 </span>    <span class="l l-Scalar l-Scalar-Plain">STATEID3</span><span class="p p-Indicator">:</span>
<span class="lineno">15 </span>      <span class="l l-Scalar l-Scalar-Plain">cmd.run</span>
<span class="lineno">16 </span>        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">echo STATEID3</span>
<span class="lineno">17 </span>        <span class="l l-Scalar l-Scalar-Plain">require_in</span><span class="p p-Indicator">:</span>
<span class="lineno">18 </span>          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cmd</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">STATEID2</span></code></pre></figure></p>

<p><strong>Be careful:</strong> the syntax for a requisite is:</p>

<p><figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="lineno">1 </span>    <span class="l l-Scalar l-Scalar-Plain">&lt;requisite&gt;</span><span class="p p-Indicator">:</span>
<span class="lineno">2 </span>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">&lt;module&gt;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;state id&gt;</span></code></pre></figure></p>

<p>It is not:</p>

<p><figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="lineno">1 </span>    <span class="l l-Scalar l-Scalar-Plain">&lt;requisite&gt;</span><span class="p p-Indicator">:</span>
<span class="lineno">2 </span>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">&lt;module&gt;.&lt;function&gt;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;state id&gt;</span></code></pre></figure></p>

<p>So it is not <code>cmd.run:</code> here but only <code>cmd:</code>. And as soon as you start using requisites you see that using meaningfull states ids and not names shortcuts to declare states is quite important, for clarity at least.</p>

<h2>file.managed using file.accumulated</h2>

<p>All <a href="https://github.com/regilero/regilero-blog-examples/tree/master/accumulated-blockreplace">examples are available on github here</a>.</p>

<p>In this first example we'll use several states, the last state will install a <a href="http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.managed">managed file</a> in <code>/etc/apache2/sites-available/100-foo.example.com</code>, it's an apache virtualhost file, in the debian way. The jinja template associated with this file will contain the basic rules, but we want to allow some other states to add instructions on this virtualhost. We'll see theses states later. We start by the end, with this state building a virtualhost file in a <code>example_com_apache_virtualhost.sls</code> file:</p>

<p><figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="lineno"> 1 </span>    <span class="l l-Scalar l-Scalar-Plain">apache-install</span><span class="p p-Indicator">:</span>
<span class="lineno"> 2 </span>      <span class="l l-Scalar l-Scalar-Plain">pkg.installed</span><span class="p p-Indicator">:</span>
<span class="lineno"> 3 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pkgs</span><span class="p p-Indicator">:</span>
<span class="lineno"> 4 </span>          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">apache2</span>
<span class="lineno"> 5 </span>  <br/>
<span class="lineno"> 6 </span>    <span class="l l-Scalar l-Scalar-Plain">100_example_com_virtualhost</span><span class="p p-Indicator">:</span>
<span class="lineno"> 7 </span>      <span class="l l-Scalar l-Scalar-Plain">file.managed</span><span class="p p-Indicator">:</span>
<span class="lineno"> 8 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">source</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">salt://files/apache_vhost</span>
<span class="lineno"> 9 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/apache2/sites-available/100-example.com</span>
<span class="lineno">10 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="lineno">11 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="lineno">12 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span> <span class="s">&quot;0664&quot;</span>
<span class="lineno">13 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jinja</span>
<span class="lineno">14 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">defaults</span><span class="p p-Indicator">:</span>
<span class="lineno">15 </span>            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docroot</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/path/to/www</span>
<span class="lineno">16 </span>            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">servername</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">example.com</span>
<span class="lineno">17 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">require</span><span class="p p-Indicator">:</span>
<span class="lineno">18 </span>            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pkg</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">apache-install</span></code></pre></figure></p>

<p>This file should be put somewhere on your state tree, in this example I will make the function calls as if it were on the root of this tree (like the top.sls file). But there's also a <em>source</em> template for the managed file, which is called <code>salt://files/apache_vhost</code>, this file should be present under the salt master tree, in the directory <code>files</code> (or alter the used path). This is this very simple basic virtualhost example template content:</p>

<p><figure class="highlight"><pre><code class="language-apache" data-lang="apache"><span class="lineno"> 1 </span>    <span class="c"># Main Virtualhost for {{ servername }}</span>
<span class="lineno"> 2 </span>    <span class="nt">&lt;VirtualHost</span> <span class="s">*:80</span><span class="nt">&gt;</span>
<span class="lineno"> 3 </span>        <span class="nb">ServerAdmin</span> foo@example.com
<span class="lineno"> 4 </span>  <br/>
<span class="lineno"> 5 </span>        <span class="nb">DocumentRoot</span> {{ docroot }}
<span class="lineno"> 6 </span>  <br/>
<span class="lineno"> 7 </span>        <span class="nb">ServerName</span> {{ servername }}
<span class="lineno"> 8 </span>  <br/>
<span class="lineno"> 9 </span>        <span class="nb">LogLevel</span> <span class="k">info</span>
<span class="lineno">10 </span>  <br/>
<span class="lineno">11 </span>      <span class="nt">&lt;Directory</span> <span class="s">/</span><span class="nt">&gt;</span>
<span class="lineno">12 </span>        <span class="nb">AllowOverride</span> <span class="k">None</span>
<span class="lineno">13 </span>        <span class="nb">Order</span> allow, deny
<span class="lineno">14 </span>        <span class="nb">deny</span> from <span class="k">all</span>
<span class="lineno">15 </span>      <span class="nt">&lt;/Directory&gt;</span>
<span class="lineno">16 </span>  <br/>
<span class="lineno">17 </span>      <span class="nt">&lt;Directory</span> <span class="s">{{ docroot }}</span><span class="nt">&gt;</span>
<span class="lineno">18 </span>        <span class="nb">Options</span> FollowSymLinks
<span class="lineno">19 </span>        <span class="nb">AllowOverride</span> <span class="k">None</span>
<span class="lineno">20 </span>        <span class="nb">Order</span> allow,deny
<span class="lineno">21 </span>        <span class="nb">Allow</span> from <span class="k">all</span>
<span class="lineno">22 </span>      <span class="nt">&lt;/Directory&gt;</span>
<span class="lineno">23 </span>  <br/>
<span class="lineno">24 </span>    <span class="nt">&lt;/VirtualHost&gt;</span></code></pre></figure></p>

<p>Let's test this simple state:</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>    <span class="nv">$#</span> salt-call -linfo state.sls example_com_apache_virtualhost</code></pre></figure></p>

<p>You should en up with two states in success and a <code>/etc/apache2/sites-available/100-example.com</code> file created.
Now let's say we want other states, an infinite list of other states, to be able to alter this file and add content either in the main Directory section or at the end of the file. This way other states could add some apache configuration (this is an example, another way of doing it could be apache's include directive).</p>

<p>Here comes the <strong>accumulator</strong> jinja variable. It's a dictionnary, with several keys. Each key of this dictionary is the result of <strong>one or more</strong> <a href="http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.accumulated"><code>file.accumulated</code></a> states. So you may have this variable (or not) and it may contain some keys with text data inside. Let's see how to use this on the jinja template (and at first, we known it's empty, we did not used any accumulated state yet).</p>

<p><figure class="highlight"><pre><code class="language-jinja" data-lang="jinja"><span class="lineno"> 1 </span><span class="x">    # Main Virtualhost for </span><span class="cp">{{</span> <span class="nv">servername</span> <span class="cp">}}</span><span class="x"></span>
<span class="lineno"> 2 </span><span class="x">    &lt;VirtualHost *:80&gt;</span>
<span class="lineno"> 3 </span><span class="x">        ServerAdmin foo@example.com</span>
<span class="lineno"> 4 </span><span class="x">    </span>
<span class="lineno"> 5 </span><span class="x">        DocumentRoot </span><span class="cp">{{</span> <span class="nv">docroot</span> <span class="cp">}}</span><span class="x"></span>
<span class="lineno"> 6 </span><span class="x">    </span>
<span class="lineno"> 7 </span><span class="x">        ServerName </span><span class="cp">{{</span> <span class="nv">servername</span> <span class="cp">}}</span><span class="x"></span>
<span class="lineno"> 8 </span><span class="x">    </span>
<span class="lineno"> 9 </span><span class="x">        LogLevel info</span>
<span class="lineno">10 </span><span class="x">    </span>
<span class="lineno">11 </span><span class="x">      &lt;Directory /&gt;</span>
<span class="lineno">12 </span><span class="x">        AllowOverride None</span>
<span class="lineno">13 </span><span class="x">        Order allow, deny</span>
<span class="lineno">14 </span><span class="x">        deny from all</span>
<span class="lineno">15 </span><span class="x">      &lt;/Directory&gt;</span>
<span class="lineno">16 </span><span class="x">    </span>
<span class="lineno">17 </span><span class="x">      &lt;Directory </span><span class="cp">{{</span> <span class="nv">docroot</span> <span class="cp">}}</span><span class="x">&gt;</span>
<span class="lineno">18 </span><span class="x">        Options FollowSymLinks</span>
<span class="lineno">19 </span><span class="x">        AllowOverride None</span>
<span class="lineno">20 </span><span class="x">        Order allow,deny</span>
<span class="lineno">21 </span><span class="x">        Allow from all</span>
<span class="lineno">22 </span>
<span class="lineno">23 </span><span class="x">        # Here any extra configuration settings if any:</span>
<span class="lineno">24 </span><span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">accumulator</span><span class="o">|</span><span class="nf">default</span><span class="o">(</span><span class="kp">False</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">25 </span><span class="x">        </span><span class="cp">{%</span>   <span class="k">if</span> <span class="s1">&#39;extra-settings-example-virtualhost-maindir&#39;</span> <span class="k">in</span> <span class="nv">accumulator</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">26 </span><span class="x">        </span><span class="cp">{%</span>     <span class="k">for</span> <span class="nv">line</span> <span class="k">in</span> <span class="nv">accumulator</span><span class="o">[</span><span class="s1">&#39;extra-settings-example-virtualhost-maindir&#39;</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">27 </span><span class="x">        </span><span class="cp">{{</span> <span class="nv">line</span> <span class="cp">}}</span><span class="x"></span>
<span class="lineno">28 </span><span class="x">        </span><span class="cp">{%</span>     <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">29 </span><span class="x">        </span><span class="cp">{%</span>   <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">30 </span><span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">31 </span>
<span class="lineno">32 </span><span class="x">      &lt;/Directory&gt;</span>
<span class="lineno">33 </span>
<span class="lineno">34 </span><span class="x">    # Here any extra configuration settings if any:</span>
<span class="lineno">35 </span><span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">accumulator</span><span class="o">|</span><span class="nf">default</span><span class="o">(</span><span class="kp">False</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">36 </span><span class="x">    </span><span class="cp">{%</span>   <span class="k">if</span> <span class="s1">&#39;extra-settings-example-virtualhost&#39;</span> <span class="k">in</span> <span class="nv">accumulator</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">37 </span><span class="x">    </span><span class="cp">{%</span>     <span class="k">for</span> <span class="nv">line</span> <span class="k">in</span> <span class="nv">accumulator</span><span class="o">[</span><span class="s1">&#39;extra-settings-example-virtualhost&#39;</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">38 </span><span class="x">    </span><span class="cp">{{</span> <span class="nv">line</span> <span class="cp">}}</span><span class="x"></span>
<span class="lineno">39 </span><span class="x">    </span><span class="cp">{%</span>     <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">40 </span><span class="x">    </span><span class="cp">{%</span>   <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">41 </span><span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">42 </span><span class="x">  </span>
<span class="lineno">43 </span><span class="x">    &lt;/VirtualHost&gt;</span></code></pre></figure></p>

<p>If you run the state nothing should move, except maybe the two comments lines. The thing we need to do now is to feed this accumulator variable with <a href="http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.accumulated"><code>file.accumulated</code></a> states. On theses states the <code>name</code> of the state will match the accumulator key.</p>

<p>So, for this example, we will use a second sls file <code>more-things-for-virtualhost.sls</code> :</p>

<p><figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="lineno"> 1 </span>    <span class="p p-Indicator">{</span><span class="c1"># Include dependencies #}</span>
<span class="lineno"> 2 </span>    <span class="nv">include</span><span class="p p-Indicator">:</span>
<span class="lineno"> 3 </span>      <span class="nv">- example_com_apache_virtualhost</span>
<span class="lineno"> 4 </span>  <br/>
<span class="lineno"> 5 </span>    <span class="nv">example-a-first-rewrite-rule</span><span class="p p-Indicator">:</span>
<span class="lineno"> 6 </span>      <span class="nv">file.accumulated</span><span class="p p-Indicator">:</span>
<span class="lineno"> 7 </span>        <span class="nv">- name</span><span class="p p-Indicator">:</span> <span class="nv">extra-settings-example-virtualhost-maindir</span>
<span class="lineno"> 8 </span>        <span class="nv">- filename</span><span class="p p-Indicator">:</span> <span class="nv">/etc/apache2/sites-available/100-example.com</span>
<span class="lineno"> 9 </span>        <span class="nv">- text</span><span class="p p-Indicator">:</span> <span class="err">|</span>
<span class="lineno">10 </span>            <span class="c1"># this is an example of thing added in the middle</span>
<span class="lineno">11 </span>            <span class="nv">RewriteEngine On</span>
<span class="lineno">12 </span>            <span class="nv">RewriteCond %</span><span class="p p-Indicator">{</span><span class="nv">REQUEST_FILENAME</span><span class="p p-Indicator">}</span>  <span class="nv">-d</span>
<span class="lineno">13 </span>            <span class="nv">RewriteRule ^(.+</span><span class="p p-Indicator">[</span><span class="nv">^/</span><span class="p p-Indicator">]</span><span class="nv">)$  $1/</span>  <span class="p p-Indicator">[</span><span class="nv">R</span><span class="p p-Indicator">]</span>
<span class="lineno">14 </span>        <span class="nv">- require_in</span><span class="p p-Indicator">:</span>
<span class="lineno">15 </span>            <span class="nv">- file</span><span class="p p-Indicator">:</span> <span class="nv">100_example_com_virtualhost</span>
<span class="lineno">16 </span>  <br/>
<span class="lineno">17 </span>    <span class="nv">example-some-icons-added</span><span class="p p-Indicator">:</span>
<span class="lineno">18 </span>      <span class="nv">file.accumulated</span><span class="p p-Indicator">:</span>
<span class="lineno">19 </span>        <span class="nv">- name</span><span class="p p-Indicator">:</span> <span class="nv">extra-settings-example-virtualhost</span>
<span class="lineno">20 </span>        <span class="nv">- filename</span><span class="p p-Indicator">:</span> <span class="nv">/etc/apache2/sites-available/100-example.com</span>
<span class="lineno">21 </span>        <span class="nv">- text</span><span class="p p-Indicator">:</span> <span class="err">|</span>
<span class="lineno">22 </span>            <span class="c1"># this is an example of thing added at the end&#39;</span>
<span class="lineno">23 </span>            <span class="nv">Alias /icons /path/to/icons&gt;</span>
<span class="lineno">24 </span>            <span class="nv">&lt;Directory /path/to/icons</span>
<span class="lineno">25 </span>              <span class="nv">Order allow</span><span class="p p-Indicator">,</span><span class="nv">deny</span>
<span class="lineno">26 </span>              <span class="nv">Allow from all</span>
<span class="lineno">27 </span>            <span class="nv">&lt;/Directory&gt;</span>
<span class="lineno">28 </span>        <span class="nv">- require_in</span><span class="p p-Indicator">:</span>
<span class="lineno">29 </span>            <span class="nv">- file</span><span class="p p-Indicator">:</span> <span class="nv">100_example_com_virtualhost</span>
<span class="lineno">30 </span>  <br/>
<span class="lineno">31 </span>    <span class="nv">example-another-thing</span><span class="p p-Indicator">:</span>
<span class="lineno">32 </span>      <span class="nv">file.accumulated</span><span class="p p-Indicator">:</span>
<span class="lineno">33 </span>        <span class="nv">- name</span><span class="p p-Indicator">:</span> <span class="nv">extra-settings-example-virtualhost-maindir</span>
<span class="lineno">34 </span>        <span class="nv">- filename</span><span class="p p-Indicator">:</span> <span class="nv">/etc/apache2/sites-available/100-example.com</span>
<span class="lineno">35 </span>        <span class="nv">- text</span><span class="p p-Indicator">:</span> <span class="err">|</span>
<span class="lineno">36 </span>            <span class="c1"># this is another example of thing added in the middle</span>
<span class="lineno">37 </span>            <span class="nv">RewriteRule    ^/cgi-bin/imagemap(.*)  $1</span>  <span class="p p-Indicator">[</span><span class="nv">PT</span><span class="p p-Indicator">]</span>
<span class="lineno">38 </span>        <span class="nv">- require_in</span><span class="p p-Indicator">:</span>
<span class="lineno">39 </span>            <span class="nv">- file</span><span class="p p-Indicator">:</span> <span class="nv">100_example_com_virtualhost</span>
<span class="lineno">40 </span>        <span class="nv">- require</span><span class="p p-Indicator">:</span>
<span class="lineno">41 </span>            <span class="nv">- file</span><span class="p p-Indicator">:</span> <span class="nv">example-a-first-rewrite-rule</span>
<span class="lineno">42 </span>  <br/>
<span class="lineno">43 </span>    <span class="nv">example-another-thing-again</span><span class="p p-Indicator">:</span>
<span class="lineno">44 </span>      <span class="nv">file.accumulated</span><span class="p p-Indicator">:</span>
<span class="lineno">45 </span>        <span class="nv">- name</span><span class="p p-Indicator">:</span> <span class="nv">extra-settings-example-virtualhost-maindir</span>
<span class="lineno">46 </span>        <span class="nv">- filename</span><span class="p p-Indicator">:</span> <span class="nv">/etc/apache2/sites-available/100-example.com</span>
<span class="lineno">47 </span>        <span class="nv">- text</span><span class="p p-Indicator">:</span> <span class="err">|</span>
<span class="lineno">48 </span>            <span class="c1"># this is another example of thing added in the middle</span>
<span class="lineno">49 </span>            <span class="nv">&lt;FilesMatch &quot;.(gif|jpe</span><span class="p p-Indicator">?</span><span class="nv">g|png)$&quot;&gt;</span>
<span class="lineno">50 </span>                <span class="nv">ExpiresDefault A2592000</span>
<span class="lineno">51 </span>            <span class="nv">&lt;/FilesMatch&gt;</span>
<span class="lineno">52 </span>        <span class="nv">- require_in</span><span class="p p-Indicator">:</span>
<span class="lineno">53 </span>            <span class="nv">- file</span><span class="p p-Indicator">:</span> <span class="nv">100_example_com_virtualhost</span></code></pre></figure></p>

<p>Now let's run this new sls:</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>    <span class="nv">$#</span> salt-call -linfo state.sls more-things-for-virtualhost</code></pre></figure></p>

<p>You should get a nice diff showing you that all theses states added content on the right place:</p>

<p><figure class="highlight"><pre><code class="language-apache" data-lang="apache"><span class="lineno"> 1 </span>    <span class="err">+++</span>
<span class="lineno"> 2 </span>    <span class="err">@@</span> <span class="err">-21,9</span> <span class="err">+21,41</span> <span class="err">@@</span>
<span class="lineno"> 3 </span>         <span class="nb">Allow</span> from <span class="k">all</span>
<span class="lineno"> 4 </span>         <span class="c"># Here any extra configuration settings if any:</span>
<span class="lineno"> 5 </span>       <br/>
<span class="lineno"> 6 </span>    <span class="err">+</span>  <br/>
<span class="lineno"> 7 </span>    <span class="err">+</span>  <br/>
<span class="lineno"> 8 </span>    <span class="err">+</span>    <span class="c"># this is an example of thing added in the middle</span>
<span class="lineno"> 9 </span>    <span class="err">+</span><span class="nb">RewriteEngine</span> <span class="k">On</span>
<span class="lineno">10 </span>    <span class="err">+</span><span class="nb">RewriteCond</span> %{REQUEST_FILENAME}  -d
<span class="lineno">11 </span>    <span class="err">+</span><span class="nb">RewriteRule</span> ^(.+[^/])$  $1/  [R]
<span class="lineno">12 </span>    <span class="err">+</span>
<span class="lineno">13 </span>    <span class="err">+</span>  <br/>
<span class="lineno">14 </span>    <span class="err">+</span>    <span class="c"># this is another example of thing added in the middle</span>
<span class="lineno">15 </span>    <span class="err">+</span><span class="nb">RewriteRule</span>    ^/cgi-bin/imagemap(.*)  $1  [PT]
<span class="lineno">16 </span>    <span class="err">+</span>
<span class="lineno">17 </span>    <span class="err">+</span>  <br/>
<span class="lineno">18 </span>    <span class="err">+</span>    <span class="c"># this is another example of thing added in the middle</span>
<span class="lineno">19 </span>    <span class="err">+</span><span class="nt">&lt;FilesMatch</span> <span class="s">&quot;.(gif|jpe?g|png)$&quot;</span><span class="nt">&gt;</span>
<span class="lineno">20 </span>    <span class="err">+</span>    <span class="nb">ExpiresDefault</span> A2592000
<span class="lineno">21 </span>    <span class="err">+</span><span class="nt">&lt;/FilesMatch&gt;</span>
<span class="lineno">22 </span>    <span class="err">+</span>
<span class="lineno">23 </span>    <span class="err">+</span>  <br/>
<span class="lineno">24 </span>    <span class="err">+</span>  <br/>
<span class="lineno">25 </span>    <span class="err">+</span>  <br/>
<span class="lineno">26 </span>       <span class="nt">&lt;/Directory&gt;</span>
<span class="lineno">27 </span>   <br/>
<span class="lineno">28 </span>     <span class="c"># Here any extra configuration settings if any:</span>
<span class="lineno">29 </span>   <br/>
<span class="lineno">30 </span>   <br/>
<span class="lineno">31 </span>    <span class="err">+</span>
<span class="lineno">32 </span>    <span class="err">+</span><span class="c"># this is an example of thing added at the end&#39;</span>
<span class="lineno">33 </span>    <span class="err">+</span><span class="nb">Alias</span> <span class="sx">/icons</span> <span class="sx">/path/to/icons</span>&gt;
<span class="lineno">34 </span>    <span class="err">+&lt;</span><span class="nb">Directory</span> <span class="sx">/path/to/icons</span>
<span class="lineno">35 </span>    <span class="err">+</span>  <span class="nb">Order</span> allow,deny
<span class="lineno">36 </span>    <span class="err">+</span>  <span class="nb">Allow</span> from <span class="k">all</span>
<span class="lineno">37 </span>    <span class="err">+</span><span class="nt">&lt;/Directory&gt;</span>
<span class="lineno">38 </span>    <span class="err">+</span>
<span class="lineno">39 </span>    <span class="err">+</span>
<span class="lineno">40 </span>    <span class="err">+</span>
<span class="lineno">41 </span>    <span class="err">+</span>
<span class="lineno">42 </span>    <span class="err">+</span>
<span class="lineno">43 </span>     <span class="nt">&lt;/VirtualHost&gt;</span></code></pre></figure></p>

<p>You can see that some extra spaces were added by my jinja control commands. We can strip down those whitespaces with jinja's<code>-</code>. Instead of:</p>

<p><figure class="highlight"><pre><code class="language-jinja" data-lang="jinja"><span class="lineno">1 </span><span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">accumulator</span><span class="o">|</span><span class="nf">default</span><span class="o">(</span><span class="kp">False</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">2 </span><span class="x">    </span><span class="cp">{%</span>   <span class="k">if</span> <span class="s1">&#39;extra-settings-example-virtualhost-maindir&#39;</span> <span class="k">in</span> <span class="nv">accumulator</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">3 </span><span class="x">    </span><span class="cp">{%</span>     <span class="k">for</span> <span class="nv">line</span> <span class="k">in</span> <span class="nv">accumulator</span><span class="o">[</span><span class="s1">&#39;extra-settings-example-virtualhost-maindir&#39;</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">4 </span><span class="x">    </span><span class="cp">{{</span> <span class="nv">line</span> <span class="cp">}}</span><span class="x"></span>
<span class="lineno">5 </span><span class="x">    </span><span class="cp">{%</span>     <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">6 </span><span class="x">    </span><span class="cp">{%</span>   <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">7 </span><span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span></code></pre></figure></p>

<p>Use:</p>

<p><figure class="highlight"><pre><code class="language-jinja" data-lang="jinja"><span class="lineno">1 </span><span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">accumulator</span><span class="o">|</span><span class="nf">default</span><span class="o">(</span><span class="kp">False</span><span class="o">)</span> -<span class="cp">%}</span><span class="x"></span>
<span class="lineno">2 </span><span class="x">    </span><span class="cp">{%</span>   <span class="k">if</span> <span class="s1">&#39;extra-settings-example-virtualhost-maindir&#39;</span> <span class="k">in</span> <span class="nv">accumulator</span> -<span class="cp">%}</span><span class="x"></span>
<span class="lineno">3 </span><span class="x">    </span><span class="cp">{%</span>     <span class="k">for</span> <span class="nv">line</span> <span class="k">in</span> <span class="nv">accumulator</span><span class="o">[</span><span class="s1">&#39;extra-settings-example-virtualhost-maindir&#39;</span><span class="o">]</span> -<span class="cp">%}</span><span class="x"></span>
<span class="lineno">4 </span><span class="x">    </span><span class="cp">{{</span> <span class="nv">line</span> <span class="cp">}}</span><span class="x"></span>
<span class="lineno">5 </span><span class="x">    </span><span class="cp">{%</span>-     <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">6 </span><span class="x">    </span><span class="cp">{%</span>-   <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="lineno">7 </span><span class="x">    </span><span class="cp">{%</span>- <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span></code></pre></figure></p>

<p>And to get the right number of spaces on the resulting file use the indent filter:</p>

<p><figure class="highlight"><pre><code class="language-jinja" data-lang="jinja"><span class="lineno">1 </span><span class="x">    </span><span class="cp">{{</span> <span class="nv">line</span><span class="o">|</span><span class="nf">indent</span><span class="o">(</span><span class="m">4</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span></code></pre></figure></p>

<h2>file.blockreplace using file.accumulated</h2>

<p>Now if you read the <a href="/saltstack/english/2014/01/20/saltstack_step_by_step_file_blockreplace/">previous post on <code>file.blockreplace</code></a> you may wonder how to use it with accumulators. It will differ a little from the <a href="http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.managed"><code>file.managed</code></a> usage of accumulators.</p>

<p>With <a href="http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.managed"><code>file.managed</code></a> you have this <em>accumulator</em> jinja variable and several keys inside. With <a href="http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.blockreplace"><code>file.blockreplace</code></a> you have nothing to do.</p>

<ul>
<li>If one accumulator is targeted on the same file (the same as the one targeted by the blockreplace), then the blockreplace <code>content</code> attribute will be filled with all the lines contained on this accumulator. Any data directly set in the content attribute is not loose, accumulator data is only added, but the content attribute is not required so it could also be empty.</li>
<li>If several accumulators are targeted on this file they will be merged, but if you use several blockreplace states on the same file the accumulators are merged using the requisites dependencies you've made and accumulators names.</li>
</ul>


<p>This last sentence is maybe weird. We'll make an example to see it, but another way of saying that is that it's magical and it should do the things you think it should do (if not, make bug reports).</p>

<p>So in this example we'll reuse the last example of managing entries in an <code>/etc/hosts</code> file. But we will manage two blocks of edition. So we have theses two states in an <code>hostsedit_acc.sls</code> file:</p>

<p><figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="lineno"> 1 </span>    <span class="l l-Scalar l-Scalar-Plain">test-etc-hosts-blockreplace-services-local</span><span class="p p-Indicator">:</span>
<span class="lineno"> 2 </span>      <span class="l l-Scalar l-Scalar-Plain">file.blockreplace</span><span class="p p-Indicator">:</span>
<span class="lineno"> 3 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/hosts</span>
<span class="lineno"> 4 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">marker_start</span><span class="p p-Indicator">:</span> <span class="s">&quot;#</span><span class="nv"> </span><span class="s">BLOCK</span><span class="nv"> </span><span class="s">TOP</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">salt</span><span class="nv"> </span><span class="s">managed</span><span class="nv"> </span><span class="s">zone</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">local</span><span class="nv"> </span><span class="s">services</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">please</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">edit&quot;</span>
<span class="lineno"> 5 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">marker_end</span><span class="p p-Indicator">:</span> <span class="s">&quot;#</span><span class="nv"> </span><span class="s">BLOCK</span><span class="nv"> </span><span class="s">BOTTOM</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">local</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">end</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">salt</span><span class="nv"> </span><span class="s">managed</span><span class="nv"> </span><span class="s">zone</span><span class="nv"> </span><span class="s">--&quot;</span>
<span class="lineno"> 6 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">show_changes</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="lineno"> 7 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">append_if_not_found</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="lineno"> 8 </span>  <br/>
<span class="lineno"> 9 </span>    <span class="l l-Scalar l-Scalar-Plain">test-etc-hosts-blockreplace-services-central</span><span class="p p-Indicator">:</span>
<span class="lineno">10 </span>      <span class="l l-Scalar l-Scalar-Plain">file.blockreplace</span><span class="p p-Indicator">:</span>
<span class="lineno">11 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/hosts</span>
<span class="lineno">12 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">marker_start</span><span class="p p-Indicator">:</span> <span class="s">&quot;#</span><span class="nv"> </span><span class="s">BLOCK</span><span class="nv"> </span><span class="s">TOP</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">salt</span><span class="nv"> </span><span class="s">managed</span><span class="nv"> </span><span class="s">zone</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">central</span><span class="nv"> </span><span class="s">services</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">please</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">edit&quot;</span>
<span class="lineno">13 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">marker_end</span><span class="p p-Indicator">:</span> <span class="s">&quot;#</span><span class="nv"> </span><span class="s">BLOCK</span><span class="nv"> </span><span class="s">BOTTOM</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">central</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">end</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">salt</span><span class="nv"> </span><span class="s">managed</span><span class="nv"> </span><span class="s">zone</span><span class="nv"> </span><span class="s">--&quot;</span>
<span class="lineno">14 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">show_changes</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="lineno">15 </span>        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">append_if_not_found</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span></code></pre></figure></p>

<p>Same blocks as in the <a href="/saltstack/english/2014/01/20/saltstack_step_by_step_file_blockreplace/">previous guide</a> on blockreplace. But there I removed the content attribute (it <em>could</em> work with a content attribute adding more static stuff, but I do not need it).</p>

<p>So now if I want to use <a href="http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.accumulated"><code>file.accumulated</code></a> to push some content in theses blocks I just need to do two things:</p>

<ul>
<li>target the blockreplace state id in a requisite to ensure my current state will run before</li>
<li>target the same file (name attribute)</li>
</ul>


<p>Quite simple, but here we have <strong>two</strong> managed blocks, my accumulated content will be set in the block targeted by my requisite.</p>

<p>Let's try it in a second sls file: <code>hosts_data.sls</code>, but you could split that on more files if everything gets included at the end:</p>

<p><figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="lineno"> 1 </span>    <span class="p p-Indicator">{</span><span class="c1"># Include dependencies #}</span>
<span class="lineno"> 2 </span>    <span class="nv">include</span><span class="p p-Indicator">:</span>
<span class="lineno"> 3 </span>        <span class="nv">- hostsedit_acc</span>
<span class="lineno"> 4 </span>  <br/>
<span class="lineno"> 5 </span>    <span class="nv">hostadata1-external-google-dns</span><span class="p p-Indicator">:</span>
<span class="lineno"> 6 </span>      <span class="nv">file.accumulated</span><span class="p p-Indicator">:</span>
<span class="lineno"> 7 </span>        <span class="nv">- filename</span><span class="p p-Indicator">:</span> <span class="nv">/etc/hosts</span>
<span class="lineno"> 8 </span>        <span class="nv">- text</span><span class="p p-Indicator">:</span> <span class="err">|</span>
<span class="lineno"> 9 </span>            <span class="nv">8.8.8.8 ns1.google.com</span>
<span class="lineno">10 </span>            <span class="nv">8.8.8.4 ns2.google.com</span>
<span class="lineno">11 </span>        <span class="nv">- require_in</span><span class="p p-Indicator">:</span>
<span class="lineno">12 </span>            <span class="nv">- file</span><span class="p p-Indicator">:</span> <span class="nv">test-etc-hosts-blockreplace-services-central</span>
<span class="lineno">13 </span>  <br/>
<span class="lineno">14 </span>    <span class="nv">hostadata2-external-thing</span><span class="p p-Indicator">:</span>
<span class="lineno">15 </span>      <span class="nv">file.accumulated</span><span class="p p-Indicator">:</span>
<span class="lineno">16 </span>        <span class="nv">- filename</span><span class="p p-Indicator">:</span> <span class="nv">/etc/hosts</span>
<span class="lineno">17 </span>        <span class="nv">- text</span><span class="p p-Indicator">:</span> <span class="s">&quot;93.184.216.119</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">www.example.com&quot;</span>
<span class="lineno">18 </span>        <span class="nv">- require_in</span><span class="p p-Indicator">:</span>
<span class="lineno">19 </span>            <span class="nv">- file</span><span class="p p-Indicator">:</span> <span class="nv">test-etc-hosts-blockreplace-services-central</span>
<span class="lineno">20 </span>  <br/>
<span class="lineno">21 </span>    <span class="nv">hostdata3-internal-stuff1</span><span class="p p-Indicator">:</span>
<span class="lineno">22 </span>      <span class="nv">file.accumulated</span><span class="p p-Indicator">:</span>
<span class="lineno">23 </span>        <span class="nv">- filename</span><span class="p p-Indicator">:</span> <span class="nv">/etc/hosts</span>
<span class="lineno">24 </span>        <span class="nv">- text</span><span class="p p-Indicator">:</span> <span class="s">&quot;127.0.0.1</span><span class="nv"> </span><span class="s">foo</span><span class="nv"> </span><span class="s">bar</span><span class="nv"> </span><span class="s">foo.local.net</span><span class="nv"> </span><span class="s">bar.local.net&quot;</span>
<span class="lineno">25 </span>        <span class="nv">- require_in</span><span class="p p-Indicator">:</span>
<span class="lineno">26 </span>            <span class="nv">- file</span><span class="p p-Indicator">:</span> <span class="nv">test-etc-hosts-blockreplace-services-local</span>
<span class="lineno">27 </span>  <br/>
<span class="lineno">28 </span>    <span class="nv">hostdata4-internal-stuff2</span><span class="p p-Indicator">:</span>
<span class="lineno">29 </span>      <span class="nv">file.accumulated</span><span class="p p-Indicator">:</span>
<span class="lineno">30 </span>        <span class="nv">- filename</span><span class="p p-Indicator">:</span> <span class="nv">/etc/hosts</span>
<span class="lineno">31 </span>        <span class="nv">- text</span><span class="p p-Indicator">:</span> <span class="err">|</span>
<span class="lineno">32 </span>            <span class="nv">127.0.0.1 db.local.net</span>
<span class="lineno">33 </span>            <span class="nv">127.0.0.1 http.local.net</span>
<span class="lineno">34 </span>            <span class="nv">127.0.0.1 foobar</span>
<span class="lineno">35 </span>        <span class="nv">- require_in</span><span class="p p-Indicator">:</span>
<span class="lineno">36 </span>            <span class="nv">- file</span><span class="p p-Indicator">:</span> <span class="nv">test-etc-hosts-blockreplace-services-local</span></code></pre></figure></p>

<p>Note that I did not use the <code>name</code> attribute in theses states. Using name I could name the dictionary key, or we could say I would set the accumulator name. I could use names, but using the same accumulator name with the four states, strange things would happen, data from all theses accumulators would be merged in the same accumulator name. So, either avoid name attributes or use it with different names if the targeted blockedit is different. And test your recipes :-)</p>

<p>Now run it with:</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1 </span>    <span class="nv">$#</span> salt-call -linfo state.sls hosts_data</code></pre></figure></p>

<p>You should get theses two managed blocks in <code>/etc/hosts</code>, filled from several states:</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno"> 1 </span>    <span class="c1"># BLOCK TOP : salt managed zone : local services : please do not edit</span>
<span class="lineno"> 2 </span>    127.0.0.1 foo bar foo.local.net bar.local.net
<span class="lineno"> 3 </span>    127.0.0.1 db.local.net
<span class="lineno"> 4 </span>    127.0.0.1 http.local.net
<span class="lineno"> 5 </span>    127.0.0.1 foobar
<span class="lineno"> 6 </span>  <br/>
<span class="lineno"> 7 </span>    <span class="c1"># BLOCK BOTTOM : local : end of salt managed zone --</span>
<span class="lineno"> 8 </span>    <span class="c1"># BLOCK TOP : salt managed zone : central services : please do not edit    </span>
<span class="lineno"> 9 </span>    93.184.216.119 : www.example.com
<span class="lineno">10 </span>    8.8.8.8 ns1.google.com
<span class="lineno">11 </span>    8.8.8.4 ns2.google.com
<span class="lineno">12 </span>  <br/>
<span class="lineno">13 </span>    <span class="c1"># BLOCK BOTTOM : central : end of salt managed zone --</span></code></pre></figure></p>

<h2>Last words</h2>

<p>Note that this example is based on the development github repository of salt. You may not be able to run theses examples on versions prior to 0.18.0. The multiple blockreplace case is one of the last fix added by @kiorky.
If you use accumulators you may need to subscribe on this <a href="https://github.com/saltstack/salt/issues/8881">reload_module vs accumulated issue</a> on github. It's a quite general issue, but this actually prevents using accumulators on states with too much <em>distance</em>, as you may loose the accumulated data if something restarted the minion while your states are running.</p>

<p><a href="https://twitter.com/regilero">Stay tuned on twitter, @regilero</a>, <a href="https://twitter.com/makinacorpus">@makinacorpus</a></p>


          </div>
         </div>
        </div>
        <div class="tag">Tags:&nbsp;<i class="glyphicon glyphicon-tag"></i><a href="/tag/Accumulated/">Accumulated</a>, <i class="glyphicon glyphicon-tag"></i><a href="/tag/BlockReplace/">BlockReplace</a>, <i class="glyphicon glyphicon-tag"></i><a href="/tag/Managed/">Managed</a>, <i class="glyphicon glyphicon-tag"></i><a href="/tag/SaltStack/">SaltStack</a></div>
</article>
<hr/>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: * * */
    var disqus_shortname = "regilero";
    var disqus_identifier = '671fb11a-8778-11e3-b2e4-d231feb1dc81';
    var disqus_title = "SaltStack, Use file.accumulated accumulators with file.managed and file.blockreplace";
    var disqus_url = 'http://regilero.github.io/saltstack/english/2014/01/27/saltstack_use_file_accumulated_accumulators_with_file_managed_and_file_blockreplace/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    

      </div>
      <div class="col-md-4" id="sideBar">

            <div id="sideBarContent"> 
              
              <div class="sideBarListBox">
                <div class="page-header">
                <h3>Related posts</h3>
                </div>
                <div class="list-group" role="navigation">
                  
                     <a class="list-group-item" href="/english/security/2018/07/03/security_pound_http_smuggling/">
                     <h4>Security: HTTP Smuggling, Apsis Pound load balancer</h4>
                     <p>details of CVE-2016-10711 (published feb 2018).</p>
                     </a>
                  
                     <a class="list-group-item" href="/english/postgresql/2017/06/26/postgresql_advanced_generate_series/">
                     <h4>PostgreSQL, advanced use of generate_series for data generation</h4>
                     <p>filling thousands of random realistic data rows.</p>
                     </a>
                  
                     <a class="list-group-item" href="/english/security/2016/12/19/security_dompdf_rce/">
                     <h4>Web Security, Dompdf security issues details</h4>
                     <p>details of december 2015's 3 CVE in dompdf, with one RCE.</p>
                     </a>
                  
                     <a class="list-group-item" href="/english/security/2016/06/10/security_play_with_implicit_html_and_closing_divs/">
                     <h4>Web Security, using bad HTML to escape from a DIV</h4>
                     <p>Break HTML layouts with only bad HTML and the browser's help.</p>
                     </a>
                  
                     <a class="list-group-item" href="/english/security/2015/10/04/http_smuggling_in_2015_part_one/">
                     <h4>Checking HTTP Smuggling issues in 2015 - Part1</h4>
                     <p>First part of the 2015 HTTP Smuggling articles. Injecting HTTP in HTTP, the theory.</p>
                     </a>
                  
                </div>
              </div>
              
      
              <div class="sideBarListBox">
                <div class="page-header">
                <h3>Latest posts</h3>
                </div>
                <div class="list-group" role="navigation">
                  
                     <a class="list-group-item" href="/english/security/2018/07/03/security_pound_http_smuggling/">
                     Security: HTTP Smuggling, Apsis Pound load balancer
                     </a>
                  
                     <a class="list-group-item" href="/english/postgresql/2017/06/26/postgresql_advanced_generate_series/">
                     PostgreSQL, advanced use of generate_series for data generation
                     </a>
                  
                     <a class="list-group-item" href="/english/security/2016/12/19/security_dompdf_rce/">
                     Web Security, Dompdf security issues details
                     </a>
                  
                     <a class="list-group-item" href="/english/security/2016/06/10/security_play_with_implicit_html_and_closing_divs/">
                     Web Security, using bad HTML to escape from a DIV
                     </a>
                  
                     <a class="list-group-item" href="/english/security/2015/10/04/http_smuggling_in_2015_part_one/">
                     Checking HTTP Smuggling issues in 2015 - Part1
                     </a>
                  
                </div>
              </div>
            
              <div class="sideBarListBox">
                <div class="page-header">
                <h3>Tags</h3>
                </div>

                <div class="tagcloud">
                <a style='font-size: 22px' class='taglink' href='/tag/mod_rewrite/'>mod_rewrite</a>
<a style='font-size: 31px' class='taglink' href='/tag/PHP/'>PHP</a>
<a style='font-size: 18px' class='taglink' href='/tag/jinja/'>jinja</a>
<a style='font-size: 12px' class='taglink' href='/tag/HTML/'>HTML</a>
<a style='font-size: 12px' class='taglink' href='/tag/Bash/'>Bash</a>
<a style='font-size: 18px' class='taglink' href='/tag/Plone/'>Plone</a>
<a style='font-size: 12px' class='taglink' href='/tag/js/'>js</a>
<a style='font-size: 12px' class='taglink' href='/tag/Bug/'>Bug</a>
<a style='font-size: 12px' class='taglink' href='/tag/Linux/'>Linux</a>
<a style='font-size: 18px' class='taglink' href='/tag/CVE/'>CVE</a>
<a style='font-size: 18px' class='taglink' href='/tag/APC/'>APC</a>
<a style='font-size: 12px' class='taglink' href='/tag/HAProxy/'>HAProxy</a>
<a style='font-size: 24px' class='taglink' href='/tag/SaltStack/'>SaltStack</a>
<a style='font-size: 12px' class='taglink' href='/tag/Ajax/'>Ajax</a>
<a style='font-size: 12px' class='taglink' href='/tag/Cache/'>Cache</a>
<a style='font-size: 12px' class='taglink' href='/tag/Dojo/'>Dojo</a>
<a style='font-size: 12px' class='taglink' href='/tag/Statistics/'>Statistics</a>
<a style='font-size: 30px' class='taglink' href='/tag/HTTP/'>HTTP</a>
<a style='font-size: 18px' class='taglink' href='/tag/PHP-fpm/'>PHP-fpm</a>
<a style='font-size: 12px' class='taglink' href='/tag/Js/'>Js</a>
<a style='font-size: 18px' class='taglink' href='/tag/Injection/'>Injection</a>
<a style='font-size: 12px' class='taglink' href='/tag/Pound/'>Pound</a>
<a style='font-size: 32px' class='taglink' href='/tag/Security/'>Security</a>
<a style='font-size: 18px' class='taglink' href='/tag/Web/'>Web</a>
<a style='font-size: 18px' class='taglink' href='/tag/Smuggling/'>Smuggling</a>
<a style='font-size: 12px' class='taglink' href='/tag/Monitoring/'>Monitoring</a>
<a style='font-size: 12px' class='taglink' href='/tag/Accumulated/'>Accumulated</a>
<a style='font-size: 31px' class='taglink' href='/tag/Drupal/'>Drupal</a>
<a style='font-size: 18px' class='taglink' href='/tag/RewriteMap/'>RewriteMap</a>
<a style='font-size: 22px' class='taglink' href='/tag/Nginx/'>Nginx</a>
<a style='font-size: 22px' class='taglink' href='/tag/PostgreSQL/'>PostgreSQL</a>
<a style='font-size: 28px' class='taglink' href='/tag/Performance/'>Performance</a>
<a style='font-size: 12px' class='taglink' href='/tag/Mongodb/'>Mongodb</a>
<a style='font-size: 32px' class='taglink' href='/tag/Apache/'>Apache</a>
<a style='font-size: 12px' class='taglink' href='/tag/ZendFramework/'>ZendFramework</a>
<a style='font-size: 18px' class='taglink' href='/tag/BlockReplace/'>BlockReplace</a>
<a style='font-size: 12px' class='taglink' href='/tag/Varnish/'>Varnish</a>
<a style='font-size: 12px' class='taglink' href='/tag/Managed/'>Managed</a>
<a style='font-size: 12px' class='taglink' href='/tag/HTML5/'>HTML5</a>
<a style='font-size: 22px' class='taglink' href='/tag/Proxy/'>Proxy</a>

                </div>
              </div>
          </div> <!-- end sideBarContent -->
            
            <div class="sideBarMore">
              <div class="page-header">
              <h3>About</h3>
              </div>
                <a href="https://twitter.com/regilero" target="_blank"><img src="/theme/img/twitter_thumb.png" width="48" height="48" alt="Twitter regilero" title="Twitter regilero"></a>
                <a href="https://github.com/regilero" target="_blank"><img src="/theme/img/github_thumb.png" width="48" height="48" alt="Github regilero" title="Github regilero"></a>
                <a href="https://plus.google.com/111280074129555323484?rel=author" target="_blank"><img src="/theme/img/google-plus-thumb.png" width="48" height="48" alt="G+" title="G+"></a>
                <a href="http://www.flickr.com/photos/regilero/" target="_blank"><img src="/theme/img/flickr_thumb.png" width="48" height="48" alt="Flickr photos" title="Flickr photos"></a>
                <a href="http://stackoverflow.com/users/550618/regilero" target="_blank"><img src="http://stackoverflow.com/users/flair/550618.png" width="208" height="58" alt="profile for regilero at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for regilero at Stack Overflow, Q&amp;A for professional and enthusiast programmers"></a>
                <a href="https://stackexchange.com/users/264377/regilero"  target="_blank"><img src="http://stackexchange.com/users/flair/264377.png?theme=clean" width="208" height="58" alt="profile for regilero on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for regilero on Stack Exchange, a network of free, community-driven Q&amp;A sites" /></a>
            </div>
            <div class="sideBarItem">
              <h3>Some Friends</h3>
                <ul>
                  <li><a class="effect" target="_blank" href="http://makina-corpus.com/blog/metier/actu-metier">Blogs Makina Corpus<div class="cover-right"><img src="/theme/img/makinaorg.png" height="30" width="30"><img src="/theme/img/makinaorg_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://www.makina-corpus.com">Makina Corpus<div class="cover-right"><img src="/theme/img/makinacom.png" height="30" width="30"><img src="/theme/img/makinacom_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://blog.processus.org/">Pounard, processus.org<div class="cover-right"><img src="/theme/img/pounard.png" height="30" width="30"><img src="/theme/img/pounard_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://toutpt.github.io/" >Toupt<div class="cover-right"><img src="/theme/img/toupt.png" height="30" width="30"><img src="/theme/img/toupt_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://francoisgaudin.com/">François Gaudin<div class="cover-right"><img src="/theme/img/gaudin.png" height="30" width="30"><img src="/theme/img/gaudin_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://fle.github.io/">Florent Lebreton<div class="cover-right"><img src="/theme/img/fle.png" height="30" width="30"><img src="/theme/img/fle_banner.png" height="30" width="117"></div></a></li>
                </ul>
                <div class="clear"></div>
            </div>
         </div> <!-- end sidebar -->
        
       </div><!-- end row -->
       <div class="row">
         <div class="col-md-12" id="footer">
           <div class="panel panel-default">
             <div class=panel-footer">
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/fr/"><img alt="Licence Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/fr/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">regilero's blog</span> est mis à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/fr/">licence Creative Commons Attribution -  Partage dans les Mêmes Conditions 3.0 France</a>.<br />Fondé(e) sur une œuvre à <a xmlns:dct="http://purl.org/dc/terms/" href="http://regilero.github.io" rel="dct:source">http://regilero.github.io</a>.
              </div>
            </div>
         </div>
       </div><!-- end row -->
  </div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!--    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script> -->
    <script src="/theme/js/toc.min.js" ></script>
    <script src="/theme/js/effects.js" ></script>
   <script src="/theme/js/jquery.parallax.min.js"></script>
    <script src="/theme/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-40859893-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
    </body>
</html>
