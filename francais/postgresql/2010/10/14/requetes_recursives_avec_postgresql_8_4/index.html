<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Requêtes récursives avec PostgreSQL 8.4 (WITH RECURSIVE) |  RBleug</title>
    <meta name="description" content="Regilero's blog; Mostly tech things about web stuff."/>
    <meta name="author" content="regilero"/>
    <link rel="author" href="/contact/" title="who am I?" type="text/html" />
    <link rel="icon" type="image/x-icon" href="/theme/img/regilero.ico" />
    <link rel="shortcut icon" type="image/x-icon" href="/theme/img/regilero.ico" />
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/feed.xml" />
    <link rel="stylesheet" href="/theme/bootstrap/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/theme/bootstrap/css/bootstrap-theme.min.css" type="text/css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
<!--
    <link rel="stylesheet" href="/theme/blueprint/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="/theme/blueprint/print.css" type="text/css" media="print">
    <link rel="stylesheet" href="/theme/syntax.css" type="text/css" />
    <!--[if lt IE 8]>
      <link rel="stylesheet" href="/theme/blueprint/ie.css" type="text/css" media="screen, projection">
    <![endif]-->
<!--
    <link rel="stylesheet" href="/theme/blueprint/plugins/link-icons/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="/theme/fontello/css/fontello.css">
    <!--[if IE 7]><link rel="stylesheet" href="/theme/fontello/css/fontello-ie7.css"><![endif]-->
    <link href="/theme/syntax.css" rel="stylesheet" type="text/css" />
    <link href="/theme/style.css" rel="stylesheet" type="text/css" />

  </head>
  <body>
    <div class="topNav navbar navbar-inverse navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand visible-xs-inline" href="#">Navigation</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li ><a href="/" class="glyphicon glyphicon-home">&nbsp;Home</a></li>
            <li class="active"><a href="/archives/" class="glyphicon glyphicon-th">&nbsp;Archives</a></li>
            <li ><a href="/contact/" class="glyphicon glyphicon-earphone">&nbsp;Contact</a></li>
            <li><a class="glyphicon glyphicon-eye-open" href="/feed.xml">&nbsp;RSS Feed</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

  <div class="container" role="main">
  
    <div class="jumbotron">
      <div class="container">
         <div id="branding">
           <h1 class="logo"><a href="/">RBleug</a></h1>
           <hr/>
           <h2 class="alt">Regilero's blog; Mostly tech things about web stuff.</h2>
         </div>
       </div>
     </div>

    <div class="row">
      <div class="col-md-8" id="left-content">

          <article>
        <header>
            <div class="page-header">
            <h1>Requêtes récursives avec PostgreSQL 8.4 (WITH RECURSIVE)
            <br/><span><i class="glyphicon glyphicon-time">&nbsp;</i><time datetime="2010-10-14">Oct 14, 2010</time></span>
            <span class="category"><i class="glyphicon glyphicon-list">&nbsp;</i> <a href="/francais/">francais</a> and <a href="/postgresql/">postgresql</a></span>
            </h1>
            </div>
        </header>

        <div class="entry">
         <div class="col-md-6">
          <div class="post-excerpt-full">
          Obtenir directement un résultat arborescent avec du SQL est un graal qui est désormais accessible sur PostgreSQL, et un exemple détaillé vaut mieux qu'un long discours.
          </div>
          <div id="post-toc">
          </div>
         </div>
         <div class="col-md-6">
          <img class="topimg" src="/theme/img/pic/old8.jpg" alt="Obtenir directement un résultat arborescent avec du SQL est un graal qui est désormais accessible sur PostgreSQL, et un exemple détaillé vaut mieux qu'un long discours." title="Obtenir directement un résultat arborescent avec du SQL est un graal qui est désormais accessible sur PostgreSQL, et un exemple détaillé vaut mieux qu'un long discours." />
         </div>
         <div class="row">
          <div class="col-md-12" id="post-full">
       
          <p>Si vous avez déjà touché à un Oracle vous connaissez peut-être le mot clef <code>CONNECT BY</code> qui permet d'effectuer des <strong>requêtes arborescentes</strong>.</p>

<p>Les requêtes arborescentes sont très pratiques pour extraire des données sous forme <strong>d'arbre</strong>, pour, par exemple,
remplir le jeu de données d'un arbre de type <a href="http://www.jstree.com/">jstree</a> ou autre <a href="http://plugins.jquery.com/?s=tree">plugin jquery d'arbre</a>.</p>

<p>Pour faire simple dès que vous avez une table avec une <strong>relation parent qui est une jointure sur elle-même</strong> vous avez des chances
 d'avoir besoin de requêtes arborescentes. <br/>
Sans cela vous risquez de partir sur des algorithmes assez complexe dans votre language de traitement de données (python, PHP, jsqp, etc).
Et c'est fort dommage quand le SGBD peut vous sauver la vie.<br/>
Or donc sous postgreSQL il n'y avait pas d'équivalent du <code>connect by</code>, pas de requête arborescente.
Il faudra que dans un billet futur je vous montre mes petits triggers qui permettent de pallier à ça, mais il n'y a rien de simple là-dedans.
Mais depuis la version <code>8.4</code>, le mot clef <strong>"WITH RECURSIVE"</strong> nous permet de faire des requêtes récursives.<br/>
Nous allons donc voir comment cela se manipule avec un exemple concret.</p>

<h2>L'exemple: des dossiers et fichiers</h2>

<p>Nous allons partir d'une table qui représente l'ensemble des fichiers et répertoires du disque dur, et essayer de faire des requêtes ordonnées
dessus.</p>

<p>Donc on commence par <strong>la structure de la table qui va acceuillir toutes ces données</strong>, je mets tout ça dans une base <code>test</code> accessible avec un user
<code>testuser</code> et un mot de passe qui va bien:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">FILETYPE</span> <span class="k">AS</span> <span class="n">ENUM</span> <span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;directory&#39;</span><span class="p">);</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">FILE</span> <span class="p">(</span>
   <span class="n">FILE_ID</span>              <span class="nb">SERIAL</span>              <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
   <span class="n">FILE_NAME</span>            <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>        <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
   <span class="n">FILE_FULLNAME</span>        <span class="nb">varchar</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>        <span class="k">not</span> <span class="k">null</span> <span class="k">unique</span><span class="p">,</span>
   <span class="n">FILE_TYPE</span>            <span class="n">FILETYPE</span>             <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span>
   <span class="n">FILE_PARENT</span>           <span class="n">INT4</span>                 <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="mi">0</span> <span class="k">references</span> <span class="n">FILE</span> <span class="p">(</span><span class="n">FILE_ID</span><span class="p">)</span> <span class="k">on</span> <span class="k">update</span> <span class="k">restrict</span> <span class="k">on</span> <span class="k">delete</span> <span class="k">restrict</span><span class="p">,</span>
   <span class="k">CONSTRAINT</span> <span class="n">PK_FILE</span> <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">FILE_ID</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">FILE_FULLNAME_IDX</span> <span class="k">on</span> <span class="n">FILE</span> <span class="p">(</span>
<span class="n">FILE_FULLNAME</span>
<span class="p">);</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">FILE_NAME_IDX</span> <span class="k">on</span> <span class="n">FILE</span> <span class="p">(</span>
<span class="n">FILE_NAME</span>
<span class="p">);</span></code></pre></div>


<p>On remarque la liaison <code>"references"</code> sur <code>FILE_PARENT</code> qui pointe sur la table elle-même, c'est tout le principe.<br/>
Maintenant il va falloir remplir cette table. Ce n'est pas la partie la plus simple.
Le mieux serait sans doute un script python mais comme je suis un peu dingue j'ai écrit un script en bash
(vous remarquerez que je limite à 30 caractères dans le nom de directory pour restreindre l'analyse,
mais vous pouvez mettre plus si vous avez le temps d'attendre):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="nv">REP_SOURCE</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">;</span>
<span class="nv">BASE</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">;</span>
<span class="nv">HOST</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">;</span>
<span class="nv">USER</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span><span class="p">;</span>
<span class="nv">MAXLENGHT</span><span class="o">=</span>30<span class="p">;</span>

<span class="c"># trap ctrl-c and call ctrl_c()</span>
<span class="nb">trap </span>ctrl_c INT

<span class="k">function</span> ctrl_c<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;** Trapped CTRL-C&quot;</span><span class="p">;</span>
    <span class="nb">exit </span>1<span class="p">;</span>
<span class="o">}</span>

<span class="k">function</span> normalize <span class="o">{</span>
    <span class="nb">echo</span> <span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$1&quot;</span><span class="p">|</span>sed <span class="s2">&quot;s/\&quot;/_/g&quot;</span><span class="p">|</span>sed <span class="s2">&quot;s/&#39;/_/g&quot;</span><span class="p">|</span>sed <span class="s2">&quot;s/ /_/g&quot;</span><span class="k">)</span><span class="p">;</span>
<span class="o">}</span>
<span class="k">function</span> treeanalyse <span class="o">{</span>
    <span class="nv">DIR</span><span class="o">=</span><span class="nv">$1</span><span class="p">;</span>
    <span class="c"># shorten duration of this script with path greater than MAXLENGHT chars</span>
    <span class="nv">len</span><span class="o">=</span><span class="sb">`</span>expr length <span class="s2">&quot;$DIR&quot;</span><span class="sb">`</span><span class="p">;</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$len</span> -lt <span class="nv">$MAXLENGHT</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="c">#echo &quot;DIR $DIR&quot;</span>
        <span class="nv">nDIR</span><span class="o">=</span><span class="k">$(</span>normalize <span class="s2">&quot;$DIR&quot;</span><span class="k">)</span><span class="p">;</span>
        <span class="c"># files detection</span>
        find <span class="s2">&quot;$DIR&quot;</span> -maxdepth <span class="m">1</span> -type f <span class="p">|</span> <span class="k">while</span> <span class="nb">read </span>FIL <span class="p">;</span> <span class="k">do</span>
            <span class="nv">FILENAME</span><span class="o">=</span><span class="sb">`</span>basename <span class="s2">&quot;$FIL&quot;</span><span class="sb">`</span><span class="p">;</span>
            <span class="nv">nNAME</span><span class="o">=</span><span class="k">$(</span>normalize <span class="s2">&quot;$FILENAME&quot;</span><span class="k">)</span><span class="p">;</span>
            <span class="nv">nFIL</span><span class="o">=</span><span class="k">$(</span>normalize <span class="s2">&quot;$FIL&quot;</span><span class="k">)</span><span class="p">;</span>
            <span class="nv">SQL</span><span class="o">=</span><span class="s2">&quot;INSERT INTO FILE (FILE_NAME,FILE_FULLNAME,FILE_TYPE,FILE_PARENT) SELECT &#39;$nNAME&#39;,&#39;$nFIL&#39;,&#39;file&#39;, FILE_ID FROM FILE WHERE FILE_FULLNAME=&#39;$nDIR&#39;;&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;${SQL}&quot;</span> &gt;&gt; /tmp/insert.sql
        <span class="k">done</span>
        <span class="c"># directory detection</span>
        find <span class="s2">&quot;${DIR}&quot;</span> -maxdepth <span class="m">1</span> -type d <span class="p">|</span> <span class="k">while</span> <span class="nb">read </span>SUBDIR <span class="p">;</span> <span class="k">do</span>
            <span class="nb">echo</span> <span class="s2">&quot;$SUBDIR&quot;</span><span class="p">;</span>
            <span class="nv">DIRNAME</span><span class="o">=</span><span class="sb">`</span>basename <span class="s2">&quot;$SUBDIR&quot;</span><span class="sb">`</span><span class="p">;</span>
            <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$SUBDIR&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$DIR&quot;</span> -a <span class="s2">&quot;$DIRNAME&quot;</span> !<span class="o">=</span> <span class="s2">&quot;proc&quot;</span> -a <span class="s2">&quot;$DIRNAME&quot;</span> !<span class="o">=</span> <span class="s2">&quot;sys&quot;</span> -a <span class="s2">&quot;$DIRNAME&quot;</span> !<span class="o">=</span> <span class="s2">&quot;mnt&quot;</span> -a <span class="s2">&quot;$DIRNAME&quot;</span> !<span class="o">=</span> <span class="s2">&quot;.&quot;</span> -a <span class="s2">&quot;$DIRNAME&quot;</span> !<span class="o">=</span> <span class="s2">&quot;..&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                <span class="nv">CLEANDIRNAME</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$DIRNAME</span><span class="p">|</span>sed <span class="s2">&quot;s/\&quot;/_/g&quot;</span><span class="p">|</span>sed <span class="s2">&quot;s/&#39;/_/g&quot;</span><span class="p">|</span>sed <span class="s2">&quot;s/ /_/g&quot;</span><span class="k">)</span><span class="p">;</span>
                <span class="nv">nDIRNAME</span><span class="o">=</span><span class="k">$(</span>normalize <span class="s2">&quot;$DIRNAME&quot;</span><span class="k">)</span><span class="p">;</span>
                <span class="nv">nDIR</span><span class="o">=</span><span class="k">$(</span>normalize <span class="s2">&quot;$DIR&quot;</span><span class="k">)</span><span class="p">;</span>
                <span class="nv">nSUBDIR</span><span class="o">=</span><span class="k">$(</span>normalize <span class="s2">&quot;$SUBDIR&quot;</span><span class="k">)</span><span class="p">;</span>
                <span class="nv">SQL</span><span class="o">=</span><span class="s2">&quot;INSERT INTO FILE (FILE_NAME,FILE_FULLNAME,FILE_TYPE,FILE_PARENT) SELECT &#39;$nDIRNAME&#39;,&#39;$nSUBDIR&#39;,&#39;directory&#39;,FILE_ID FROM FILE WHERE FILE_FULLNAME=&#39;$nDIR&#39;;&quot;</span>
                <span class="nb">echo</span> <span class="s2">&quot;${SQL}&quot;</span> &gt;&gt; /tmp/insert.sql<span class="p">;</span>
                <span class="nv">DIRBACKUP</span><span class="o">=</span><span class="nv">$DIR</span><span class="p">;</span> <span class="c"># prevent variable overlap in bash</span>
                treeanalyse <span class="nv">$SUBDIR</span><span class="p">;</span>
                <span class="nv">DIR</span><span class="o">=</span><span class="nv">$DIRBACKUP</span><span class="p">;</span> <span class="c"># prevent variable overlap in bash</span>
            <span class="k">fi</span>
        <span class="k">done</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="nv">PARENTDIR</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>
<span class="nv">SQL</span><span class="o">=</span><span class="s2">&quot;TRUNCATE FILE;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;${SQL}&quot;</span> &gt; /tmp/insert.sql<span class="p">;</span>
<span class="nv">SQL</span><span class="o">=</span><span class="s2">&quot;INSERT INTO FILE (FILE_ID,FILE_NAME,FILE_FULLNAME,FILE_TYPE,FILE_PARENT) VALUES ($PARENTDIR,&#39;$REP_SOURCE&#39;,&#39;$REP_SOURCE&#39;,&#39;directory&#39;,$PARENTDIR);&quot;</span>
<span class="nv">PARENTDIR</span><span class="o">=</span><span class="nv">$REP_SOURCE</span><span class="p">;</span>
<span class="nv">DIR</span><span class="o">=</span><span class="nv">$REP_SOURCE</span><span class="p">;</span>
<span class="nb">echo</span> <span class="s2">&quot;${SQL}&quot;</span> &gt;&gt; /tmp/insert.sql<span class="p">;</span>
<span class="nb">echo</span> <span class="s2">&quot;Analysing&quot;</span><span class="p">;</span>
treeanalyse <span class="nv">$DIR</span><span class="p">;</span>

<span class="nb">echo</span> <span class="s2">&quot;STARTING SQL INSERTION:&quot;</span>
<span class="c">#PGCOMMAND=&quot;psql -d $BASE -h $HOST -U $USER --single-transaction -f &quot;</span>
<span class="nv">PGCOMMAND</span><span class="o">=</span><span class="s2">&quot;psql -d $BASE -h $HOST -U $USER -f &quot;</span>
<span class="nv">$PGCOMMAND</span> /tmp/insert.sql<span class="p">;</span>
<span class="nb">echo</span> <span class="s2">&quot;Done&quot;</span></code></pre></div>


<p>En exécutant ce script (n'oubliez pas le chmod u+x) on obtient un gros fichier <code>/tmp/insert.sql</code> (109 382 lignes chez moi)
qui est ensuite importé dans un grosse transaction postgreSQL si tout se passe bien.<br/>
Bon, il supporte encore assez mal les noms de dossiers avec ' ou des " dedans, mais même si la transaction echoue vous avez
votre /tmp/insert.sql dans lequel vous pouvez peut-être supprimer les dossiers et fichiers embétants.</p>

<h2>Tester les requêtes récursives</h2>

<p>Voyons ensuite la requête récursive, la <a href="http://www.postgresql.org/docs/8.4/static/queries-with.html">documentation postgreSQL</a>  nous donne un modèle:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">t</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="k">FROM</span> <span class="n">t</span> <span class="k">WHERE</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">100</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="k">sum</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">t</span><span class="p">;</span></code></pre></div>


<p>Qui sur notre table des fichiers va donner:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">rectable</span><span class="p">(</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">FILE_TYPE</span>
    <span class="k">FROM</span> <span class="n">FILE</span>
    <span class="k">WHERE</span> <span class="n">FILE_FULLNAME</span><span class="o">=</span><span class="s1">&#39;/usr/local&#39;</span>
  <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_TYPE</span>
    <span class="k">FROM</span> <span class="n">rectable</span> <span class="n">rec</span><span class="p">,</span><span class="n">FILE</span> <span class="n">orig</span>
    <span class="k">WHERE</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span><span class="o">=</span><span class="n">rec</span><span class="p">.</span><span class="n">FILE_ID</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">FILE_TYPE</span>
<span class="k">FROM</span> <span class="n">rectable</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">FILE_FULLNAME</span><span class="p">;</span></code></pre></div>


<p>Pour par exemple obtenir le sous arbre de <code>/usr/local</code>.</p>

<p>Remarquez la façon dont la table <code>FILE</code> se voit renommée <strong>3 fois</strong> pour la requête, <code>rectable</code> devient la requête récursive,
une "fausse table" sur laquelle on fait notre requête finale.<br/>
A l'intérieur nous avons une première partie qui initialise la récursion en sélectionnant une ligne de la table <code>FILE</code>,
et après le <code>UNION ALL</code> nous utilisons <code>rectable</code> qui contient au départ <strong>l'initialisation</strong> et plus tard les <strong>résultats</strong>
des récursions passées que nous joignons avec la table <code>FILE</code> renommée pour l'occasion <code>orig</code>, jointe sur la relation parent.<br/>
C'est différent de la syntaxe du <code>CONNECT BY</code> de oracle, mais je ne suis pas loin de penser que c'est plus élégant
(<strike>peut-être pas encore aussi puissant, pas de détection de cycle, de leaf ou de level
-- quoique en lisant bien la doc je dois pouvoir le faire</strike>).</p>

<p>Alors vous me direz que faire un <code>order by</code> sur le <code>FILE_FULLNAME</code> pour avoir la requêtre triée c'est un peu de la triche,
parce qu'on aurait pu alors tout aussi juste stocker le <code>FULLNAME</code> et se servir du tri sans la récursion.<br/>
C'est un peu vrai, mais là j'ai mis le <code>FILE_FULLNAME</code> pour faire <strong>joli</strong>, je ne suis pas du tout obligé de stocker cette information.
Donc voici la même mais ordonnée sur la relation parent:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">rectable</span><span class="p">(</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span>
    <span class="k">FROM</span> <span class="n">FILE</span>
    <span class="k">WHERE</span> <span class="n">FILE_FULLNAME</span><span class="o">=</span><span class="s1">&#39;/usr/local&#39;</span>
  <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span>
    <span class="k">FROM</span> <span class="n">rectable</span> <span class="n">rec</span><span class="p">,</span><span class="n">FILE</span> <span class="n">orig</span>
    <span class="k">WHERE</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span><span class="o">=</span><span class="n">rec</span><span class="p">.</span><span class="n">FILE_ID</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span>
<span class="k">FROM</span> <span class="n">rectable</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">FILE_PARENT</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">;</span></code></pre></div>


<p>Problème on perd notre tri d'arbre.<br/>
On a d'abord les répertoires et ensuite seulement les fichiers de ces répertoires.
Si on veut trier proprement sans avoir le <code>FILE_FULLNAME</code> il faut en fait le récréer dans la récursion:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">rectable</span><span class="p">(</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="n">rorder</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="o">||</span><span class="n">FILE_NAME</span> <span class="k">as</span> <span class="n">rorder</span>
    <span class="k">FROM</span> <span class="n">FILE</span>
    <span class="k">WHERE</span> <span class="n">FILE_FULLNAME</span><span class="o">=</span><span class="s1">&#39;/usr/local/nagios&#39;</span>
  <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="n">rec</span><span class="p">.</span><span class="n">rorder</span><span class="o">||</span><span class="s1">&#39;/&#39;</span><span class="o">||</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_NAME</span> <span class="k">as</span> <span class="n">rorder</span>
    <span class="k">FROM</span> <span class="n">rectable</span> <span class="n">rec</span><span class="p">,</span><span class="n">FILE</span> <span class="n">orig</span>
    <span class="k">WHERE</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span><span class="o">=</span><span class="n">rec</span><span class="p">.</span><span class="n">FILE_ID</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="n">rorder</span>
<span class="k">FROM</span> <span class="n">rectable</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rorder</span><span class="p">;</span>
 <span class="n">file_id</span> <span class="o">|</span>              <span class="n">file_name</span>               <span class="o">|</span> <span class="n">file_type</span> <span class="o">|</span> <span class="n">file_parent</span> <span class="o">|</span>                        <span class="n">rorder</span>                       
<span class="c1">---------+--------------------------------------+-----------+-------------+------------------------------------------------------</span>
   <span class="mi">80764</span> <span class="o">|</span> <span class="n">nagios</span>                               <span class="o">|</span> <span class="n">directory</span> <span class="o">|</span>       <span class="mi">80760</span> <span class="o">|</span> <span class="o">/</span><span class="n">nagios</span>
   <span class="mi">80782</span> <span class="o">|</span> <span class="n">bin</span>                                  <span class="o">|</span> <span class="n">directory</span> <span class="o">|</span>       <span class="mi">80764</span> <span class="o">|</span> <span class="o">/</span><span class="n">nagios</span><span class="o">/</span><span class="n">bin</span>
   <span class="mi">80785</span> <span class="o">|</span> <span class="n">nagios</span>                               <span class="o">|</span> <span class="n">file</span>      <span class="o">|</span>       <span class="mi">80782</span> <span class="o">|</span> <span class="o">/</span><span class="n">nagios</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">nagios</span>
   <span class="mi">80784</span> <span class="o">|</span> <span class="n">nagiostats</span>                           <span class="o">|</span> <span class="n">file</span>      <span class="o">|</span>       <span class="mi">80782</span> <span class="o">|</span> <span class="o">/</span><span class="n">nagios</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">nagiostats</span>
   <span class="mi">80786</span> <span class="o">|</span> <span class="n">ndo2db</span>                               <span class="o">|</span> <span class="n">file</span>      <span class="o">|</span>       <span class="mi">80782</span> <span class="o">|</span> <span class="o">/</span><span class="n">nagios</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ndo2db</span>
   <span class="mi">80783</span> <span class="o">|</span> <span class="n">ndomod</span><span class="p">.</span><span class="n">o</span>                             <span class="o">|</span> <span class="n">file</span>      <span class="o">|</span>       <span class="mi">80782</span> <span class="o">|</span> <span class="o">/</span><span class="n">nagios</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ndomod</span><span class="p">.</span><span class="n">o</span>
   <span class="mi">80765</span> <span class="o">|</span> <span class="n">etc</span>                                  <span class="o">|</span> <span class="n">directory</span> <span class="o">|</span>       <span class="mi">80764</span> <span class="o">|</span> <span class="o">/</span><span class="n">nagios</span><span class="o">/</span><span class="n">etc</span>
   <span class="mi">80767</span> <span class="o">|</span> <span class="n">cgi</span><span class="p">.</span><span class="n">cfg</span>                              <span class="o">|</span> <span class="n">file</span>      <span class="o">|</span>       <span class="mi">80765</span> <span class="o">|</span> <span class="o">/</span><span class="n">nagios</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cgi</span><span class="p">.</span><span class="n">cfg</span>
   <span class="mi">80770</span> <span class="o">|</span> <span class="n">htpasswd</span><span class="p">.</span><span class="n">users</span>                       <span class="o">|</span> <span class="n">file</span>      <span class="o">|</span>       <span class="mi">80765</span> <span class="o">|</span> <span class="o">/</span><span class="n">nagios</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">htpasswd</span><span class="p">.</span><span class="n">users</span>
   <span class="mi">80766</span> <span class="o">|</span> <span class="n">nagios</span><span class="p">.</span><span class="n">cfg</span>                           <span class="o">|</span> <span class="n">file</span>      <span class="o">|</span>       <span class="mi">80765</span> <span class="o">|</span> <span class="o">/</span><span class="n">nagios</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nagios</span><span class="p">.</span><span class="n">cfg</span>
   <span class="mi">80769</span> <span class="o">|</span> <span class="n">ndo2db</span><span class="p">.</span><span class="n">cfg</span>                           <span class="o">|</span> <span class="n">file</span>      <span class="o">|</span>       <span class="mi">80765</span> <span class="o">|</span> <span class="o">/</span><span class="n">nagios</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ndo2db</span><span class="p">.</span><span class="n">cfg</span></code></pre></div>


<p>Et là où ce type de requête devient <strong>magique</strong>, je vais aussi pouvoir filtrer pour avoir uniquement les directory,
par exemple,
puis filtrer les résultats pour ne garder que les sous-sous répertoires qui commencent par un <code>"."</code>:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">rectable</span><span class="p">(</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span>
    <span class="k">FROM</span> <span class="n">FILE</span>
    <span class="k">WHERE</span> <span class="n">FILE_FULLNAME</span><span class="o">=</span><span class="s1">&#39;/usr/local&#39;</span>
  <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span>
    <span class="k">FROM</span> <span class="n">rectable</span> <span class="n">rec</span><span class="p">,</span><span class="n">FILE</span> <span class="n">orig</span>
    <span class="k">WHERE</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span><span class="o">=</span><span class="n">rec</span><span class="p">.</span><span class="n">FILE_ID</span>
    <span class="k">AND</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_TYPE</span><span class="o">=</span><span class="s1">&#39;directory&#39;</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span>
<span class="k">FROM</span> <span class="n">rectable</span>
<span class="k">WHERE</span> <span class="n">rectable</span><span class="p">.</span><span class="n">FILE_NAME</span> <span class="k">LIKE</span> <span class="s1">&#39;.%&#39;</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">FILE_FULLNAME</span><span class="p">;</span>
<span class="n">file_id</span> <span class="o">|</span> <span class="n">file_name</span> <span class="o">|</span>                      <span class="n">file_fullname</span>                      <span class="o">|</span> <span class="n">file_type</span> <span class="o">|</span> <span class="n">file_parent</span>
<span class="c1">---------+-----------+---------------------------------------------------------+-----------+-------------</span>
   <span class="mi">31058</span> <span class="o">|</span> <span class="p">.</span><span class="n">deps</span>     <span class="o">|</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nagios</span><span class="o">-</span><span class="n">plugins</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">14</span><span class="o">/</span><span class="n">plugins</span><span class="o">-</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">deps</span> <span class="o">|</span> <span class="n">directory</span> <span class="o">|</span>       <span class="mi">31047</span>
   <span class="mi">31059</span> <span class="o">|</span> <span class="p">.</span><span class="n">libs</span>     <span class="o">|</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nagios</span><span class="o">-</span><span class="n">plugins</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">14</span><span class="o">/</span><span class="n">plugins</span><span class="o">-</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">libs</span> <span class="o">|</span> <span class="n">directory</span> <span class="o">|</span>       <span class="mi">31047</span>
   <span class="mi">31112</span> <span class="o">|</span> <span class="p">.</span><span class="n">deps</span>     <span class="o">|</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nagios</span><span class="o">-</span><span class="n">plugins</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">14</span><span class="o">/</span><span class="n">tap</span><span class="o">/</span><span class="p">.</span><span class="n">deps</span>          <span class="o">|</span> <span class="n">directory</span> <span class="o">|</span>       <span class="mi">31105</span>
   <span class="mi">31502</span> <span class="o">|</span> <span class="p">.</span><span class="n">deps</span>     <span class="o">|</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nagios</span><span class="o">-</span><span class="n">plugins</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">14</span><span class="o">/</span><span class="n">gl</span><span class="o">/</span><span class="p">.</span><span class="n">deps</span>           <span class="o">|</span> <span class="n">directory</span> <span class="o">|</span>       <span class="mi">31243</span>
   <span class="mi">31627</span> <span class="o">|</span> <span class="p">.</span><span class="n">deps</span>     <span class="o">|</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nagios</span><span class="o">-</span><span class="n">plugins</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">14</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="p">.</span><span class="n">deps</span>          <span class="o">|</span> <span class="n">directory</span> <span class="o">|</span>       <span class="mi">31565</span>
   <span class="mi">31616</span> <span class="o">|</span> <span class="p">.</span><span class="n">deps</span>     <span class="o">|</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nagios</span><span class="o">-</span><span class="n">plugins</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">14</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="p">.</span><span class="n">deps</span>    <span class="o">|</span> <span class="n">directory</span> <span class="o">|</span>       <span class="mi">31586</span>
   <span class="mi">31766</span> <span class="o">|</span> <span class="p">.</span><span class="n">deps</span>     <span class="o">|</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nagios</span><span class="o">-</span><span class="n">plugins</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">14</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="p">.</span><span class="n">deps</span>      <span class="o">|</span> <span class="n">directory</span> <span class="o">|</span>       <span class="mi">31645</span>
   <span class="mi">31812</span> <span class="o">|</span> <span class="p">.</span><span class="n">libs</span>     <span class="o">|</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nagios</span><span class="o">-</span><span class="n">plugins</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">14</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="p">.</span><span class="n">libs</span>      <span class="o">|</span> <span class="n">directory</span> <span class="o">|</span>       <span class="mi">31645</span>
<span class="p">(</span><span class="mi">8</span> <span class="n">lignes</span><span class="p">)</span></code></pre></div>


<p>Si vous voulez garder les fonctionnalités avancées du <code>CONNECT BY</code> comme les détection de <strong>levels</strong> et de <strong>cycles</strong>
il y a (en dehors de la méthode expliquée ci-dessous) la solution des <strong>triggers</strong> à l'insertion, que je rédigerai dès que j'en aurais le temps...<br/>
Mais déjà nous pouvons ajouter facilement le niveau de profondeur en nous basant sur le premier modèle:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">rectable</span><span class="p">(</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="k">level</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="mi">1</span> <span class="k">as</span> <span class="k">level</span>
    <span class="k">FROM</span> <span class="n">FILE</span>
    <span class="k">WHERE</span> <span class="n">FILE_FULLNAME</span><span class="o">=</span><span class="s1">&#39;/usr/local/nagios&#39;</span>
  <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="n">rec</span><span class="p">.</span><span class="k">level</span><span class="o">+</span><span class="mi">1</span> <span class="k">as</span> <span class="k">level</span>
    <span class="k">FROM</span> <span class="n">rectable</span> <span class="n">rec</span><span class="p">,</span><span class="n">FILE</span> <span class="n">orig</span>
    <span class="k">WHERE</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span><span class="o">=</span><span class="n">rec</span><span class="p">.</span><span class="n">FILE_ID</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">FILE_FULLNAME</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="k">level</span>
<span class="k">FROM</span> <span class="n">rectable</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">FILE_FULLNAME</span><span class="p">;</span></code></pre></div>


<h2>Essayons de casser un peu tout ça.</h2>

<p>Nous allons tester la <strong>détection de cycle</strong> proposée dans la documentation.</p>

<pre>
  80764 | nagios   | directory | 80760 | /usr/local/nagios
  80782 | bin      | directory | 80764 | /usr/local/nagios/bin
  80772 | objects  | directory | 80765 | /usr/local/nagios/etc/objects
</pre>


<p>Créeons un <strong>bug</strong>, On va chercher à partir de <code>/usr/local/nagios-80764</code> et donner un répertoire parent (<code>/usr/local-80760</code>)
comme fils d'un des sous répertoires (<code>/usr/local/nagios/etc/objects-80765</code>)</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">UPDATE</span> <span class="n">FILE</span> <span class="k">SET</span> <span class="n">FILE_PARENT</span><span class="o">=</span><span class="mi">80765</span> <span class="k">WHERE</span> <span class="n">FILE_ID</span><span class="o">=</span><span class="mi">80760</span><span class="p">;</span></code></pre></div>


<p>Utilisons le chemin recomposé et non le <code>FILE_FULLNAME</code>:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">rectable</span><span class="p">(</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">rorder</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="k">level</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="o">||</span><span class="n">FILE_NAME</span> <span class="k">as</span> <span class="n">rorder</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="mi">1</span> <span class="k">as</span> <span class="k">level</span>
    <span class="k">FROM</span> <span class="n">FILE</span>
    <span class="k">WHERE</span> <span class="n">FILE_FULLNAME</span><span class="o">=</span><span class="s1">&#39;/usr/local/nagios&#39;</span>
  <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">rec</span><span class="p">.</span><span class="n">rorder</span><span class="o">||</span><span class="s1">&#39;/&#39;</span> <span class="o">||</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_NAME</span> <span class="k">as</span> <span class="n">rorder</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="n">rec</span><span class="p">.</span><span class="k">level</span><span class="o">+</span><span class="mi">1</span> <span class="k">as</span> <span class="k">level</span>
    <span class="k">FROM</span> <span class="n">rectable</span> <span class="n">rec</span><span class="p">,</span><span class="n">FILE</span> <span class="n">orig</span>
    <span class="k">WHERE</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span><span class="o">=</span><span class="n">rec</span><span class="p">.</span><span class="n">FILE_ID</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">rorder</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="k">level</span>
<span class="k">FROM</span> <span class="n">rectable</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rorder</span><span class="p">;</span></code></pre></div>


<p>==> oups ça ne réponds plus (boucle infinie) faire un CTRL-C<br/>
On va donc ajouter la détection de cycle, notre chemin recomposé va se doubler d'un <strong>tableau des identifiants parcourus</strong>
et nous ferons une <strong>recherche</strong> dans cet <code>array</code> pour détecter le cycle:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">rectable</span><span class="p">(</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">rorder</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="k">level</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="k">cycle</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="o">||</span><span class="n">FILE_NAME</span> <span class="k">as</span> <span class="n">rorder</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="mi">1</span> <span class="k">as</span> <span class="k">level</span><span class="p">,</span><span class="nb">ARRAY</span><span class="p">[</span><span class="n">FILE_ID</span><span class="p">],</span><span class="k">false</span>
    <span class="k">FROM</span> <span class="n">FILE</span>
    <span class="k">WHERE</span> <span class="n">FILE_FULLNAME</span><span class="o">=</span><span class="s1">&#39;/usr/local/nagios&#39;</span>
  <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">rec</span><span class="p">.</span><span class="n">rorder</span><span class="o">||</span><span class="s1">&#39;/&#39;</span> <span class="o">||</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_NAME</span> <span class="k">as</span> <span class="n">rorder</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">.</span><span class="k">level</span><span class="o">+</span><span class="mi">1</span> <span class="k">as</span> <span class="k">level</span><span class="p">,</span><span class="n">rec</span><span class="p">.</span><span class="n">path</span><span class="o">||</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_ID</span><span class="p">,</span><span class="n">orig</span><span class="p">.</span><span class="n">FILE_ID</span><span class="o">=</span><span class="k">ANY</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">FROM</span> <span class="n">rectable</span> <span class="n">rec</span><span class="p">,</span><span class="n">FILE</span> <span class="n">orig</span>
    <span class="k">WHERE</span> <span class="n">orig</span><span class="p">.</span><span class="n">FILE_PARENT</span><span class="o">=</span><span class="n">rec</span><span class="p">.</span><span class="n">FILE_ID</span>
    <span class="k">AND</span> <span class="k">NOT</span> <span class="k">cycle</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">FILE_ID</span><span class="p">,</span><span class="n">FILE_NAME</span><span class="p">,</span><span class="n">rorder</span><span class="p">,</span><span class="n">FILE_TYPE</span><span class="p">,</span><span class="n">FILE_PARENT</span><span class="p">,</span><span class="k">level</span><span class="p">,</span><span class="k">cycle</span>
<span class="k">FROM</span> <span class="n">rectable</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rorder</span><span class="p">;</span></code></pre></div>


<p>Et ça fonctionne, on a beaucoup trop de résultats (une partie de <code>/usr/local</code> branché dans <code>/usr/local/nagios/etc/configObjects</code>) -- à cause du bug introduit --
mais au moins la requête réponds et ne fais pas une boucle infinie.
La détection de cycle se base ici sur l'array des Identifiants parcourus, des exemples plus complexes sont données dans la documentation
posgreSQL citée plus haut. <strong>Attention</strong> à ne pas oublier le <code>AND NOT cycle</code> dans la sous-requête.</p>


          </div>
         </div>
        </div>
        <div class="tag">Tags:&nbsp;<i class="glyphicon glyphicon-tag"></i><a href="/tag/Bash/">Bash</a>, <i class="glyphicon glyphicon-tag"></i><a href="/tag/PostgreSQL/">PostgreSQL</a></div>
</article>
<hr/>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: * * */
    var disqus_shortname = "regilero";
    var disqus_identifier = 'd1451e02-926f-432e-8657-ebc323b8ab22';
    var disqus_title = "Requêtes récursives avec PostgreSQL 8.4 (WITH RECURSIVE)";
    var disqus_url = 'http://regilero.github.io/francais/postgresql/2010/10/14/requetes_recursives_avec_postgresql_8_4/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    

      </div>
      <div class="col-md-4" id="sideBar">

            <div id="sideBarContent"> 
              
              <div class="sideBarListBox">
                <div class="page-header">
                <h3>Related posts</h3>
                </div>
                <div class="list-group" role="navigation">
                  
                     <a class="list-group-item" href="/english/postgresql/2017/06/26/postgresql_advanced_generate_series/">
                     <h4>PostgreSQL, advanced use of generate_series for data generation</h4>
                     <p>filling thousands of random realistic data rows.</p>
                     </a>
                  
                     <a class="list-group-item" href="/english/postgresql/2008/10/30/6_nice_things_not_known_enough_about_postgresql/">
                     <h4>6 nice things not know enough about PostgreSQL</h4>
                     <p>Let's explore FillFactor, Returning inserts, TOAST, table inheritance, table partitionning and Notify/listen features.</p>
                     </a>
                  
                </div>
              </div>
              
      
              <div class="sideBarListBox">
                <div class="page-header">
                <h3>Latest posts</h3>
                </div>
                <div class="list-group" role="navigation">
                  
                     <a class="list-group-item" href="/english/security/2019/10/17/security_apache_traffic_server_http_smuggling/">
                     Security: HTTP Smuggling, Apache Traffic Server
                     </a>
                  
                     <a class="list-group-item" href="/english/security/2019/04/24/security_jetty_http_smuggling/">
                     Security: HTTP Smuggling, Jetty
                     </a>
                  
                     <a class="list-group-item" href="/english/security/2018/07/03/security_pound_http_smuggling/">
                     Security: HTTP Smuggling, Apsis Pound load balancer
                     </a>
                  
                     <a class="list-group-item" href="/english/postgresql/2017/06/26/postgresql_advanced_generate_series/">
                     PostgreSQL, advanced use of generate_series for data generation
                     </a>
                  
                     <a class="list-group-item" href="/english/security/2016/12/19/security_dompdf_rce/">
                     Web Security, Dompdf security issues details
                     </a>
                  
                </div>
              </div>
            
              <div class="sideBarListBox">
                <div class="page-header">
                <h3>Tags</h3>
                </div>

                <div class="tagcloud">
                <a style='font-size: 21px' class='taglink' href='/tag/Proxy/'>Proxy</a>
<a style='font-size: 18px' class='taglink' href='/tag/Web/'>Web</a>
<a style='font-size: 30px' class='taglink' href='/tag/Drupal/'>Drupal</a>
<a style='font-size: 18px' class='taglink' href='/tag/APC/'>APC</a>
<a style='font-size: 21px' class='taglink' href='/tag/mod_rewrite/'>mod_rewrite</a>
<a style='font-size: 12px' class='taglink' href='/tag/HAProxy/'>HAProxy</a>
<a style='font-size: 18px' class='taglink' href='/tag/Plone/'>Plone</a>
<a style='font-size: 12px' class='taglink' href='/tag/Cache/'>Cache</a>
<a style='font-size: 21px' class='taglink' href='/tag/Nginx/'>Nginx</a>
<a style='font-size: 12px' class='taglink' href='/tag/HTML/'>HTML</a>
<a style='font-size: 23px' class='taglink' href='/tag/Smuggling/'>Smuggling</a>
<a style='font-size: 12px' class='taglink' href='/tag/Mongodb/'>Mongodb</a>
<a style='font-size: 12px' class='taglink' href='/tag/Ajax/'>Ajax</a>
<a style='font-size: 12px' class='taglink' href='/tag/js/'>js</a>
<a style='font-size: 12px' class='taglink' href='/tag/Varnish/'>Varnish</a>
<a style='font-size: 32px' class='taglink' href='/tag/Security/'>Security</a>
<a style='font-size: 12px' class='taglink' href='/tag/ZendFramework/'>ZendFramework</a>
<a style='font-size: 12px' class='taglink' href='/tag/Dojo/'>Dojo</a>
<a style='font-size: 12px' class='taglink' href='/tag/Bug/'>Bug</a>
<a style='font-size: 12px' class='taglink' href='/tag/Jetty/'>Jetty</a>
<a style='font-size: 26px' class='taglink' href='/tag/Performance/'>Performance</a>
<a style='font-size: 23px' class='taglink' href='/tag/SaltStack/'>SaltStack</a>
<a style='font-size: 23px' class='taglink' href='/tag/CVE/'>CVE</a>
<a style='font-size: 31px' class='taglink' href='/tag/HTTP/'>HTTP</a>
<a style='font-size: 12px' class='taglink' href='/tag/Managed/'>Managed</a>
<a style='font-size: 18px' class='taglink' href='/tag/Pound/'>Pound</a>
<a style='font-size: 21px' class='taglink' href='/tag/PostgreSQL/'>PostgreSQL</a>
<a style='font-size: 12px' class='taglink' href='/tag/HTML5/'>HTML5</a>
<a style='font-size: 18px' class='taglink' href='/tag/BlockReplace/'>BlockReplace</a>
<a style='font-size: 18px' class='taglink' href='/tag/RewriteMap/'>RewriteMap</a>
<a style='font-size: 30px' class='taglink' href='/tag/PHP/'>PHP</a>
<a style='font-size: 12px' class='taglink' href='/tag/Statistics/'>Statistics</a>
<a style='font-size: 31px' class='taglink' href='/tag/Apache/'>Apache</a>
<a style='font-size: 18px' class='taglink' href='/tag/PHP-fpm/'>PHP-fpm</a>
<a style='font-size: 12px' class='taglink' href='/tag/Monitoring/'>Monitoring</a>
<a style='font-size: 12px' class='taglink' href='/tag/Linux/'>Linux</a>
<a style='font-size: 18px' class='taglink' href='/tag/Injection/'>Injection</a>
<a style='font-size: 12px' class='taglink' href='/tag/Accumulated/'>Accumulated</a>
<a style='font-size: 12px' class='taglink' href='/tag/Js/'>Js</a>
<a style='font-size: 18px' class='taglink' href='/tag/jinja/'>jinja</a>
<a style='font-size: 12px' class='taglink' href='/tag/Bash/'>Bash</a>

                </div>
              </div>
          </div> <!-- end sideBarContent -->
            
            <div class="sideBarMore">
              <div class="page-header">
              <h3>About</h3>
              </div>
                <a href="https://twitter.com/regilero" target="_blank"><img src="/theme/img/twitter_thumb.png" width="48" height="48" alt="Twitter regilero" title="Twitter regilero"></a>
                <a href="https://github.com/regilero" target="_blank"><img src="/theme/img/github_thumb.png" width="48" height="48" alt="Github regilero" title="Github regilero"></a>
                <a href="http://www.flickr.com/photos/regilero/" target="_blank"><img src="/theme/img/flickr_thumb.png" width="48" height="48" alt="Flickr photos" title="Flickr photos"></a>
                <a href="http://stackoverflow.com/users/550618/regilero" target="_blank"><img src="http://stackoverflow.com/users/flair/550618.png" width="208" height="58" alt="profile for regilero at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for regilero at Stack Overflow, Q&amp;A for professional and enthusiast programmers"></a>
                <a href="https://stackexchange.com/users/264377/regilero"  target="_blank"><img src="http://stackexchange.com/users/flair/264377.png?theme=clean" width="208" height="58" alt="profile for regilero on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for regilero on Stack Exchange, a network of free, community-driven Q&amp;A sites" /></a>
            </div>
            <div class="sideBarItem">
              <h3>Some Friends</h3>
                <ul>
                  <li><a class="effect" target="_blank" href="http://makina-corpus.com/blog/metier/actu-metier">Blogs Makina Corpus<div class="cover-right"><img src="/theme/img/makinaorg.png" height="30" width="30"><img src="/theme/img/makinaorg_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://www.makina-corpus.com">Makina Corpus<div class="cover-right"><img src="/theme/img/makinacom.png" height="30" width="30"><img src="/theme/img/makinacom_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://blog.processus.org/">Pounard, processus.org<div class="cover-right"><img src="/theme/img/pounard.png" height="30" width="30"><img src="/theme/img/pounard_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://toutpt.github.io/" >Toupt<div class="cover-right"><img src="/theme/img/toupt.png" height="30" width="30"><img src="/theme/img/toupt_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://francoisgaudin.com/">François Gaudin<div class="cover-right"><img src="/theme/img/gaudin.png" height="30" width="30"><img src="/theme/img/gaudin_banner.png" height="30" width="117"></div></a></li>
                  <li><a class="effect" target="_blank" href="http://fle.github.io/">Florent Lebreton<div class="cover-right"><img src="/theme/img/fle.png" height="30" width="30"><img src="/theme/img/fle_banner.png" height="30" width="117"></div></a></li>
                </ul>
                <div class="clear"></div>
            </div>
         </div> <!-- end sidebar -->
        
       </div><!-- end row -->
       <div class="row">
         <div class="col-md-12" id="footer">
           <div class="panel panel-default">
             <div class=panel-footer">
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/fr/"><img alt="Licence Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/fr/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">regilero's blog</span> est mis à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/fr/">licence Creative Commons Attribution -  Partage dans les Mêmes Conditions 3.0 France</a>.<br />Fondé(e) sur une œuvre à <a xmlns:dct="http://purl.org/dc/terms/" href="http://regilero.github.io" rel="dct:source">http://regilero.github.io</a>.
              </div>
            </div>
         </div>
       </div><!-- end row -->
  </div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!--    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script> -->
    <script src="/theme/js/toc.min.js" ></script>
    <script src="/theme/js/effects.js" ></script>
   <script src="/theme/js/jquery.parallax.min.js"></script>
    <script src="/theme/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-40859893-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
    </body>
</html>
